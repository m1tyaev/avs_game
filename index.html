<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviation Parts Runner ‚Äî Aviation Service</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0b14;
            --bg-secondary: #12131f;
            --bg-card: #1a1c2e;
            --bg-card-hover: #222438;
            --accent-blue: #4a6cf7;
            --accent-blue-light: #6b8cff;
            --accent-gold: #f0b90b;
            --accent-red: #e74c3c;
            --accent-green: #2ecc71;
            --accent-cyan: #00d4ff;
            --accent-purple: #9b59b6;
            --accent-orange: #e67e22;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --text-tertiary: #5a6380;
            --border-color: rgba(255, 255, 255, 0.08);
            --safe-top: 100px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            font-family: 'Inter', -apple-system, sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
        }

        .game-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-primary);
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }

        /* HUD */
        .hud {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            padding: calc(var(--safe-top) + 10px) 16px 16px;
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .hud.visible { opacity: 1; }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .hud-money {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 8px 14px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .hud-rfq {
            flex: 1;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 200px;
        }

        .rfq-title {
            font-size: 9px;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .rfq-items {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .rfq-item {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }
        .rfq-item.collected {
            background: var(--accent-green);
            color: #000;
        }

        .hud-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
        }

        .hud-stat {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Screens */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            overflow-y: auto;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* Main Menu */
        .main-menu {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }

        .menu-content {
            padding: calc(var(--safe-top) + 10px) 20px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100%;
        }

        .logo-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--accent-blue), #3451d1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .logo-title {
            font-size: 24px;
            font-weight: 900;
            color: var(--text-primary);
            text-align: center;
            line-height: 1.1;
        }

        .logo-subtitle {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 4px;
        }

        .wallet-card {
            width: 100%;
            background: linear-gradient(135deg, #1a1c2e 0%, #222438 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
        }

        .wallet-balance {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .wallet-amount {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .wallet-label {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .wallet-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .wallet-stat {
            flex: 1;
            text-align: center;
        }

        .wallet-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .wallet-stat-label {
            font-size: 9px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .menu-buttons {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #3451d1 100%);
            box-shadow: 0 8px 30px rgba(74, 108, 247, 0.35);
        }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        .btn-aog {
            background: linear-gradient(135deg, var(--accent-red) 0%, #c0392b 100%);
            animation: aogPulse 2s ease-in-out infinite;
        }

        @keyframes aogPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(231, 76, 60, 0.2); }
        }

        .menu-footer {
            margin-top: auto;
            padding-top: 20px;
            text-align: center;
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .menu-footer a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        /* RFQ Screen */
        .rfq-screen {
            background: var(--bg-primary);
        }

        .rfq-content {
            padding: calc(var(--safe-top) + 10px) 20px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rfq-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .rfq-header h2 {
            font-size: 14px;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
        }

        .rfq-header h1 {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .rfq-client {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .rfq-order {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .rfq-order-title {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .rfq-parts {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rfq-part {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .rfq-part-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .rfq-part-info {
            flex: 1;
        }

        .rfq-part-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rfq-part-rarity {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .rfq-part-qty {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .rfq-reward {
            width: 100%;
            background: linear-gradient(135deg, rgba(240,185,11,0.1) 0%, rgba(240,185,11,0.05) 100%);
            border: 1px solid rgba(240,185,11,0.2);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            margin-bottom: 20px;
        }

        .rfq-reward-label {
            font-size: 10px;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .rfq-reward-amount {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-gold);
            margin-top: 4px;
        }

        /* Game Over */
        .gameover-screen {
            background: linear-gradient(180deg, rgba(10,11,20,0.97), rgba(18,19,31,0.98));
            justify-content: center;
            align-items: center;
            padding: 30px;
        }

        .gameover-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .gameover-money {
            font-size: 48px;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .gameover-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .gameover-rfq {
            margin: 20px 0;
            padding: 16px 24px;
            border-radius: 12px;
            text-align: center;
        }

        .gameover-rfq.success {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .gameover-rfq.failed {
            background: rgba(231, 76, 60, 0.15);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .gameover-rfq-text {
            font-size: 14px;
            font-weight: 600;
        }

        .gameover-rfq.success .gameover-rfq-text { color: var(--accent-green); }
        .gameover-rfq.failed .gameover-rfq-text { color: var(--accent-red); }

        .gameover-stats {
            display: flex;
            gap: 24px;
            margin: 16px 0 24px;
        }

        .gameover-stat {
            text-align: center;
        }

        .gameover-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .gameover-stat-label {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .gameover-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 260px;
        }

        /* Parts collected popup */
        .part-popup {
            position: absolute;
            pointer-events: none;
            font-size: 14px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: partPopup 1s ease-out forwards;
            z-index: 15;
        }

        @keyframes partPopup {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }
        
        @keyframes screenFlash {
            0% { opacity: 0.4; }
            100% { opacity: 0; }
        }
        
        @keyframes rfqComplete {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        /* Rarity colors */
        .rarity-common { background: #6b7280; }
        .rarity-uncommon { background: var(--accent-green); }
        .rarity-rare { background: var(--accent-blue); }
        .rarity-epic { background: var(--accent-purple); }
        .rarity-legendary { background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange)); }

        .text-common { color: #9ca3af; }
        .text-uncommon { color: var(--accent-green); }
        .text-rare { color: var(--accent-blue-light); }
        .text-epic { color: var(--accent-purple); }
        .text-legendary { color: var(--accent-gold); }

        /* Legendary alert */
        .legendary-alert {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 20px 30px;
            text-align: center;
            z-index: 25;
            animation: legendaryPulse 0.5s ease-out;
            display: none;
        }

        .legendary-alert.show { display: block; }

        @keyframes legendaryPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .legendary-alert-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .legendary-alert-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- HUD -->
        <div class="hud" id="hud">
            <div class="hud-top">
                <div class="hud-money">üí∞ $<span id="hudMoney">0</span></div>
                <div class="hud-rfq">
                    <div class="rfq-title">üìã RFQ –ó–∞–∫–∞–∑</div>
                    <div class="rfq-items" id="hudRfq"></div>
                </div>
                <div class="hud-stats">
                    <div class="hud-stat" id="hudParts">üì¶ 0</div>
                    <div class="hud-stat" id="hudSpeed">‚ö° x1.0</div>
                </div>
            </div>
        </div>

        <!-- Legendary Alert -->
        <div class="legendary-alert" id="legendaryAlert">
            <div class="legendary-alert-icon">‚≠ê</div>
            <div class="legendary-alert-text">Legendary Part!</div>
        </div>

        <!-- Main Menu -->
        <div class="screen main-menu active" id="mainMenu">
            <div class="menu-content">
                <div class="logo-badge">‚úàÔ∏è Aviation Game</div>
                <div class="logo-title">Aviation Parts<br>Runner</div>
                <div class="logo-subtitle">Aviation Service</div>

                <div class="wallet-card">
                    <div class="wallet-balance">
                        <span style="font-size: 24px;">üí∞</span>
                        <div>
                            <div class="wallet-amount">$<span id="totalMoney">0</span></div>
                            <div class="wallet-label">–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                        </div>
                    </div>
                    <div class="wallet-stats">
                        <div class="wallet-stat">
                            <div class="wallet-stat-value" id="totalRfq">0</div>
                            <div class="wallet-stat-label">RFQ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                        </div>
                        <div class="wallet-stat">
                            <div class="wallet-stat-value" id="totalParts">0</div>
                            <div class="wallet-stat-label">–î–µ—Ç–∞–ª–µ–π</div>
                        </div>
                        <div class="wallet-stat">
                            <div class="wallet-stat-value" id="totalGames">0</div>
                            <div class="wallet-stat-label">–ü–æ–ª—ë—Ç–æ–≤</div>
                        </div>
                    </div>
                </div>

                <div class="menu-buttons">
                    <button class="btn btn-primary" id="btnPlay">üöÄ –ù–∞—á–∞—Ç—å –ø–æ–ª—ë—Ç</button>
                    <button class="btn btn-secondary" id="btnLeaderboard">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
                </div>

                <div class="menu-footer">
                    <a href="https://jet-avia.ru" target="_blank">jet-avia.ru</a> ‚Ä¢ v1.0
                </div>
            </div>
        </div>

        <!-- RFQ Screen -->
        <div class="screen rfq-screen" id="rfqScreen">
            <div class="rfq-content">
                <div class="rfq-header">
                    <h2>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
                    <h1>RFQ #<span id="rfqNumber">001</span></h1>
                    <div class="rfq-client">–ö–ª–∏–µ–Ω—Ç: <span id="rfqClient">Airline Co.</span></div>
                </div>

                <div class="rfq-order">
                    <div class="rfq-order-title">–¢—Ä–µ–±—É–µ–º—ã–µ –¥–µ—Ç–∞–ª–∏</div>
                    <div class="rfq-parts" id="rfqParts"></div>
                </div>

                <div class="rfq-reward">
                    <div class="rfq-reward-label">–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
                    <div class="rfq-reward-amount">+$<span id="rfqReward">0</span></div>
                </div>

                <div class="menu-buttons">
                    <button class="btn btn-primary" id="btnStartRfq">‚úàÔ∏è –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>
                    <button class="btn btn-secondary" id="btnSkipRfq">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Game Over -->
        <div class="screen gameover-screen" id="gameoverScreen">
            <div class="gameover-title">–ü–æ–ª—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</div>
            <div class="gameover-money">$<span id="goMoney">0</span></div>
            <div class="gameover-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>

            <div class="gameover-rfq" id="goRfq">
                <div class="gameover-rfq-text" id="goRfqText"></div>
            </div>

            <div class="gameover-stats">
                <div class="gameover-stat">
                    <div class="gameover-stat-value" id="goParts">0</div>
                    <div class="gameover-stat-label">–î–µ—Ç–∞–ª–µ–π</div>
                </div>
                <div class="gameover-stat">
                    <div class="gameover-stat-value" id="goBest">$0</div>
                    <div class="gameover-stat-label">–†–µ–∫–æ—Ä–¥</div>
                </div>
            </div>

            <div class="gameover-buttons">
                <button class="btn btn-primary" id="btnRetry">üîÑ –ï—â—ë —Ä–∞–∑</button>
                <button class="btn btn-secondary" id="btnHome">üè† –í –º–µ–Ω—é</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG
        // ==========================================
        let W = 400;
        let H = 700;
        let safeAreaTop = 100;

        const PARTS_DATA = [
            // Common (60%)
            { name: 'O-Ring', icon: '‚≠ï', rarity: 'common', value: 10, chance: 0.20 },
            { name: 'Washer', icon: 'üîò', rarity: 'common', value: 20, chance: 0.20 },
            { name: 'Rivet', icon: 'üìç', rarity: 'common', value: 30, chance: 0.20 },
            // Uncommon (25%)
            { name: 'Valve', icon: 'üîß', rarity: 'uncommon', value: 200, chance: 0.10 },
            { name: 'Filter', icon: 'üßΩ', rarity: 'uncommon', value: 300, chance: 0.08 },
            { name: 'Bearing', icon: '‚öôÔ∏è', rarity: 'uncommon', value: 500, chance: 0.07 },
            // Rare (12%)
            { name: 'Fuel Pump', icon: '‚õΩ', rarity: 'rare', value: 2000, chance: 0.05 },
            { name: 'Actuator', icon: 'üîå', rarity: 'rare', value: 3000, chance: 0.04 },
            { name: 'Sensor', icon: 'üì°', rarity: 'rare', value: 5000, chance: 0.03 },
            // Epic (2.5%)
            { name: 'HMU', icon: 'üéõÔ∏è', rarity: 'epic', value: 20000, chance: 0.015 },
            { name: 'Starter', icon: '‚ö°', rarity: 'epic', value: 30000, chance: 0.01 },
            // Legendary (0.5%)
            { name: 'APU', icon: 'üîã', rarity: 'legendary', value: 100000, chance: 0.003 },
            { name: 'Engine Module', icon: 'üõ´', rarity: 'legendary', value: 200000, chance: 0.002 }
        ];

        const CLIENTS = ['Aeroflot', 'Emirates', 'Lufthansa', 'Air France', 'British Airways', 'Qatar Airways', 'S7 Airlines', 'Utair'];

        const CONFIG = {
            PLAYER: { X: 120, SIZE: 40, JUMP: -10, GRAVITY: 0.45, MAX_V: 12 },
            OBSTACLES: { WIDTH: 65, GAP: 220, SPEED: 3.5, SPAWN: 130, MIN_H: 100 },
            PARTS: { SIZE: 40, SPAWN_RATE: 60 },
            DIFFICULTY: { SPEED_INC: 0.0003, MAX_SPEED: 2.5 }
        };

        // ==========================================
        // STATE
        // ==========================================
        let gameState = 'menu';
        let money = 0, partsCollected = 0, frameCount = 0, speedMult = 1.0;

        let stats = JSON.parse(localStorage.getItem('avrStats')) || { money: 0, rfq: 0, parts: 0, games: 0, best: 0 };

        // Player –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ reset()
        let player = { x: 0, y: 0, v: 0, rot: 0 };
        let obstacles = [], parts = [], particles = [];

        let currentRfq = null;
        let rfqProgress = {};

        // ==========================================
        // CANVAS
        // ==========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            const rect = canvas.getBoundingClientRect();
            W = Math.max(rect.width || window.innerWidth || 0, 360);
            H = Math.max(rect.height || window.innerHeight || 0, 640);
            canvas.width = W;
            canvas.height = H;
        }
        
        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π resize
        resize();
        
        // –í—ã–∑—ã–≤–∞–µ–º resize –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        setTimeout(resize, 100);
        window.addEventListener('resize', resize);
        document.addEventListener('DOMContentLoaded', () => setTimeout(resize, 100));
        window.addEventListener('load', () => setTimeout(resize, 100));

        // ==========================================
        // TELEGRAM
        // ==========================================
        let tg = window.Telegram?.WebApp;
        let playerName = '–ü–∏–ª–æ—Ç';

        if (tg) {
            tg.ready();
            tg.expand();

            if (tg.safeAreaInset) safeAreaTop = Math.max(100, tg.safeAreaInset.top + 50);
            if (tg.contentSafeAreaInset) safeAreaTop = Math.max(safeAreaTop, tg.contentSafeAreaInset.top + 50);

            document.documentElement.style.setProperty('--safe-top', safeAreaTop + 'px');

            if (tg.initDataUnsafe?.user) {
                const u = tg.initDataUnsafe.user;
                playerName = ((u.first_name || '') + ' ' + (u.last_name || '')).trim() || '–ü–∏–ª–æ—Ç';
            }

            setTimeout(resize, 100);
        }

        // ==========================================
        // SOUND & HAPTIC
        // ==========================================
        function vibrate(type = 'light') {
            if (tg?.HapticFeedback) {
                if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
                else if (type === 'error') tg.HapticFeedback.notificationOccurred('error');
                else if (type === 'heavy') tg.HapticFeedback.impactOccurred('heavy');
                else tg.HapticFeedback.impactOccurred('light');
            }
        }

        // ==========================================
        // RFQ SYSTEM
        // ==========================================
        function generateRfq() {
            const numParts = Math.floor(Math.random() * 3) + 2; // 2-4 parts
            const rfqParts = [];
            const usedParts = new Set();

            for (let i = 0; i < numParts; i++) {
                let part;
                do {
                    // Bias towards common/uncommon for RFQ
                    const roll = Math.random();
                    if (roll < 0.5) part = PARTS_DATA[Math.floor(Math.random() * 3)]; // common
                    else if (roll < 0.8) part = PARTS_DATA[3 + Math.floor(Math.random() * 3)]; // uncommon
                    else if (roll < 0.95) part = PARTS_DATA[6 + Math.floor(Math.random() * 3)]; // rare
                    else part = PARTS_DATA[9 + Math.floor(Math.random() * 2)]; // epic
                } while (usedParts.has(part.name));

                usedParts.add(part.name);
                rfqParts.push({ ...part, qty: Math.floor(Math.random() * 2) + 1 });
            }

            const reward = rfqParts.reduce((sum, p) => sum + p.value * p.qty, 0) * 2;

            return {
                number: String(Math.floor(Math.random() * 900) + 100),
                client: CLIENTS[Math.floor(Math.random() * CLIENTS.length)],
                parts: rfqParts,
                reward
            };
        }

        function showRfqScreen() {
            currentRfq = generateRfq();
            rfqProgress = {};
            currentRfq.parts.forEach(p => rfqProgress[p.name] = 0);

            document.getElementById('rfqNumber').textContent = currentRfq.number;
            document.getElementById('rfqClient').textContent = currentRfq.client;
            document.getElementById('rfqReward').textContent = currentRfq.reward.toLocaleString();

            const partsHtml = currentRfq.parts.map(p => `
                <div class="rfq-part">
                    <div class="rfq-part-icon rarity-${p.rarity}">${p.icon}</div>
                    <div class="rfq-part-info">
                        <div class="rfq-part-name">${p.name}</div>
                        <div class="rfq-part-rarity text-${p.rarity}">${p.rarity.toUpperCase()}</div>
                    </div>
                    <div class="rfq-part-qty">√ó${p.qty}</div>
                </div>
            `).join('');

            document.getElementById('rfqParts').innerHTML = partsHtml;
            showScreen('rfqScreen');
        }

        function updateHudRfq() {
            if (!currentRfq) return;
            const html = currentRfq.parts.map(p => {
                const collected = rfqProgress[p.name] >= p.qty;
                return `<div class="rfq-item ${collected ? 'collected' : ''}">${p.icon}${rfqProgress[p.name]}/${p.qty}</div>`;
            }).join('');
            document.getElementById('hudRfq').innerHTML = html;
        }

        function checkRfqComplete() {
            if (!currentRfq) return false;
            return currentRfq.parts.every(p => rfqProgress[p.name] >= p.qty);
        }

        // ==========================================
        // GAME
        // ==========================================
        function reset() {
            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            if (W < 100 || H < 100) {
                resize();
            }
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∂—ë—Å—Ç–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã
            const safeH = Math.max(H, 640);
            const safeW = Math.max(W, 360);
            
            player.x = 120;
            player.y = safeH / 2;
            player.v = 0;
            player.rot = 0;
            
            obstacles = [];
            parts = [];
            particles = [];
            money = 0;
            partsCollected = 0;
            frameCount = 0;
            speedMult = 1.0;

            if (currentRfq) {
                rfqProgress = {};
                currentRfq.parts.forEach(p => rfqProgress[p.name] = 0);
            }

            document.getElementById('hudMoney').textContent = '0';
            document.getElementById('hudParts').textContent = 'üì¶ 0';
            document.getElementById('hudSpeed').textContent = '‚ö° x1.0';
            updateHudRfq();
        }

        function startGame() {
            // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
            const rect = canvas.getBoundingClientRect();
            W = rect.width || window.innerWidth || 400;
            H = rect.height || window.innerHeight || 700;
            
            // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            if (W < 300) W = 400;
            if (H < 400) H = 700;
            
            canvas.width = W;
            canvas.height = H;
            
            // –ñ–Å–°–¢–ö–û —Å—Ç–∞–≤–∏–º –∏–≥—Ä–æ–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä
            player.x = 120;
            player.y = Math.round(H / 2);
            player.v = 0;
            player.rot = 0;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
            obstacles = [];
            parts = [];
            particles = [];
            money = 0;
            partsCollected = 0;
            frameCount = 0;
            speedMult = 1.0;

            if (currentRfq) {
                rfqProgress = {};
                currentRfq.parts.forEach(p => rfqProgress[p.name] = 0);
            }

            document.getElementById('hudMoney').textContent = '0';
            document.getElementById('hudParts').textContent = 'üì¶ 0';
            document.getElementById('hudSpeed').textContent = '‚ö° x1.0';
            updateHudRfq();
            
            gameState = 'playing';
            showScreen(null);
            document.getElementById('hud').classList.add('visible');
        }

        function gameOver() {
            gameState = 'over';
            vibrate('error');

            const rfqComplete = checkRfqComplete();
            let totalEarned = money;

            if (rfqComplete && currentRfq) {
                totalEarned += currentRfq.reward;
                stats.rfq++;
            }

            stats.games++;
            stats.parts += partsCollected;
            stats.money += totalEarned;
            if (totalEarned > stats.best) stats.best = totalEarned;
            localStorage.setItem('avrStats', JSON.stringify(stats));

            document.getElementById('goMoney').textContent = totalEarned.toLocaleString();
            document.getElementById('goParts').textContent = partsCollected;
            document.getElementById('goBest').textContent = '$' + stats.best.toLocaleString();

            const rfqEl = document.getElementById('goRfq');
            const rfqText = document.getElementById('goRfqText');

            if (currentRfq) {
                if (rfqComplete) {
                    rfqEl.className = 'gameover-rfq success';
                    rfqText.textContent = `‚úÖ RFQ #${currentRfq.number} –≤—ã–ø–æ–ª–Ω–µ–Ω! +$${currentRfq.reward.toLocaleString()}`;
                } else {
                    rfqEl.className = 'gameover-rfq failed';
                    rfqText.textContent = `‚ùå RFQ #${currentRfq.number} –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω`;
                }
                rfqEl.style.display = 'block';
            } else {
                rfqEl.style.display = 'none';
            }

            document.getElementById('hud').classList.remove('visible');
            showScreen('gameoverScreen');

            // Explosion
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: player.x, y: player.y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    size: Math.random() * 6 + 2,
                    color: `hsl(${Math.random() * 60 + 10}, 100%, 50%)`,
                    life: 1
                });
            }
        }

        function jump() {
            if (gameState !== 'playing') return;
            player.v = CONFIG.PLAYER.JUMP;
            vibrate('light');
        }

        // ==========================================
        // SPAWN
        // ==========================================
        function spawnObstacle() {
            const minTop = safeAreaTop + CONFIG.OBSTACLES.MIN_H;
            const maxTop = H - CONFIG.OBSTACLES.GAP - CONFIG.OBSTACLES.MIN_H - 60;
            const top = Math.random() * (maxTop - minTop) + minTop;

            obstacles.push({
                x: W,
                top,
                bottom: top + CONFIG.OBSTACLES.GAP,
                passed: false
            });
        }

        function spawnPart() {
            // Determine rarity
            const roll = Math.random();
            let cumulative = 0;
            let partData = PARTS_DATA[0];

            for (const p of PARTS_DATA) {
                cumulative += p.chance;
                if (roll < cumulative) {
                    partData = p;
                    break;
                }
            }

            // Position in safe area
            const y = safeAreaTop + 80 + Math.random() * (H - safeAreaTop - 160);

            const part = {
                x: W + 50,
                y,
                ...partData,
                collected: false,
                glow: 0
            };

            // Show alert for legendary
            if (partData.rarity === 'legendary') {
                const alert = document.getElementById('legendaryAlert');
                alert.classList.add('show');
                vibrate('heavy');
                setTimeout(() => alert.classList.remove('show'), 1500);
            }

            parts.push(part);
        }

        // ==========================================
        // UPDATE
        // ==========================================
        function updatePlayer() {
            player.v += CONFIG.PLAYER.GRAVITY;
            player.v = Math.min(player.v, CONFIG.PLAYER.MAX_V);
            player.y += player.v;
            player.rot = Math.min(Math.max(player.v * 0.05, -0.4), 0.6);

            // –ì—Ä–∞–Ω–∏—Ü—ã
            if (player.y < safeAreaTop + 40) {
                player.y = safeAreaTop + 40;
                player.v = 0;
            }
            if (player.y > H - 80) {
                gameOver();
            }
        }

        function updateObstacles() {
            const sp = CONFIG.OBSTACLES.SPEED * speedMult;

            if (frameCount % Math.floor(CONFIG.OBSTACLES.SPAWN / speedMult) === 0) {
                spawnObstacle();
            }

            obstacles.forEach((o, i) => {
                o.x -= sp;

                // Collision (hitbox –ø–æ–¥–æ–≥–Ω–∞–Ω –ø–æ–¥ –Ω–æ–≤—ã–π —Å–∞–º–æ–ª—ë—Ç)
                if (!o.passed && player.x + 35 > o.x && player.x - 40 < o.x + CONFIG.OBSTACLES.WIDTH) {
                    if (player.y - 25 < o.top || player.y + 25 > o.bottom) {
                        gameOver();
                    }
                }

                if (!o.passed && o.x + CONFIG.OBSTACLES.WIDTH < player.x) {
                    o.passed = true;
                }

                if (o.x < -CONFIG.OBSTACLES.WIDTH) {
                    obstacles.splice(i, 1);
                }
            });
        }

        function updateParts() {
            const sp = CONFIG.OBSTACLES.SPEED * speedMult;

            if (frameCount % CONFIG.PARTS.SPAWN_RATE === 0) {
                spawnPart();
            }

            parts.forEach((p, i) => {
                p.x -= sp;
                p.glow = (Math.sin(frameCount * 0.1) + 1) / 2;

                if (!p.collected) {
                    const dx = player.x - p.x;
                    const dy = player.y - p.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    // –ü—Ä–∏—Ç—è–≥–∏–≤–∞–Ω–∏–µ –∫ —Å–∞–º–æ–ª—ë—Ç—É (–º–∞–≥–Ω–∏—Ç)
                    const magnetRange = 80;
                    if (dist < magnetRange && dist > 45) {
                        const force = (magnetRange - dist) / magnetRange * 0.15;
                        p.x += dx * force;
                        p.y += dy * force;
                    }

                    // –°–±–æ—Ä
                    if (dist < 45) {
                        p.collected = true;
                        money += p.value;
                        partsCollected++;

                        if (currentRfq && rfqProgress[p.name] !== undefined) {
                            rfqProgress[p.name]++;
                            updateHudRfq();
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ RFQ
                            if (checkRfqComplete()) {
                                showRfqCompletePopup();
                            }
                        }

                        document.getElementById('hudMoney').textContent = money.toLocaleString();
                        document.getElementById('hudParts').textContent = 'üì¶ ' + partsCollected;

                        // Popup
                        showPartPopup(p);

                        // Particles (–±–æ–ª—å—à–µ –¥–ª—è —Ä–µ–¥–∫–∏—Ö)
                        const particleCount = {
                            common: 6,
                            uncommon: 10,
                            rare: 15,
                            epic: 20,
                            legendary: 30
                        };
                        
                        for (let j = 0; j < particleCount[p.rarity]; j++) {
                            const angle = (j / particleCount[p.rarity]) * Math.PI * 2;
                            const speed = 3 + Math.random() * 4;
                            particles.push({
                                x: p.x, y: p.y,
                                vx: Math.cos(angle) * speed,
                                vy: Math.sin(angle) * speed,
                                size: 2 + Math.random() * 4,
                                color: getRarityColor(p.rarity),
                                life: 0.8 + Math.random() * 0.4
                            });
                        }

                        if (p.rarity === 'legendary') {
                            vibrate('heavy');
                            // –≠–∫—Ä–∞–Ω–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ –¥–ª—è legendary
                            showScreenFlash('#f0b90b');
                        } else if (p.rarity === 'epic') {
                            vibrate('success');
                            showScreenFlash('#9b59b6');
                        } else {
                            vibrate('light');
                        }
                    }
                }

                if (p.x < -50 || p.collected) {
                    parts.splice(i, 1);
                }
            });
        }
        
        function showRfqCompletePopup() {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(46, 204, 113, 0.9);
                padding: 20px 40px;
                border-radius: 16px;
                font-size: 18px;
                font-weight: 700;
                color: white;
                z-index: 100;
                animation: rfqComplete 2s ease-out forwards;
            `;
            popup.innerHTML = '‚úÖ RFQ –í–´–ü–û–õ–ù–ï–ù!';
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2000);
            vibrate('success');
        }
        
        function showScreenFlash(color) {
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: ${color};
                opacity: 0.3;
                pointer-events: none;
                z-index: 50;
                animation: screenFlash 0.3s ease-out forwards;
            `;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 300);
        }

        function updateDifficulty() {
            if (speedMult < CONFIG.DIFFICULTY.MAX_SPEED) {
                speedMult += CONFIG.DIFFICULTY.SPEED_INC;
            }
            document.getElementById('hudSpeed').textContent = '‚ö° x' + speedMult.toFixed(1);
        }

        function updateParticles() {
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2;
                p.life -= 0.02;
                p.size *= 0.98;

                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            });
        }

        // ==========================================
        // DRAW
        // ==========================================
        function drawBg() {
            // –ì—Ä–∞–¥–∏–µ–Ω—Ç –Ω–µ–±–∞ (–∑–∞–∫–∞—Ç/—Ä–∞—Å—Å–≤–µ—Ç)
            const skyGrad = ctx.createLinearGradient(0, 0, 0, H);
            skyGrad.addColorStop(0, '#0a0a1a');
            skyGrad.addColorStop(0.3, '#1a1a3a');
            skyGrad.addColorStop(0.6, '#2a3a5a');
            skyGrad.addColorStop(0.85, '#3a5a7a');
            skyGrad.addColorStop(1, '#1a3a5a');
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, W, H);

            // –ó–≤—ë–∑–¥—ã (–º–µ—Ä—Ü–∞—é—â–∏–µ)
            for (let i = 0; i < 80; i++) {
                const x = (i * 73 + frameCount * 0.05) % W;
                const y = (i * 47) % (H * 0.5);
                const twinkle = Math.sin(frameCount * 0.05 + i) * 0.3 + 0.7;
                ctx.fillStyle = `rgba(255,255,255,${twinkle * 0.5})`;
                ctx.beginPath();
                ctx.arc(x, y, Math.random() + 0.5, 0, Math.PI * 2);
                ctx.fill();
            }

            // –õ—É–Ω–∞
            ctx.fillStyle = 'rgba(255,255,230,0.9)';
            ctx.shadowColor = 'rgba(255,255,200,0.5)';
            ctx.shadowBlur = 30;
            ctx.beginPath();
            ctx.arc(W - 80, 100, 35, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // –ö—Ä–∞—Ç–µ—Ä—ã –Ω–∞ –ª—É–Ω–µ
            ctx.fillStyle = 'rgba(200,200,180,0.3)';
            ctx.beginPath();
            ctx.arc(W - 90, 95, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(W - 70, 110, 5, 0, Math.PI * 2);
            ctx.fill();

            // –û–±–ª–∞–∫–∞ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ—ë–≤)
            ctx.fillStyle = 'rgba(255,255,255,0.03)';
            for (let i = 0; i < 6; i++) {
                const x = ((i * 250 - frameCount * 0.3) % (W + 300)) - 150;
                const y = 120 + i * 60 + Math.sin(i) * 30;
                ctx.beginPath();
                ctx.ellipse(x, y, 100 + i * 20, 25 + i * 5, 0, 0, Math.PI * 2);
                ctx.ellipse(x + 60, y - 10, 70, 20, 0, 0, Math.PI * 2);
                ctx.ellipse(x - 50, y + 5, 60, 18, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // –ì–æ—Ä—ã –≤–¥–∞–ª–µ–∫–µ
            ctx.fillStyle = 'rgba(30,50,80,0.5)';
            ctx.beginPath();
            ctx.moveTo(0, H - 80);
            for (let x = 0; x <= W; x += 60) {
                const h = 40 + Math.sin(x * 0.01) * 30 + Math.sin(x * 0.02) * 20;
                ctx.lineTo(x, H - 80 - h);
            }
            ctx.lineTo(W, H - 80);
            ctx.closePath();
            ctx.fill();

            // –ó–µ–º–ª—è/–í–ü–ü
            const groundGrad = ctx.createLinearGradient(0, H - 60, 0, H);
            groundGrad.addColorStop(0, '#1a2a3a');
            groundGrad.addColorStop(1, '#0a1a2a');
            ctx.fillStyle = groundGrad;
            ctx.fillRect(0, H - 60, W, 60);

            // –†–∞–∑–º–µ—Ç–∫–∞ –í–ü–ü
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            const runwayOffset = (frameCount * 3 * speedMult) % 80;
            for (let x = -runwayOffset; x < W + 80; x += 80) {
                ctx.fillRect(x, H - 35, 40, 6);
            }

            // –ë–æ–∫–æ–≤—ã–µ –æ–≥–Ω–∏ –í–ü–ü
            ctx.fillStyle = '#4a6cf7';
            for (let x = -runwayOffset/2; x < W + 40; x += 40) {
                ctx.shadowColor = '#4a6cf7';
                ctx.shadowBlur = 8;
                ctx.beginPath();
                ctx.arc(x, H - 55, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x, H - 15, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.shadowBlur = 0;

            // –û–≥–Ω–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è (–∂—ë–ª—Ç—ã–µ)
            if (Math.floor(frameCount / 15) % 2 === 0) {
                ctx.fillStyle = '#f0b90b';
                ctx.shadowColor = '#f0b90b';
                ctx.shadowBlur = 12;
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.arc(50 + i * 30, H - 35, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.shadowBlur = 0;
            }
        }

        function drawPlayer() {
            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            const currentH = canvas.height || H || 700;
            const currentW = canvas.width || W || 400;
            
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤–Ω–µ —ç–∫—Ä–∞–Ω–∞ - —Å—Ç–∞–≤–∏–º –≤ —Ü–µ–Ω—Ç—Ä
            if (player.y < 50 || player.y > currentH - 50 || isNaN(player.y)) {
                player.y = currentH / 2;
            }
            if (player.x < 50 || player.x > currentW - 50 || isNaN(player.x)) {
                player.x = 120;
            }
            
            ctx.save();
            ctx.translate(player.x, player.y);
            
            // –ü–ª–∞–≤–Ω–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ
            const wobble = Math.sin(frameCount * 0.08) * 3;
            const tilt = Math.sin(frameCount * 0.05) * 0.05;
            ctx.rotate(player.rot + tilt);
            ctx.translate(0, wobble);

            // –¢–µ–Ω—å –ø–æ–¥ —Å–∞–º–æ–ª—ë—Ç–æ–º
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath();
            ctx.ellipse(5, 25, 30, 8, 0, 0, Math.PI * 2);
            ctx.fill();

            // ===== –î–í–ò–ì–ê–¢–ï–õ–¨ (–ø–ª–∞–º—è) =====
            const flameLen = 25 + Math.random() * 15 + Math.sin(frameCount * 0.3) * 5;
            const flameWidth = 8 + Math.random() * 4;
            
            // –í–Ω–µ—à–Ω–µ–µ –ø–ª–∞–º—è (–æ—Ä–∞–Ω–∂–µ–≤–æ–µ)
            const flameGrad = ctx.createLinearGradient(-30, 0, -30 - flameLen, 0);
            flameGrad.addColorStop(0, 'rgba(255,200,50,0.9)');
            flameGrad.addColorStop(0.3, 'rgba(255,100,20,0.7)');
            flameGrad.addColorStop(1, 'rgba(255,50,0,0)');
            ctx.fillStyle = flameGrad;
            ctx.beginPath();
            ctx.moveTo(-30, -flameWidth/2);
            ctx.quadraticCurveTo(-30 - flameLen/2, 0, -30 - flameLen, 0);
            ctx.quadraticCurveTo(-30 - flameLen/2, 0, -30, flameWidth/2);
            ctx.fill();
            
            // –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –ø–ª–∞–º—è (–≥–æ–ª—É–±–æ–µ, –≥–æ—Ä—è—á–µ–µ)
            const innerFlameLen = flameLen * 0.5;
            const innerGrad = ctx.createLinearGradient(-30, 0, -30 - innerFlameLen, 0);
            innerGrad.addColorStop(0, 'rgba(150,200,255,0.9)');
            innerGrad.addColorStop(1, 'rgba(100,150,255,0)');
            ctx.fillStyle = innerGrad;
            ctx.beginPath();
            ctx.moveTo(-30, -3);
            ctx.quadraticCurveTo(-30 - innerFlameLen/2, 0, -30 - innerFlameLen, 0);
            ctx.quadraticCurveTo(-30 - innerFlameLen/2, 0, -30, 3);
            ctx.fill();

            // ===== –ö–û–†–ü–£–° –°–ê–ú–û–õ–Å–¢–ê =====
            // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ—Ä–ø—É—Å (—Ñ—é–∑–µ–ª—è–∂)
            ctx.shadowColor = '#4a6cf7';
            ctx.shadowBlur = 15;
            
            const bodyGrad = ctx.createLinearGradient(0, -15, 0, 15);
            bodyGrad.addColorStop(0, '#ffffff');
            bodyGrad.addColorStop(0.3, '#e8e8e8');
            bodyGrad.addColorStop(0.7, '#c0c0c0');
            bodyGrad.addColorStop(1, '#a0a0a0');
            ctx.fillStyle = bodyGrad;
            
            ctx.beginPath();
            ctx.moveTo(35, 0);  // –ù–æ—Å
            ctx.quadraticCurveTo(30, -8, 20, -10);
            ctx.lineTo(-25, -8);
            ctx.quadraticCurveTo(-32, -6, -32, 0);
            ctx.quadraticCurveTo(-32, 6, -25, 8);
            ctx.lineTo(20, 10);
            ctx.quadraticCurveTo(30, 8, 35, 0);
            ctx.fill();
            
            ctx.shadowBlur = 0;

            // ===== –ö–û–ö–ü–ò–¢ =====
            const cockpitGrad = ctx.createLinearGradient(15, -8, 25, 2);
            cockpitGrad.addColorStop(0, '#87CEEB');
            cockpitGrad.addColorStop(0.5, '#4a6cf7');
            cockpitGrad.addColorStop(1, '#1a3a8a');
            ctx.fillStyle = cockpitGrad;
            ctx.beginPath();
            ctx.ellipse(22, -2, 10, 6, 0.15, 0, Math.PI * 2);
            ctx.fill();
            
            // –ë–ª–∏–∫ –Ω–∞ –∫–æ–∫–ø–∏—Ç–µ
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.beginPath();
            ctx.ellipse(24, -4, 4, 2, 0.3, 0, Math.PI * 2);
            ctx.fill();

            // ===== –ö–†–´–õ–¨–Ø =====
            // –í–µ—Ä—Ö–Ω–µ–µ –∫—Ä—ã–ª–æ
            const wingGrad = ctx.createLinearGradient(0, -30, 0, 0);
            wingGrad.addColorStop(0, '#d0d0d0');
            wingGrad.addColorStop(1, '#909090');
            ctx.fillStyle = wingGrad;
            
            ctx.beginPath();
            ctx.moveTo(5, -5);
            ctx.lineTo(-5, -28);
            ctx.lineTo(-20, -30);
            ctx.lineTo(-15, -28);
            ctx.lineTo(0, -8);
            ctx.lineTo(15, -5);
            ctx.closePath();
            ctx.fill();
            
            // –ù–∏–∂–Ω–µ–µ –∫—Ä—ã–ª–æ
            const wingGrad2 = ctx.createLinearGradient(0, 0, 0, 30);
            wingGrad2.addColorStop(0, '#b0b0b0');
            wingGrad2.addColorStop(1, '#808080');
            ctx.fillStyle = wingGrad2;
            
            ctx.beginPath();
            ctx.moveTo(5, 5);
            ctx.lineTo(-5, 28);
            ctx.lineTo(-20, 30);
            ctx.lineTo(-15, 28);
            ctx.lineTo(0, 8);
            ctx.lineTo(15, 5);
            ctx.closePath();
            ctx.fill();
            
            // –ö—Ä–∞—Å–Ω—ã–µ –∑–∞–∫–æ–Ω—Ü–æ–≤–∫–∏ –∫—Ä—ã–ª—å–µ–≤
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.ellipse(-17, -29, 4, 2, -0.2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(-17, 29, 4, 2, 0.2, 0, Math.PI * 2);
            ctx.fill();

            // ===== –•–í–û–°–¢ =====
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä
            const tailGrad = ctx.createLinearGradient(-25, -20, -25, 0);
            tailGrad.addColorStop(0, '#4a6cf7');
            tailGrad.addColorStop(1, '#2a4cd7');
            ctx.fillStyle = tailGrad;
            
            ctx.beginPath();
            ctx.moveTo(-25, -5);
            ctx.lineTo(-32, -22);
            ctx.lineTo(-38, -20);
            ctx.lineTo(-32, -5);
            ctx.closePath();
            ctx.fill();
            
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä
            ctx.fillStyle = '#c0c0c0';
            ctx.beginPath();
            ctx.moveTo(-28, 0);
            ctx.lineTo(-35, -8);
            ctx.lineTo(-40, -6);
            ctx.lineTo(-35, 0);
            ctx.lineTo(-40, 6);
            ctx.lineTo(-35, 8);
            ctx.closePath();
            ctx.fill();

            // ===== –î–í–ò–ì–ê–¢–ï–õ–¨ (–≥–æ–Ω–¥–æ–ª–∞) =====
            ctx.fillStyle = '#606060';
            ctx.beginPath();
            ctx.ellipse(-28, 0, 6, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#404040';
            ctx.beginPath();
            ctx.ellipse(-30, 0, 4, 4, 0, 0, Math.PI * 2);
            ctx.fill();

            // ===== –õ–û–ì–û–¢–ò–ü (–ø–æ–ª–æ—Å–∞) =====
            ctx.fillStyle = '#4a6cf7';
            ctx.fillRect(-15, -3, 25, 2);
            ctx.fillRect(-15, 1, 25, 2);

            // ===== –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–´–ï –û–ì–ù–ò =====
            // –ú–∏–≥–∞—é—â–∏–π –∫—Ä–∞—Å–Ω—ã–π –Ω–∞ –ª–µ–≤–æ–º –∫—Ä—ã–ª–µ
            if (Math.floor(frameCount / 30) % 2 === 0) {
                ctx.fillStyle = '#ff0000';
                ctx.shadowColor = '#ff0000';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(-17, -29, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // –ú–∏–≥–∞—é—â–∏–π –∑–µ–ª—ë–Ω—ã–π –Ω–∞ –ø—Ä–∞–≤–æ–º –∫—Ä—ã–ª–µ
            if (Math.floor(frameCount / 30) % 2 === 0) {
                ctx.fillStyle = '#00ff00';
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(-17, 29, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // –ë–µ–ª—ã–π –Ω–∞ —Ö–≤–æ—Å—Ç–µ (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π)
            ctx.fillStyle = '#ffffff';
            ctx.shadowColor = '#ffffff';
            ctx.shadowBlur = 8;
            ctx.beginPath();
            ctx.arc(-38, -18, 2, 0, Math.PI * 2);
            ctx.fill();

            ctx.shadowBlur = 0;
            ctx.restore();
            
            // ===== –°–õ–ï–î –û–¢ –î–í–ò–ì–ê–¢–ï–õ–Ø (—á–∞—Å—Ç–∏—Ü—ã) =====
            if (gameState === 'playing' && frameCount % 2 === 0) {
                const trailX = player.x - 45;
                const trailY = player.y + wobble;
                particles.push({
                    x: trailX + Math.random() * 10,
                    y: trailY + (Math.random() - 0.5) * 8,
                    vx: -2 - Math.random() * 2,
                    vy: (Math.random() - 0.5) * 2,
                    size: 3 + Math.random() * 4,
                    color: `rgba(255,${150 + Math.random() * 100},50,0.6)`,
                    life: 0.5 + Math.random() * 0.3
                });
            }
        }

        function drawObstacles() {
            obstacles.forEach(o => {
                const w = CONFIG.OBSTACLES.WIDTH;
                
                // ===== –í–ï–†–•–ù–ï–ï –ü–†–ï–ü–Ø–¢–°–¢–í–ò–ï (–±–∞—à–Ω—è —Å–≤–µ—Ä—Ö—É) =====
                // –û—Å–Ω–æ–≤–Ω–∞—è –±–∞—à–Ω—è
                const topGrad = ctx.createLinearGradient(o.x, 0, o.x + w, 0);
                topGrad.addColorStop(0, '#1a3a5c');
                topGrad.addColorStop(0.3, '#2a5a8c');
                topGrad.addColorStop(0.7, '#2a5a8c');
                topGrad.addColorStop(1, '#1a3a5c');
                ctx.fillStyle = topGrad;
                ctx.fillRect(o.x, 0, w, o.top);
                
                // –û–∫–Ω–∞ –Ω–∞ –±–∞—à–Ω–µ
                ctx.fillStyle = 'rgba(100,200,255,0.3)';
                for (let y = 20; y < o.top - 30; y += 40) {
                    for (let x = 8; x < w - 8; x += 20) {
                        ctx.fillRect(o.x + x, y, 12, 25);
                    }
                }
                
                // –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
                ctx.fillStyle = '#3a6a9c';
                ctx.beginPath();
                ctx.moveTo(o.x - 8, o.top);
                ctx.lineTo(o.x - 8, o.top - 25);
                ctx.lineTo(o.x, o.top - 35);
                ctx.lineTo(o.x + w, o.top - 35);
                ctx.lineTo(o.x + w + 8, o.top - 25);
                ctx.lineTo(o.x + w + 8, o.top);
                ctx.closePath();
                ctx.fill();
                
                // –ê–Ω—Ç–µ–Ω–Ω–∞ —Å–≤–µ—Ä—Ö—É
                ctx.strokeStyle = '#5a8abc';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(o.x + w/2, 0);
                ctx.lineTo(o.x + w/2, -15);
                ctx.stroke();
                
                // –ö—Ä–∞—Å–Ω—ã–π –æ–≥–æ–Ω—å –Ω–∞ –∞–Ω—Ç–µ–Ω–Ω–µ (–º–∏–≥–∞—é—â–∏–π)
                if (Math.floor(frameCount / 25) % 2 === 0) {
                    ctx.fillStyle = '#ff0000';
                    ctx.shadowColor = '#ff0000';
                    ctx.shadowBlur = 15;
                    ctx.beginPath();
                    ctx.arc(o.x + w/2, -15, 4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
                
                // ===== –ù–ò–ñ–ù–ï–ï –ü–†–ï–ü–Ø–¢–°–¢–í–ò–ï (–∞–Ω–≥–∞—Ä/–∑–¥–∞–Ω–∏–µ) =====
                // –û—Å–Ω–æ–≤–Ω–æ–µ –∑–¥–∞–Ω–∏–µ
                const botGrad = ctx.createLinearGradient(o.x, o.bottom, o.x + w, o.bottom);
                botGrad.addColorStop(0, '#2a4a6c');
                botGrad.addColorStop(0.3, '#3a6a9c');
                botGrad.addColorStop(0.7, '#3a6a9c');
                botGrad.addColorStop(1, '#2a4a6c');
                ctx.fillStyle = botGrad;
                ctx.fillRect(o.x, o.bottom, w, H - o.bottom);
                
                // –ö—Ä—ã—à–∞ (—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∞—è)
                ctx.fillStyle = '#4a7aac';
                ctx.beginPath();
                ctx.moveTo(o.x - 8, o.bottom + 25);
                ctx.lineTo(o.x + w/2, o.bottom);
                ctx.lineTo(o.x + w + 8, o.bottom + 25);
                ctx.lineTo(o.x + w + 8, o.bottom + 30);
                ctx.lineTo(o.x - 8, o.bottom + 30);
                ctx.closePath();
                ctx.fill();
                
                // –ë–æ–ª—å—à–∏–µ –≤–æ—Ä–æ—Ç–∞ –∞–Ω–≥–∞—Ä–∞
                ctx.fillStyle = '#1a2a3c';
                ctx.fillRect(o.x + 10, o.bottom + 35, w - 20, H - o.bottom - 45);
                
                // –õ–∏–Ω–∏–∏ –Ω–∞ –≤–æ—Ä–æ—Ç–∞—Ö
                ctx.strokeStyle = '#3a5a7c';
                ctx.lineWidth = 2;
                for (let i = 1; i < 4; i++) {
                    ctx.beginPath();
                    ctx.moveTo(o.x + 10 + (w - 20) * i / 4, o.bottom + 35);
                    ctx.lineTo(o.x + 10 + (w - 20) * i / 4, H);
                    ctx.stroke();
                }
                
                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–µ –ø–æ–ª–æ—Å—ã
                ctx.fillStyle = '#f0b90b';
                ctx.fillRect(o.x - 8, o.bottom + 25, 6, 5);
                ctx.fillRect(o.x + w + 2, o.bottom + 25, 6, 5);
                
                // –û–≥–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                ctx.fillStyle = '#ff4444';
                ctx.shadowColor = '#ff4444';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(o.x + w/2, o.bottom + 5, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            });
        }

        function drawParts() {
            parts.forEach(p => {
                if (p.collected) return;

                ctx.save();
                ctx.translate(p.x, p.y);
                
                // –í—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
                if (p.rarity === 'legendary' || p.rarity === 'epic') {
                    ctx.rotate(frameCount * 0.02);
                }
                
                // –ü—É–ª—å—Å–∞—Ü–∏—è
                const pulse = 1 + Math.sin(frameCount * 0.1 + p.x) * 0.1;
                ctx.scale(pulse, pulse);

                // –í–Ω–µ—à–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ
                const glowIntensity = {
                    common: 0,
                    uncommon: 15,
                    rare: 25,
                    epic: 35,
                    legendary: 50
                };
                
                const glowColors = {
                    common: 'rgba(150,150,150,0.3)',
                    uncommon: 'rgba(46,204,113,0.5)',
                    rare: 'rgba(74,108,247,0.6)',
                    epic: 'rgba(155,89,182,0.7)',
                    legendary: 'rgba(240,185,11,1)'
                };

                // –ö–æ–ª—å—Ü–∞ –¥–ª—è legendary
                if (p.rarity === 'legendary') {
                    ctx.strokeStyle = 'rgba(240,185,11,0.3)';
                    ctx.lineWidth = 2;
                    const ringSize = 35 + Math.sin(frameCount * 0.05) * 5;
                    ctx.beginPath();
                    ctx.arc(0, 0, ringSize, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    ctx.strokeStyle = 'rgba(240,185,11,0.2)';
                    ctx.beginPath();
                    ctx.arc(0, 0, ringSize + 10, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // –û—Å–Ω–æ–≤–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = glowColors[p.rarity];
                ctx.shadowBlur = glowIntensity[p.rarity] + p.glow * 10;

                // –§–æ–Ω–æ–≤—ã–π –∫—Ä—É–≥
                const bgGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, 25);
                const baseColors = {
                    common: ['#4a4a4a', '#2a2a2a'],
                    uncommon: ['#27ae60', '#1e8449'],
                    rare: ['#3498db', '#2980b9'],
                    epic: ['#9b59b6', '#8e44ad'],
                    legendary: ['#f39c12', '#d68910']
                };
                bgGrad.addColorStop(0, baseColors[p.rarity][0]);
                bgGrad.addColorStop(1, baseColors[p.rarity][1]);
                
                ctx.fillStyle = bgGrad;
                ctx.beginPath();
                ctx.arc(0, 0, 24, 0, Math.PI * 2);
                ctx.fill();

                // –ë–ª–∏–∫
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.ellipse(-8, -8, 8, 5, -0.5, 0, Math.PI * 2);
                ctx.fill();

                // –ò–∫–æ–Ω–∫–∞
                ctx.shadowBlur = 0;
                ctx.font = '22px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(p.icon, 0, 0);

                ctx.restore();

                // –¶–µ–Ω–∞ –ø–æ–¥ –¥–µ—Ç–∞–ª—å—é (–¥–ª—è uncommon+)
                if (p.rarity !== 'common') {
                    ctx.font = 'bold 10px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = getRarityColor(p.rarity);
                    ctx.fillText('$' + formatMoney(p.value), p.x, p.y + 35);
                }
            });
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        // ==========================================
        // HELPERS
        // ==========================================
        function getRarityColor(rarity) {
            const colors = {
                common: '#9ca3af',
                uncommon: '#2ecc71',
                rare: '#4a6cf7',
                epic: '#9b59b6',
                legendary: '#f0b90b'
            };
            return colors[rarity] || '#fff';
        }

        function getRarityBg(rarity) {
            const colors = {
                common: 'rgba(100,100,100,0.8)',
                uncommon: 'rgba(46,204,113,0.8)',
                rare: 'rgba(74,108,247,0.8)',
                epic: 'rgba(155,89,182,0.8)',
                legendary: 'rgba(240,185,11,0.9)'
            };
            return colors[rarity] || 'rgba(100,100,100,0.8)';
        }

        function formatMoney(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
            return n.toString();
        }

        function showPartPopup(part) {
            const popup = document.createElement('div');
            popup.className = 'part-popup';
            popup.style.left = part.x + 'px';
            popup.style.top = (part.y - 30) + 'px';
            popup.style.color = getRarityColor(part.rarity);
            popup.innerHTML = `+$${part.value.toLocaleString()}`;
            document.querySelector('.game-container').appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }

        // ==========================================
        // UI
        // ==========================================
        const $ = id => document.getElementById(id);

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (id) $(id).classList.add('active');
        }

        function updateMenuStats() {
            $('totalMoney').textContent = stats.money.toLocaleString();
            $('totalRfq').textContent = stats.rfq;
            $('totalParts').textContent = stats.parts;
            $('totalGames').textContent = stats.games;
        }

        // ==========================================
        // EVENTS
        // ==========================================
        canvas.addEventListener('click', jump);
        canvas.addEventListener('touchstart', e => { e.preventDefault(); jump(); });
        document.addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); jump(); } });

        $('btnPlay').onclick = showRfqScreen;
        $('btnStartRfq').onclick = startGame;
        $('btnSkipRfq').onclick = () => { currentRfq = null; startGame(); };
        $('btnRetry').onclick = showRfqScreen;
        $('btnHome').onclick = () => { showScreen('mainMenu'); updateMenuStats(); };
        $('btnLeaderboard').onclick = () => alert('–°–∫–æ—Ä–æ!');

        // ==========================================
        // GAME LOOP
        // ==========================================
        function loop() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
            if (canvas.width < 100 || canvas.height < 100) {
                resize();
            }
            
            drawBg();
            
            // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã –∏–ª–∏ game over
            if (gameState === 'playing' || gameState === 'over') {
                drawObstacles();
                drawParts();
                drawPlayer();
            }
            
            drawParticles();

            if (gameState === 'playing') {
                updatePlayer();
                updateObstacles();
                updateParts();
                updateDifficulty();
            }

            updateParticles();
            frameCount++;
            requestAnimationFrame(loop);
        }

        // ==========================================
        // INIT
        // ==========================================
        updateMenuStats();
        loop();
    </script>
</body>
</html>
