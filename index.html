<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0b14">
    <title>Aviation Parts Runner v4.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0b14;
            --bg-card: #1a1c2e;
            --bg-card-hover: #242640;
            --accent-blue: #4a6cf7;
            --accent-gold: #f0b90b;
            --accent-red: #e74c3c;
            --accent-green: #2ecc71;
            --accent-cyan: #00d4ff;
            --accent-purple: #9b59b6;
            --accent-pink: #ff6b9d;
            --accent-orange: #f39c12;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --border-color: rgba(255,255,255,0.08);
            --safe-top: 100px;
            --glow-blue: 0 0 20px rgba(74,108,247,0.5);
            --glow-gold: 0 0 20px rgba(240,185,11,0.5);
            --glow-cyan: 0 0 20px rgba(0,212,255,0.5);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        html,body { width:100%; height:100%; background:#000; font-family:'Inter',sans-serif; overflow:hidden; touch-action:manipulation; user-select:none; }
        .game-container { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; }
        #gameCanvas { position:absolute; top:0; left:0; width:100%; height:100%; }

        /* HUD */
        .hud { position:absolute; top:0; left:0; width:100%; padding:calc(var(--safe-top) + 5px) 12px 12px; pointer-events:none; z-index:10; opacity:0; transition:opacity 0.3s; }
        .hud.visible { opacity:1; }
        .hud-top { display:flex; justify-content:space-between; gap:8px; }
        .hud-left, .hud-right { display:flex; flex-direction:column; gap:4px; }
        .hud-box { background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); padding:6px 12px; border-radius:12px; font-size:12px; font-weight:600; border:1px solid rgba(255,255,255,0.1); }
        .hud-money { color:var(--accent-gold); font-size:14px; text-shadow:var(--glow-gold); }
        .hud-xp { color:var(--accent-cyan); font-size:10px; }
        .hud-xp-bar { width:60px; height:4px; background:rgba(255,255,255,0.2); border-radius:2px; margin-top:3px; overflow:hidden; }
        .hud-xp-fill { height:100%; background:linear-gradient(90deg,var(--accent-cyan),var(--accent-blue)); transition:width 0.3s; }
        .hud-center { flex:1; max-width:140px; }
        .hud-mission { background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); }
        .hud-mission-title { font-size:8px; color:var(--accent-cyan); text-transform:uppercase; margin-bottom:3px; }
        .hud-mission-text { font-size:9px; color:var(--text-primary); }
        .hud-mission-progress { height:3px; background:rgba(255,255,255,0.2); border-radius:2px; margin-top:4px; overflow:hidden; }
        .hud-mission-fill { height:100%; background:var(--accent-green); transition:width 0.3s; }
        .hud-powerups { display:flex; gap:4px; margin-top:4px; }
        .hud-pw { width:30px; height:30px; background:rgba(0,0,0,0.8); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:14px; opacity:0.4; border:1px solid rgba(255,255,255,0.1); }
        .hud-pw.active { opacity:1; border-color:var(--accent-cyan); box-shadow:var(--glow-cyan); }

        /* Boss HP Bar */
        .boss-hud { position:absolute; top:calc(var(--safe-top) + 60px); left:50%; transform:translateX(-50%); width:80%; max-width:300px; display:none; z-index:15; }
        .boss-hud.show { display:block; animation:bossAppear 0.5s ease; }
        @keyframes bossAppear { from { opacity:0; transform:translateX(-50%) scale(0.8); } to { opacity:1; transform:translateX(-50%) scale(1); } }
        .boss-name { font-size:12px; font-weight:800; color:var(--accent-red); text-align:center; text-transform:uppercase; letter-spacing:2px; margin-bottom:6px; text-shadow:0 0 10px rgba(231,76,60,0.8); }
        .boss-hp-bar { height:12px; background:rgba(0,0,0,0.8); border-radius:6px; overflow:hidden; border:2px solid var(--accent-red); }
        .boss-hp-fill { height:100%; background:linear-gradient(90deg,#e74c3c,#c0392b); transition:width 0.3s; }
        .boss-hp-text { font-size:10px; color:var(--text-primary); text-align:center; margin-top:4px; }

        /* Screens */
        .screen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; z-index:20; opacity:0; pointer-events:none; transition:opacity 0.3s; overflow-y:auto; background:var(--bg-primary); }
        .screen.active { opacity:1; pointer-events:auto; }
        .screen-header { display:flex; align-items:center; padding:calc(var(--safe-top) + 5px) 16px 12px; background:rgba(10,11,20,0.95); backdrop-filter:blur(20px); border-bottom:1px solid var(--border-color); position:sticky; top:0; z-index:5; }
        .btn-back { width:36px; height:36px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:16px; cursor:pointer; transition:all 0.2s; }
        .btn-back:hover { background:var(--bg-card-hover); }
        .screen-title { flex:1; text-align:center; font-size:16px; font-weight:800; color:var(--text-primary); margin-right:36px; }

        /* Main Menu */
        .main-menu { background:linear-gradient(180deg,#0a0b14 0%,#12131f 50%,#1a1c2e 100%); }
        .menu-content { padding:calc(var(--safe-top) + 5px) 16px 20px; display:flex; flex-direction:column; align-items:center; }
        .logo-badge { background:linear-gradient(135deg,var(--accent-pink),var(--accent-purple)); padding:5px 12px; border-radius:12px; font-size:9px; font-weight:800; color:white; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; box-shadow:0 4px 15px rgba(155,89,182,0.4); }
        .logo-title { font-size:24px; font-weight:900; color:var(--text-primary); text-align:center; line-height:1.1; text-shadow:0 0 30px rgba(74,108,247,0.5); }
        .logo-subtitle { font-size:10px; font-weight:600; color:var(--accent-blue); text-transform:uppercase; letter-spacing:3px; margin-top:4px; }

        /* Stats Card */
        .stats-card { width:100%; background:linear-gradient(135deg,rgba(74,108,247,0.15),rgba(155,89,182,0.1)); border:1px solid rgba(74,108,247,0.3); border-radius:16px; padding:14px; margin:12px 0; }
        .stats-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .stats-money { font-size:26px; font-weight:900; color:var(--accent-gold); text-shadow:var(--glow-gold); }
        .stats-level { display:flex; align-items:center; gap:6px; background:rgba(0,212,255,0.2); padding:4px 10px; border-radius:10px; }
        .stats-level-num { font-size:14px; font-weight:800; color:var(--accent-cyan); }
        .stats-level-text { font-size:8px; color:var(--text-secondary); text-transform:uppercase; }
        .stats-xp-bar { height:6px; background:rgba(255,255,255,0.1); border-radius:3px; margin:8px 0; overflow:hidden; }
        .stats-xp-fill { height:100%; background:linear-gradient(90deg,var(--accent-cyan),var(--accent-blue),var(--accent-purple)); transition:width 0.5s; }
        .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
        .stats-item { text-align:center; padding:8px 4px; background:rgba(0,0,0,0.3); border-radius:10px; }
        .stats-item-value { font-size:14px; font-weight:800; color:var(--text-primary); }
        .stats-item-label { font-size:7px; color:var(--text-secondary); text-transform:uppercase; margin-top:2px; }

        /* Buttons */
        .menu-buttons { width:100%; display:flex; flex-direction:column; gap:8px; }
        .btn { display:flex; align-items:center; justify-content:center; gap:8px; padding:14px 18px; font-family:inherit; font-size:13px; font-weight:700; color:var(--text-primary); border:none; border-radius:14px; cursor:pointer; text-transform:uppercase; letter-spacing:0.5px; transition:all 0.2s; }
        .btn:active { transform:scale(0.97); }
        .btn-primary { background:linear-gradient(135deg,var(--accent-blue),#3451d1); box-shadow:0 4px 20px rgba(74,108,247,0.4); }
        .btn-primary:hover { box-shadow:0 6px 30px rgba(74,108,247,0.6); }
        .btn-secondary { background:var(--bg-card); border:1px solid var(--border-color); }
        .btn-pvp { background:linear-gradient(135deg,var(--accent-orange),#e67e22); box-shadow:0 4px 20px rgba(243,156,18,0.4); }
        .btn-boss { background:linear-gradient(135deg,var(--accent-red),#c0392b); box-shadow:0 4px 20px rgba(231,76,60,0.4); animation:pulseRed 2s infinite; }
        @keyframes pulseRed { 0%,100% { box-shadow:0 4px 20px rgba(231,76,60,0.4); } 50% { box-shadow:0 4px 30px rgba(231,76,60,0.7); } }
        .btn-battlepass { background:linear-gradient(135deg,var(--accent-purple),var(--accent-pink)); box-shadow:0 4px 20px rgba(155,89,182,0.4); }
        .btn-gold { background:linear-gradient(135deg,var(--accent-gold),#d4a00a); color:#000; box-shadow:0 4px 20px rgba(240,185,11,0.4); }
        .menu-row { display:flex; gap:8px; width:100%; }
        .menu-row .btn { flex:1; font-size:11px; padding:12px 8px; }
        .menu-footer { margin-top:auto; padding-top:14px; text-align:center; font-size:9px; color:var(--text-secondary); }
        .menu-footer a { color:var(--accent-blue); text-decoration:none; }

        /* Daily Missions */
        .missions-card { width:100%; background:var(--bg-card); border:1px solid var(--border-color); border-radius:14px; padding:12px; margin-bottom:10px; }
        .missions-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .missions-title { font-size:11px; font-weight:700; color:var(--accent-cyan); text-transform:uppercase; }
        .missions-timer { font-size:10px; color:var(--text-secondary); }
        .mission-item { display:flex; align-items:center; gap:10px; padding:10px; background:rgba(0,0,0,0.3); border-radius:10px; margin-bottom:6px; }
        .mission-item.completed { opacity:0.6; }
        .mission-icon { font-size:20px; }
        .mission-info { flex:1; }
        .mission-name { font-size:11px; font-weight:600; color:var(--text-primary); }
        .mission-progress { height:4px; background:rgba(255,255,255,0.1); border-radius:2px; margin-top:4px; overflow:hidden; }
        .mission-progress-fill { height:100%; background:var(--accent-green); transition:width 0.3s; }
        .mission-reward { font-size:11px; font-weight:700; color:var(--accent-gold); }

        /* Battle Pass */
        .bp-content { padding:12px; }
        .bp-header { background:linear-gradient(135deg,rgba(155,89,182,0.2),rgba(255,107,157,0.1)); border:1px solid rgba(155,89,182,0.3); border-radius:14px; padding:14px; margin-bottom:14px; text-align:center; }
        .bp-season { font-size:10px; color:var(--accent-pink); text-transform:uppercase; letter-spacing:2px; }
        .bp-title { font-size:18px; font-weight:900; color:var(--text-primary); margin:4px 0; }
        .bp-progress { display:flex; align-items:center; gap:10px; margin-top:10px; }
        .bp-level { font-size:20px; font-weight:900; color:var(--accent-purple); }
        .bp-bar { flex:1; height:8px; background:rgba(255,255,255,0.1); border-radius:4px; overflow:hidden; }
        .bp-bar-fill { height:100%; background:linear-gradient(90deg,var(--accent-purple),var(--accent-pink)); }
        .bp-xp { font-size:10px; color:var(--text-secondary); }
        .bp-tiers { display:flex; flex-direction:column; gap:8px; }
        .bp-tier { display:flex; align-items:center; gap:12px; padding:12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; }
        .bp-tier.unlocked { border-color:var(--accent-green); background:rgba(46,204,113,0.1); }
        .bp-tier.current { border-color:var(--accent-purple); background:rgba(155,89,182,0.1); }
        .bp-tier.premium { border-color:var(--accent-gold); }
        .bp-tier-num { width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:800; background:var(--bg-primary); border-radius:8px; color:var(--text-secondary); }
        .bp-tier.unlocked .bp-tier-num { background:var(--accent-green); color:#000; }
        .bp-tier.current .bp-tier-num { background:var(--accent-purple); color:#fff; }
        .bp-tier-rewards { flex:1; display:flex; gap:8px; }
        .bp-reward { display:flex; flex-direction:column; align-items:center; padding:6px 10px; background:rgba(0,0,0,0.3); border-radius:8px; }
        .bp-reward.premium { background:rgba(240,185,11,0.15); border:1px solid rgba(240,185,11,0.3); }
        .bp-reward-icon { font-size:18px; }
        .bp-reward-text { font-size:8px; color:var(--text-secondary); margin-top:2px; }
        .bp-reward.claimed .bp-reward-icon { opacity:0.5; }

        /* PvP */
        .pvp-content { padding:12px; }
        .pvp-header { background:linear-gradient(135deg,rgba(243,156,18,0.2),rgba(230,126,34,0.1)); border:1px solid rgba(243,156,18,0.3); border-radius:14px; padding:14px; margin-bottom:14px; text-align:center; }
        .pvp-title { font-size:16px; font-weight:900; color:var(--accent-orange); margin-bottom:4px; }
        .pvp-subtitle { font-size:11px; color:var(--text-secondary); }
        .pvp-stats { display:flex; justify-content:center; gap:20px; margin-top:10px; }
        .pvp-stat { text-align:center; }
        .pvp-stat-value { font-size:18px; font-weight:800; color:var(--text-primary); }
        .pvp-stat-label { font-size:9px; color:var(--text-secondary); text-transform:uppercase; }
        .pvp-opponent { display:flex; align-items:center; gap:12px; padding:14px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:14px; margin-bottom:10px; }
        .pvp-opponent-avatar { width:50px; height:50px; background:linear-gradient(135deg,var(--accent-blue),var(--accent-purple)); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px; }
        .pvp-opponent-info { flex:1; }
        .pvp-opponent-name { font-size:14px; font-weight:700; color:var(--text-primary); }
        .pvp-opponent-score { font-size:12px; color:var(--accent-gold); margin-top:2px; }
        .pvp-opponent-level { font-size:10px; color:var(--text-secondary); }

        /* Boss Mode */
        .boss-content { padding:12px; text-align:center; }
        .boss-preview { width:120px; height:120px; margin:20px auto; background:radial-gradient(circle,rgba(231,76,60,0.3),transparent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:60px; animation:bossFloat 3s ease-in-out infinite; }
        @keyframes bossFloat { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-10px); } }
        .boss-info { margin:20px 0; }
        .boss-info-name { font-size:20px; font-weight:900; color:var(--accent-red); text-transform:uppercase; }
        .boss-info-desc { font-size:12px; color:var(--text-secondary); margin-top:6px; }
        .boss-rewards { display:flex; justify-content:center; gap:20px; margin:20px 0; }
        .boss-reward-item { text-align:center; }
        .boss-reward-icon { font-size:28px; }
        .boss-reward-text { font-size:10px; color:var(--accent-gold); margin-top:4px; }

        /* Game Over */
        .gameover-screen { background:linear-gradient(180deg,rgba(10,11,20,0.98),rgba(18,19,31,0.99)); justify-content:center; align-items:center; padding:24px; }
        .gameover-icon { font-size:50px; margin-bottom:10px; }
        .gameover-title { font-size:14px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:2px; }
        .gameover-money { font-size:48px; font-weight:900; color:var(--accent-gold); text-shadow:var(--glow-gold); margin:6px 0; }
        .gameover-xp { font-size:14px; color:var(--accent-cyan); margin-bottom:16px; }
        .gameover-boss { background:rgba(231,76,60,0.2); border:1px solid rgba(231,76,60,0.4); border-radius:12px; padding:12px 20px; margin-bottom:14px; }
        .gameover-boss-text { font-size:13px; font-weight:700; color:var(--accent-red); }
        .gameover-stats { display:flex; gap:20px; margin:14px 0; }
        .gameover-stat { text-align:center; }
        .gameover-stat-value { font-size:18px; font-weight:800; color:var(--text-primary); }
        .gameover-stat-label { font-size:9px; color:var(--text-secondary); text-transform:uppercase; }
        .gameover-buttons { display:flex; flex-direction:column; gap:10px; width:100%; max-width:260px; margin-top:16px; }

        /* Music Toggle */
        .music-toggle { position:absolute; top:calc(var(--safe-top) + 10px); right:12px; width:40px; height:40px; background:rgba(0,0,0,0.8); border:1px solid rgba(255,255,255,0.2); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; z-index:25; transition:all 0.2s; }
        .music-toggle:hover { background:rgba(255,255,255,0.1); }
        .music-toggle.muted { opacity:0.5; }

        /* Alerts */
        .alert-popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.95); border:2px solid var(--accent-gold); border-radius:16px; padding:20px 30px; text-align:center; z-index:100; display:none; backdrop-filter:blur(20px); }
        .alert-popup.show { display:block; animation:popIn 0.3s ease; }
        @keyframes popIn { from { transform:translate(-50%,-50%) scale(0.5); opacity:0; } to { transform:translate(-50%,-50%) scale(1); opacity:1; } }
        .alert-icon { font-size:40px; margin-bottom:8px; }
        .alert-text { font-size:14px; font-weight:800; color:var(--accent-gold); text-transform:uppercase; letter-spacing:1px; }

        .part-popup { position:absolute; pointer-events:none; font-size:13px; font-weight:800; text-shadow:0 2px 8px rgba(0,0,0,0.8); animation:partPop 1s ease-out forwards; z-index:15; }
        @keyframes partPop { from { opacity:1; transform:translateY(0) scale(1); } to { opacity:0; transform:translateY(-40px) scale(1.2); } }

        /* Leaderboard styles from v3 */
        .lb-content { padding:12px; flex:1; display:flex; flex-direction:column; }
        .lb-tabs { display:flex; gap:8px; margin-bottom:12px; }
        .lb-tab { flex:1; padding:12px; font-family:inherit; font-size:12px; font-weight:700; color:var(--text-secondary); background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; cursor:pointer; transition:all 0.2s; }
        .lb-tab.active { background:var(--accent-blue); color:white; border-color:var(--accent-blue); }
        .lb-list { display:flex; flex-direction:column; gap:8px; flex:1; padding-bottom:30px; }
        .lb-loading,.lb-empty { text-align:center; padding:60px 20px; color:var(--text-secondary); font-size:14px; }
        .lb-item { display:flex; align-items:center; gap:12px; padding:12px 14px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; transition:all 0.2s; }
        .lb-item.me { background:rgba(74,108,247,0.15); border-color:var(--accent-blue); }
        .lb-rank { width:30px; height:30px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:800; border-radius:10px; background:var(--bg-primary); color:var(--text-secondary); }
        .lb-rank.gold { background:linear-gradient(135deg,#f0b90b,#d4a00a); color:#000; }
        .lb-rank.silver { background:linear-gradient(135deg,#c0c0c0,#a8a8a8); color:#000; }
        .lb-rank.bronze { background:linear-gradient(135deg,#cd7f32,#b06c28); color:#fff; }
        .lb-avatar { font-size:26px; }
        .lb-info { flex:1; min-width:0; }
        .lb-name { font-size:13px; font-weight:700; color:var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .lb-stats { font-size:10px; color:var(--text-secondary); margin-top:2px; }
        .lb-score { font-size:16px; font-weight:900; color:var(--accent-gold); }

        /* Shop styles */
        .shop-content { padding:12px; }
        .shop-section { margin-bottom:16px; }
        .shop-section-title { font-size:11px; font-weight:800; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; padding-left:4px; }
        .shop-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
        .shop-item { background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:12px; text-align:center; cursor:pointer; transition:all 0.2s; }
        .shop-item:hover { border-color:rgba(255,255,255,0.2); background:var(--bg-card-hover); }
        .shop-item.owned { border-color:var(--accent-green); background:rgba(46,204,113,0.1); }
        .shop-item-icon { font-size:32px; margin-bottom:6px; }
        .shop-item-name { font-size:12px; font-weight:700; color:var(--text-primary); }
        .shop-item-desc { font-size:9px; color:var(--text-secondary); margin:3px 0 6px; }
        .shop-item-price { font-size:12px; font-weight:800; color:var(--accent-gold); }
        .shop-item-price.owned { color:var(--accent-green); }
        .plane-item { display:flex; align-items:center; gap:12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:12px; margin-bottom:10px; cursor:pointer; transition:all 0.2s; }
        .plane-item:hover { border-color:rgba(255,255,255,0.2); }
        .plane-item.owned { border-color:var(--accent-green); }
        .plane-item.selected { border-color:var(--accent-gold); border-width:2px; box-shadow:var(--glow-gold); }
        .plane-icon { font-size:34px; }
        .plane-info { flex:1; }
        .plane-name { font-size:13px; font-weight:700; color:var(--text-primary); }
        .plane-stats { font-size:10px; color:var(--text-secondary); }
        .plane-price { font-size:13px; font-weight:800; color:var(--accent-gold); }
        .plane-price.owned { color:var(--accent-green); }
    </style>
</head>
<body>
<div class="game-container">
    <canvas id="gameCanvas"></canvas>

    <div class="hud" id="hud">
        <div class="hud-top">
            <div class="hud-left">
                <div class="hud-box hud-money">üí∞ $<span id="hudMoney">0</span></div>
                <div class="hud-box hud-xp">
                    <span>‚≠ê LVL <span id="hudLevel">1</span></span>
                    <div class="hud-xp-bar"><div class="hud-xp-fill" id="hudXpFill"></div></div>
                </div>
                <div class="hud-powerups">
                    <div class="hud-pw" id="pwShield">üõ°Ô∏è</div>
                    <div class="hud-pw" id="pwTurbo">‚ö°</div>
                </div>
            </div>
            <div class="hud-center">
                <div class="hud-mission" id="hudMission">
                    <div class="hud-mission-title">üìã –ú–∏—Å—Å–∏—è</div>
                    <div class="hud-mission-text" id="hudMissionText">–°–æ–±–µ—Ä–∏ 10 –¥–µ—Ç–∞–ª–µ–π</div>
                    <div class="hud-mission-progress"><div class="hud-mission-fill" id="hudMissionFill"></div></div>
                </div>
            </div>
            <div class="hud-right">
                <div class="hud-box" id="hudParts">üì¶ 0</div>
                <div class="hud-box" id="hudScore">üéØ 0</div>
            </div>
        </div>
    </div>

    <div class="boss-hud" id="bossHud">
        <div class="boss-name" id="bossName">‚ö†Ô∏è BOSS ‚ö†Ô∏è</div>
        <div class="boss-hp-bar"><div class="boss-hp-fill" id="bossHpFill"></div></div>
        <div class="boss-hp-text"><span id="bossHp">100</span>%</div>
    </div>

    <div class="music-toggle" id="musicToggle">üéµ</div>
    <div class="alert-popup" id="alertPopup"><div class="alert-icon" id="alertIcon">‚≠ê</div><div class="alert-text" id="alertText">LEGENDARY!</div></div>

    <!-- Main Menu -->
    <div class="screen main-menu active" id="mainMenu">
        <div class="menu-content">
            <div class="logo-badge">‚úàÔ∏è Season 1 ‚Ä¢ v4.0</div>
            <div class="logo-title">Aviation Parts<br>Runner</div>
            <div class="logo-subtitle">Aviation Service</div>

            <div class="stats-card">
                <div class="stats-top">
                    <div class="stats-money">$<span id="menuMoney">0</span></div>
                    <div class="stats-level">
                        <div class="stats-level-num" id="menuLevel">1</div>
                        <div class="stats-level-text">LVL</div>
                    </div>
                </div>
                <div class="stats-xp-bar"><div class="stats-xp-fill" id="menuXpFill"></div></div>
                <div class="stats-grid">
                    <div class="stats-item"><div class="stats-item-value" id="menuGames">0</div><div class="stats-item-label">–ò–≥—Ä</div></div>
                    <div class="stats-item"><div class="stats-item-value" id="menuParts">0</div><div class="stats-item-label">–î–µ—Ç–∞–ª–∏</div></div>
                    <div class="stats-item"><div class="stats-item-value" id="menuBosses">0</div><div class="stats-item-label">–ë–æ—Å—Å—ã</div></div>
                    <div class="stats-item"><div class="stats-item-value" id="menuWins">0</div><div class="stats-item-label">–ü–æ–±–µ–¥—ã</div></div>
                </div>
            </div>

            <div class="missions-card">
                <div class="missions-header">
                    <div class="missions-title">üìã –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –º–∏—Å—Å–∏–∏</div>
                    <div class="missions-timer" id="missionsTimer">23:59:59</div>
                </div>
                <div id="missionsList"></div>
            </div>

            <div class="menu-buttons">
                <button class="btn btn-primary" id="btnPlay">üöÄ –ù–∞—á–∞—Ç—å –ø–æ–ª—ë—Ç</button>
                <button class="btn btn-boss" id="btnBoss">üëπ –†–µ–∂–∏–º –ë–æ—Å—Å–∞</button>
                <div class="menu-row">
                    <button class="btn btn-pvp" id="btnPvp">‚öîÔ∏è PvP –î—É—ç–ª—å</button>
                    <button class="btn btn-battlepass" id="btnBattlePass">üéñÔ∏è Battle Pass</button>
                </div>
                <div class="menu-row">
                    <button class="btn btn-secondary" id="btnShop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
                    <button class="btn btn-secondary" id="btnLeaderboard">üèÜ –†–µ–π—Ç–∏–Ω–≥</button>
                </div>
            </div>
            <div class="menu-footer"><a href="https://jet-avia.ru" target="_blank">jet-avia.ru</a> ‚Ä¢ v4.0</div>
        </div>
    </div>

    <!-- Battle Pass -->
    <div class="screen" id="bpScreen">
        <div class="screen-header"><button class="btn-back" id="bpBack">‚Üê</button><div class="screen-title">üéñÔ∏è Battle Pass</div></div>
        <div class="bp-content">
            <div class="bp-header">
                <div class="bp-season">–°–µ–∑–æ–Ω 1</div>
                <div class="bp-title">Sky Warriors</div>
                <div class="bp-progress">
                    <div class="bp-level" id="bpLevel">1</div>
                    <div class="bp-bar"><div class="bp-bar-fill" id="bpBarFill"></div></div>
                    <div class="bp-xp"><span id="bpXp">0</span>/1000 XP</div>
                </div>
            </div>
            <div class="bp-tiers" id="bpTiers"></div>
        </div>
    </div>

    <!-- PvP -->
    <div class="screen" id="pvpScreen">
        <div class="screen-header"><button class="btn-back" id="pvpBack">‚Üê</button><div class="screen-title">‚öîÔ∏è PvP –î—É—ç–ª—å</div></div>
        <div class="pvp-content">
            <div class="pvp-header">
                <div class="pvp-title">‚öîÔ∏è –ê—Ä–µ–Ω–∞</div>
                <div class="pvp-subtitle">–°–æ—Ä–µ–≤–Ω—É–π—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –ø–∏–ª–æ—Ç–∞–º–∏!</div>
                <div class="pvp-stats">
                    <div class="pvp-stat"><div class="pvp-stat-value" id="pvpWins">0</div><div class="pvp-stat-label">–ü–æ–±–µ–¥</div></div>
                    <div class="pvp-stat"><div class="pvp-stat-value" id="pvpLosses">0</div><div class="pvp-stat-label">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</div></div>
                    <div class="pvp-stat"><div class="pvp-stat-value" id="pvpRank">-</div><div class="pvp-stat-label">–†–∞–Ω–≥</div></div>
                </div>
            </div>
            <div class="pvp-opponent" id="pvpOpponent">
                <div class="pvp-opponent-avatar">‚úàÔ∏è</div>
                <div class="pvp-opponent-info">
                    <div class="pvp-opponent-name" id="pvpOpponentName">–ü–æ–∏—Å–∫...</div>
                    <div class="pvp-opponent-score" id="pvpOpponentScore">–†–µ–∫–æ—Ä–¥: $0</div>
                    <div class="pvp-opponent-level" id="pvpOpponentLevel">–£—Ä–æ–≤–µ–Ω—å 1</div>
                </div>
            </div>
            <button class="btn btn-pvp" id="btnStartPvp" style="width:100%;">‚öîÔ∏è –ù–∞—á–∞—Ç—å –¥—É—ç–ª—å</button>
            <button class="btn btn-secondary" id="btnFindOpponent" style="width:100%;margin-top:10px;">üîÑ –ù–∞–π—Ç–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</button>
        </div>
    </div>

    <!-- Boss Mode -->
    <div class="screen" id="bossScreen">
        <div class="screen-header"><button class="btn-back" id="bossBack">‚Üê</button><div class="screen-title">üëπ –†–µ–∂–∏–º –ë–æ—Å—Å–∞</div></div>
        <div class="boss-content">
            <div class="boss-preview">üëπ</div>
            <div class="boss-info">
                <div class="boss-info-name" id="bossInfoName">Cargo Titan</div>
                <div class="boss-info-desc">–û–≥—Ä–æ–º–Ω—ã–π –≥—Ä—É–∑–æ–≤–æ–π —Å–∞–º–æ–ª—ë—Ç. –£–∫–ª–æ–Ω—è–π—Å—è –æ—Ç –∞—Ç–∞–∫ –∏ —Å–æ–±–∏—Ä–∞–π –¥–µ—Ç–∞–ª–∏ –¥–ª—è —É—Ä–æ–Ω–∞!</div>
            </div>
            <div class="boss-rewards">
                <div class="boss-reward-item"><div class="boss-reward-icon">üí∞</div><div class="boss-reward-text">x5 –¥–µ–Ω–µ–≥</div></div>
                <div class="boss-reward-item"><div class="boss-reward-icon">‚≠ê</div><div class="boss-reward-text">+500 XP</div></div>
                <div class="boss-reward-item"><div class="boss-reward-icon">üèÜ</div><div class="boss-reward-text">–¢—Ä–æ—Ñ–µ–π</div></div>
            </div>
            <button class="btn btn-boss" id="btnStartBoss" style="width:100%;">üëπ –°—Ä–∞–∑–∏—Ç—å—Å—è —Å –±–æ—Å—Å–æ–º</button>
        </div>
    </div>

    <!-- Shop -->
    <div class="screen" id="shopScreen">
        <div class="screen-header"><button class="btn-back" id="shopBack">‚Üê</button><div class="screen-title">üõí –ú–∞–≥–∞–∑–∏–Ω</div></div>
        <div class="shop-content">
            <div class="shop-section"><div class="shop-section-title">‚úàÔ∏è –°–∞–º–æ–ª—ë—Ç—ã</div><div id="planesList"></div></div>
            <div class="shop-section"><div class="shop-section-title">‚ö° –ê–ø–≥—Ä–µ–π–¥—ã</div><div class="shop-grid" id="upgradesList"></div></div>
        </div>
    </div>

    <!-- Leaderboard -->
    <div class="screen" id="lbScreen">
        <div class="screen-header"><button class="btn-back" id="lbBack">‚Üê</button><div class="screen-title">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</div></div>
        <div class="lb-content">
            <div class="lb-tabs">
                <button class="lb-tab active" data-tab="score">üèÜ –†–µ–∫–æ—Ä–¥</button>
                <button class="lb-tab" data-tab="money">üí∞ –î–µ–Ω—å–≥–∏</button>
            </div>
            <div class="lb-list" id="lbList"></div>
        </div>
    </div>

    <!-- Game Over -->
    <div class="screen gameover-screen" id="gameoverScreen">
        <div class="gameover-icon" id="goIcon">‚úàÔ∏è</div>
        <div class="gameover-title">–ü–æ–ª—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</div>
        <div class="gameover-money">$<span id="goMoney">0</span></div>
        <div class="gameover-xp">+<span id="goXp">0</span> XP</div>
        <div class="gameover-boss" id="goBoss" style="display:none;"><div class="gameover-boss-text" id="goBossText">üëπ –ë–æ—Å—Å –ø–æ–±–µ–∂–¥—ë–Ω!</div></div>
        <div class="gameover-stats">
            <div class="gameover-stat"><div class="gameover-stat-value" id="goParts">0</div><div class="gameover-stat-label">–î–µ—Ç–∞–ª–µ–π</div></div>
            <div class="gameover-stat"><div class="gameover-stat-value" id="goScore">0</div><div class="gameover-stat-label">–°—á—ë—Ç</div></div>
            <div class="gameover-stat"><div class="gameover-stat-value" id="goBest">$0</div><div class="gameover-stat-label">–†–µ–∫–æ—Ä–¥</div></div>
        </div>
        <div class="gameover-buttons">
            <button class="btn btn-primary" id="btnRetry">üîÑ –ï—â—ë —Ä–∞–∑</button>
            <button class="btn btn-secondary" id="btnShare">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            <button class="btn btn-secondary" id="btnHome">üè† –í –º–µ–Ω—é</button>
        </div>
    </div>
</div>

<script>
// ==========================================
// CONFIG
// ==========================================
const SUPABASE_URL='https://imqoksswffkufknkbofm.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltcW9rc3N3ZmZrdWZrbmtib2ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NzE2ODYsImV4cCI6MjA4MzA0NzY4Nn0.wcH5yZGRSzIkE0qjb_IIDSt3S-q3ylsBLJPT3Of-T78';

const PARTS=[
    {id:'oring',name:'O-Ring',icon:'‚≠ï',rarity:'common',value:10,chance:0.20,dmg:1},
    {id:'washer',name:'Washer',icon:'üîò',rarity:'common',value:20,chance:0.18,dmg:1},
    {id:'rivet',name:'Rivet',icon:'üìç',rarity:'common',value:30,chance:0.18,dmg:2},
    {id:'valve',name:'Valve',icon:'üîß',rarity:'uncommon',value:200,chance:0.12,dmg:3},
    {id:'filter',name:'Filter',icon:'üßΩ',rarity:'uncommon',value:300,chance:0.10,dmg:4},
    {id:'bearing',name:'Bearing',icon:'‚öôÔ∏è',rarity:'uncommon',value:500,chance:0.08,dmg:5},
    {id:'fuelpump',name:'Fuel Pump',icon:'‚õΩ',rarity:'rare',value:2000,chance:0.05,dmg:8},
    {id:'actuator',name:'Actuator',icon:'üîå',rarity:'rare',value:3000,chance:0.04,dmg:10},
    {id:'sensor',name:'Sensor',icon:'üì°',rarity:'rare',value:5000,chance:0.03,dmg:12},
    {id:'hmu',name:'HMU',icon:'üéõÔ∏è',rarity:'epic',value:20000,chance:0.012,dmg:20},
    {id:'starter',name:'Starter',icon:'‚ö°',rarity:'epic',value:30000,chance:0.008,dmg:25},
    {id:'apu',name:'APU',icon:'üîã',rarity:'legendary',value:100000,chance:0.003,dmg:50},
    {id:'engine',name:'Engine',icon:'üõ´',rarity:'legendary',value:200000,chance:0.002,dmg:100}
];

const PLANES=[
    {id:'cessna',name:'Cessna 172',icon:'üõ©Ô∏è',price:0,mult:1.0,desc:'–°—Ç–∞—Ä—Ç–æ–≤—ã–π'},
    {id:'boeing',name:'Boeing 737',icon:'‚úàÔ∏è',price:100000,mult:1.2,desc:'+20%'},
    {id:'airbus',name:'Airbus A320',icon:'üõ´',price:250000,mult:1.5,desc:'+50%'},
    {id:'jet',name:'Private Jet',icon:'üöÄ',price:500000,mult:2.0,desc:'x2'},
    {id:'fighter',name:'F-16 Fighter',icon:'üõ∏',price:1000000,mult:3.0,desc:'x3'}
];

const UPGRADES=[
    {id:'magnet',name:'–ú–∞–≥–Ω–∏—Ç',icon:'üß≤',price:10000,desc:'+50% —Ä–∞–¥–∏—É—Å'},
    {id:'shield',name:'–©–∏—Ç',icon:'üõ°Ô∏è',price:25000,desc:'1 –∑–∞—â–∏—Ç–∞'},
    {id:'turbo',name:'–¢—É—Ä–±–æ',icon:'‚ö°',price:15000,desc:'–£—Å–∫–æ—Ä–µ–Ω–∏–µ'},
    {id:'cargo',name:'Cargo+',icon:'üì¶',price:50000,desc:'+25% –¥–µ–Ω—å–≥–∏'},
    {id:'xpboost',name:'XP Boost',icon:'‚≠ê',price:75000,desc:'+50% –æ–ø—ã—Ç'}
];

const BOSSES=[
    {id:'cargo',name:'Cargo Titan',icon:'üëπ',hp:100,reward:5,xp:500},
    {id:'bomber',name:'Sky Bomber',icon:'üíÄ',hp:150,reward:8,xp:750},
    {id:'stealth',name:'Shadow Wing',icon:'üëø',hp:200,reward:12,xp:1000}
];

const BATTLE_PASS=[
    {tier:1,free:{type:'money',amount:1000,icon:'üí∞'},premium:{type:'skin',id:'gold',icon:'‚ú®'}},
    {tier:2,free:{type:'xp',amount:200,icon:'‚≠ê'},premium:{type:'money',amount:5000,icon:'üí∞'}},
    {tier:3,free:{type:'money',amount:2500,icon:'üí∞'},premium:{type:'plane',id:'fighter',icon:'üõ∏'}},
    {tier:4,free:{type:'xp',amount:500,icon:'‚≠ê'},premium:{type:'money',amount:10000,icon:'üí∞'}},
    {tier:5,free:{type:'money',amount:5000,icon:'üí∞'},premium:{type:'title',id:'ace',icon:'üèÜ'}},
];

const DAILY_MISSIONS=[
    {id:'collect_10',name:'–°–æ–±–µ—Ä–∏ 10 –¥–µ—Ç–∞–ª–µ–π',goal:10,type:'parts',reward:500,xp:50},
    {id:'collect_50',name:'–°–æ–±–µ—Ä–∏ 50 –¥–µ—Ç–∞–ª–µ–π',goal:50,type:'parts',reward:2000,xp:150},
    {id:'earn_5k',name:'–ó–∞—Ä–∞–±–æ—Ç–∞–π $5,000',goal:5000,type:'money',reward:1000,xp:100},
    {id:'play_3',name:'–°—ã–≥—Ä–∞–π 3 –∏–≥—Ä—ã',goal:3,type:'games',reward:750,xp:75},
    {id:'score_10k',name:'–ù–∞–±–µ—Ä–∏ 10,000 –æ—á–∫–æ–≤',goal:10000,type:'score',reward:1500,xp:120},
    {id:'boss_1',name:'–ü–æ–±–µ–¥–∏ –±–æ—Å—Å–∞',goal:1,type:'boss',reward:5000,xp:300},
    {id:'pvp_1',name:'–í—ã–∏–≥—Ä–∞–π PvP –¥—É—ç–ª—å',goal:1,type:'pvp',reward:3000,xp:200},
];

const CFG={
    PLAYER:{X:100,JUMP:-11,GRAVITY:0.5,MAX_V:14},
    OBS:{W:60,GAP:200,SPEED:4,SPAWN:100,MIN_H:90},
    PARTS:{SPAWN:45},
    DIFF:{INC:0.0004,MAX:3},
    MAGNET:90,SHIELD:200,TURBO:200,
    XP_PER_LEVEL:1000,
    BOSS_SPAWN:15000 // score threshold
};

// ==========================================
// STATE
// ==========================================
let W=400,H=700,safeTop=100;
let state='menu',money=0,parts=0,score=0,frame=0,speed=1,lastTime=0,deltaTime=16;
let player={x:0,y:0,v:0,rot:0};
let obstacles=[],items=[],particles=[],projectiles=[];
let shieldOn=false,shieldT=0,turboOn=false,turboT=0;
let gameMode='normal'; // normal, boss, pvp
let boss=null,bossActive=false;
let pvpOpponent=null,pvpTarget=0;
let currentMission=null,missionProgress=0;
let musicPlaying=false;

let stats=JSON.parse(localStorage.getItem('apr6'))||{
    money:0,xp:0,level:1,games:0,parts:0,best:0,bosses:0,pvpWins:0,pvpLosses:0,
    planes:['cessna'],plane:'cessna',upgrades:[],
    bpLevel:1,bpXp:0,bpClaimed:[],
    dailyMissions:[],lastMissionReset:null,
    missionProgress:{}
};

const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');

// ==========================================
// TELEGRAM & INIT
// ==========================================
function resize(){W=Math.max(window.innerWidth,360);H=Math.max(window.innerHeight,640);canvas.width=W;canvas.height=H;}
resize();window.addEventListener('resize',resize);

let tg=window.Telegram?.WebApp,tgUser={id:null,first_name:'–ü–∏–ª–æ—Ç',last_name:'',username:''};
if(tg){tg.ready();tg.expand();if(tg.safeAreaInset)safeTop=Math.max(100,tg.safeAreaInset.top+50);document.documentElement.style.setProperty('--safe-top',safeTop+'px');if(tg.initDataUnsafe?.user){const u=tg.initDataUnsafe.user;tgUser={id:u.id,first_name:u.first_name||'–ü–∏–ª–æ—Ç',last_name:u.last_name||'',username:u.username||''};}}

function vibrate(t='light'){if(tg?.HapticFeedback){if(t==='success')tg.HapticFeedback.notificationOccurred('success');else if(t==='error')tg.HapticFeedback.notificationOccurred('error');else if(t==='heavy')tg.HapticFeedback.impactOccurred('heavy');else tg.HapticFeedback.impactOccurred('light');}}

// ==========================================
// AUDIO ENGINE
// ==========================================
let audioCtx=null,masterGain=null,bgmOsc=null,bgmGain=null;

function initAudio(){
    if(audioCtx)return;
    try{
        audioCtx=new(window.AudioContext||window.webkitAudioContext)();
        masterGain=audioCtx.createGain();
        masterGain.gain.value=0.3;
        masterGain.connect(audioCtx.destination);
    }catch(e){}
}

function playBGM(){
    if(!audioCtx||bgmOsc)return;
    bgmGain=audioCtx.createGain();
    bgmGain.gain.value=0.08;
    bgmGain.connect(masterGain);
    
    // Simple ambient drone
    bgmOsc=audioCtx.createOscillator();
    bgmOsc.type='sine';
    bgmOsc.frequency.value=110;
    bgmOsc.connect(bgmGain);
    bgmOsc.start();
    
    // Add subtle modulation
    const lfo=audioCtx.createOscillator();
    const lfoGain=audioCtx.createGain();
    lfo.frequency.value=0.5;
    lfoGain.gain.value=5;
    lfo.connect(lfoGain);
    lfoGain.connect(bgmOsc.frequency);
    lfo.start();
    
    musicPlaying=true;
    $('musicToggle').classList.remove('muted');
}

function stopBGM(){
    if(bgmOsc){bgmOsc.stop();bgmOsc=null;bgmGain=null;}
    musicPlaying=false;
    $('musicToggle').classList.add('muted');
}

function toggleMusic(){
    initAudio();
    if(musicPlaying)stopBGM();else playBGM();
}

function playSound(type,freq=440,dur=0.1){
    if(!audioCtx)return;
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(masterGain);
    const now=audioCtx.currentTime;
    
    switch(type){
        case'jump':
            o.frequency.setValueAtTime(400,now);
            o.frequency.exponentialRampToValueAtTime(800,now+0.1);
            g.gain.setValueAtTime(0.15,now);
            g.gain.exponentialRampToValueAtTime(0.01,now+0.1);
            o.start(now);o.stop(now+0.1);
            break;
        case'collect':
            o.type='triangle';
            o.frequency.setValueAtTime(freq,now);
            o.frequency.exponentialRampToValueAtTime(freq*2,now+0.15);
            g.gain.setValueAtTime(0.12,now);
            g.gain.exponentialRampToValueAtTime(0.01,now+0.15);
            o.start(now);o.stop(now+0.15);
            break;
        case'crash':
            o.type='sawtooth';
            o.frequency.setValueAtTime(200,now);
            o.frequency.exponentialRampToValueAtTime(40,now+0.4);
            g.gain.setValueAtTime(0.2,now);
            g.gain.exponentialRampToValueAtTime(0.01,now+0.4);
            o.start(now);o.stop(now+0.4);
            break;
        case'boss':
            o.type='square';
            o.frequency.setValueAtTime(80,now);
            o.frequency.exponentialRampToValueAtTime(40,now+0.5);
            g.gain.setValueAtTime(0.15,now);
            g.gain.exponentialRampToValueAtTime(0.01,now+0.5);
            o.start(now);o.stop(now+0.5);
            break;
        case'bosshit':
            o.type='sawtooth';
            o.frequency.setValueAtTime(300,now);
            o.frequency.exponentialRampToValueAtTime(100,now+0.2);
            g.gain.setValueAtTime(0.2,now);
            g.gain.exponentialRampToValueAtTime(0.01,now+0.2);
            o.start(now);o.stop(now+0.2);
            break;
        case'victory':
            [523,659,784,1047].forEach((f,i)=>{
                const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();
                o2.connect(g2);g2.connect(masterGain);
                o2.frequency.value=f;
                g2.gain.setValueAtTime(0.1,now+i*0.15);
                g2.gain.exponentialRampToValueAtTime(0.01,now+i*0.15+0.3);
                o2.start(now+i*0.15);o2.stop(now+i*0.15+0.3);
            });
            return;
        case'levelup':
            [440,554,659,880].forEach((f,i)=>{
                const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();
                o2.type='triangle';
                o2.connect(g2);g2.connect(masterGain);
                o2.frequency.value=f;
                g2.gain.setValueAtTime(0.15,now+i*0.1);
                g2.gain.exponentialRampToValueAtTime(0.01,now+i*0.1+0.2);
                o2.start(now+i*0.1);o2.stop(now+i*0.1+0.2);
            });
            return;
    }
}

// ==========================================
// XP & LEVEL SYSTEM
// ==========================================
function addXp(amount){
    if(has('xpboost'))amount=Math.floor(amount*1.5);
    stats.xp+=amount;
    while(stats.xp>=CFG.XP_PER_LEVEL){
        stats.xp-=CFG.XP_PER_LEVEL;
        stats.level++;
        playSound('levelup');
        alert2('‚≠ê',`LEVEL ${stats.level}!`,'cyan');
    }
    stats.bpXp+=amount;
    while(stats.bpXp>=1000&&stats.bpLevel<BATTLE_PASS.length){
        stats.bpXp-=1000;
        stats.bpLevel++;
    }
    save();
}

function getXpProgress(){return stats.xp/CFG.XP_PER_LEVEL*100;}

// ==========================================
// DAILY MISSIONS
// ==========================================
function resetDailyMissions(){
    const today=new Date().toDateString();
    if(stats.lastMissionReset===today)return;
    
    // Pick 3 random missions
    const shuffled=[...DAILY_MISSIONS].sort(()=>Math.random()-0.5);
    stats.dailyMissions=shuffled.slice(0,3).map(m=>({...m,completed:false}));
    stats.missionProgress={};
    stats.lastMissionReset=today;
    save();
}

function updateMissionProgress(type,amount){
    stats.dailyMissions.forEach(m=>{
        if(m.completed||m.type!==type)return;
        stats.missionProgress[m.id]=(stats.missionProgress[m.id]||0)+amount;
        if(stats.missionProgress[m.id]>=m.goal){
            m.completed=true;
            stats.money+=m.reward;
            addXp(m.xp);
            alert2('‚úÖ',`–ú–∏—Å—Å–∏—è: +$${m.reward}`,'green');
            vibrate('success');
        }
    });
    save();
}

function renderMissions(){
    const list=$('missionsList');
    if(!stats.dailyMissions.length){resetDailyMissions();}
    list.innerHTML=stats.dailyMissions.map(m=>{
        const prog=Math.min(stats.missionProgress[m.id]||0,m.goal);
        const pct=prog/m.goal*100;
        return`<div class="mission-item ${m.completed?'completed':''}">
            <div class="mission-icon">${m.completed?'‚úÖ':'üìã'}</div>
            <div class="mission-info">
                <div class="mission-name">${m.name}</div>
                <div class="mission-progress"><div class="mission-progress-fill" style="width:${pct}%"></div></div>
            </div>
            <div class="mission-reward">${m.completed?'‚úì':'+$'+m.reward}</div>
        </div>`;
    }).join('');
}

// ==========================================
// BATTLE PASS
// ==========================================
function renderBattlePass(){
    $('bpLevel').textContent=stats.bpLevel;
    $('bpXp').textContent=stats.bpXp;
    $('bpBarFill').style.width=(stats.bpXp/1000*100)+'%';
    
    $('bpTiers').innerHTML=BATTLE_PASS.map(t=>{
        const unlocked=stats.bpLevel>=t.tier;
        const current=stats.bpLevel===t.tier;
        const freeClaimed=stats.bpClaimed.includes(`free_${t.tier}`);
        const premClaimed=stats.bpClaimed.includes(`prem_${t.tier}`);
        
        return`<div class="bp-tier ${unlocked?'unlocked':''} ${current?'current':''}">
            <div class="bp-tier-num">${t.tier}</div>
            <div class="bp-tier-rewards">
                <div class="bp-reward ${freeClaimed?'claimed':''}" data-tier="${t.tier}" data-type="free">
                    <div class="bp-reward-icon">${t.free.icon}</div>
                    <div class="bp-reward-text">${freeClaimed?'‚úì':t.free.type==='money'?'$'+t.free.amount:'+'+t.free.amount+' XP'}</div>
                </div>
                <div class="bp-reward premium ${premClaimed?'claimed':''}" data-tier="${t.tier}" data-type="premium">
                    <div class="bp-reward-icon">${t.premium.icon}</div>
                    <div class="bp-reward-text">${premClaimed?'‚úì':'Premium'}</div>
                </div>
            </div>
        </div>`;
    }).join('');
}

// ==========================================
// PVP SYSTEM
// ==========================================
async function findOpponent(){
    $('pvpOpponentName').textContent='–ü–æ–∏—Å–∫...';
    $('pvpOpponentScore').textContent='';
    $('pvpOpponentLevel').textContent='';
    
    try{
        const data=await fetchLeaderboard('best_score');
        if(data?.length){
            const filtered=data.filter(p=>p.telegram_id!==tgUser.id);
            if(filtered.length){
                pvpOpponent=filtered[Math.floor(Math.random()*Math.min(filtered.length,10))];
                $('pvpOpponentName').textContent=[pvpOpponent.first_name,pvpOpponent.last_name].filter(Boolean).join(' ')||'–ü–∏–ª–æ—Ç';
                $('pvpOpponentScore').textContent=`–†–µ–∫–æ—Ä–¥: $${pvpOpponent.best_score.toLocaleString()}`;
                $('pvpOpponentLevel').textContent=`–£—Ä–æ–≤–µ–Ω—å ${Math.floor(pvpOpponent.total_games/10)+1}`;
                pvpTarget=pvpOpponent.best_score;
                return;
            }
        }
    }catch(e){}
    
    // Fallback bot
    pvpOpponent={first_name:'Bot',best_score:5000+Math.floor(Math.random()*10000)};
    $('pvpOpponentName').textContent='ü§ñ Bot Pilot';
    $('pvpOpponentScore').textContent=`–†–µ–∫–æ—Ä–¥: $${pvpOpponent.best_score.toLocaleString()}`;
    $('pvpOpponentLevel').textContent='–£—Ä–æ–≤–µ–Ω—å '+Math.floor(Math.random()*10+1);
    pvpTarget=pvpOpponent.best_score;
}

// ==========================================
// BOSS SYSTEM
// ==========================================
function spawnBoss(){
    const b=BOSSES[Math.min(Math.floor(stats.bosses/3),BOSSES.length-1)];
    boss={...b,currentHp:b.hp,x:W-100,y:H/2,phase:0,attackTimer:0};
    bossActive=true;
    $('bossHud').classList.add('show');
    $('bossName').textContent=`‚ö†Ô∏è ${b.name} ‚ö†Ô∏è`;
    updateBossHp();
    playSound('boss');
    vibrate('heavy');
}

function updateBossHp(){
    if(!boss)return;
    const pct=boss.currentHp/boss.hp*100;
    $('bossHpFill').style.width=pct+'%';
    $('bossHp').textContent=Math.ceil(pct);
}

function damageBoss(dmg){
    if(!boss)return;
    boss.currentHp-=dmg;
    updateBossHp();
    playSound('bosshit');
    vibrate('light');
    
    // Screen shake effect
    canvas.style.transform=`translate(${(Math.random()-0.5)*10}px,${(Math.random()-0.5)*10}px)`;
    setTimeout(()=>canvas.style.transform='',50);
    
    if(boss.currentHp<=0){
        defeatBoss();
    }
}

function defeatBoss(){
    bossActive=false;
    stats.bosses++;
    const reward=boss.reward;
    money+=money*reward;
    addXp(boss.xp);
    updateMissionProgress('boss',1);
    $('bossHud').classList.remove('show');
    playSound('victory');
    alert2('üèÜ',`–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù! x${reward}`,'gold');
    vibrate('success');
    boss=null;
}

function updateBoss(){
    if(!boss||!bossActive)return;
    
    // Boss movement
    boss.y+=Math.sin(frame*0.03)*2;
    boss.attackTimer++;
    
    // Attack pattern
    if(boss.attackTimer>120){
        boss.attackTimer=0;
        // Spawn projectile
        projectiles.push({
            x:boss.x-30,
            y:boss.y,
            vx:-8,
            vy:(player.y-boss.y)*0.02
        });
        playSound('collect',100,0.1);
    }
}

function drawBoss(){
    if(!boss)return;
    ctx.save();
    ctx.translate(boss.x,boss.y);
    
    // Glow effect
    ctx.shadowColor='#e74c3c';
    ctx.shadowBlur=30+Math.sin(frame*0.1)*10;
    
    // Boss sprite
    ctx.font='80px Arial';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(boss.icon,0,0);
    
    ctx.shadowBlur=0;
    ctx.restore();
}

function updateProjectiles(){
    for(let i=projectiles.length-1;i>=0;i--){
        const p=projectiles[i];
        p.x+=p.vx*(deltaTime/16);
        p.y+=p.vy*(deltaTime/16);
        
        // Check collision with player
        const dx=player.x-p.x,dy=player.y-p.y;
        if(Math.sqrt(dx*dx+dy*dy)<40){
            if(shieldOn){
                shieldOn=false;shieldT=0;
                vibrate('heavy');
            }else{
                gameOver();
                return;
            }
            projectiles.splice(i,1);
            continue;
        }
        
        if(p.x<-50)projectiles.splice(i,1);
    }
}

function drawProjectiles(){
    ctx.fillStyle='#e74c3c';
    projectiles.forEach(p=>{
        ctx.beginPath();
        ctx.arc(p.x,p.y,12,0,Math.PI*2);
        ctx.fill();
        ctx.fillStyle='#ff6b6b';
        ctx.beginPath();
        ctx.arc(p.x,p.y,6,0,Math.PI*2);
        ctx.fill();
        ctx.fillStyle='#e74c3c';
    });
}

// ==========================================
// GAME LOGIC
// ==========================================
function has(id){return stats.upgrades.includes(id);}
function planeMult(){return(PLANES.find(p=>p.id===stats.plane)||{mult:1}).mult;}
function moneyMult(){let m=planeMult();if(has('cargo'))m*=1.25;if(gameMode==='boss'&&boss)m*=2;return m;}
function magnetR(){return CFG.MAGNET*(has('magnet')?1.5:1);}

function reset(){
    W=canvas.width||400;H=canvas.height||700;
    player={x:CFG.PLAYER.X,y:H/2,v:0,rot:0};
    obstacles=[];items=[];particles=[];projectiles=[];
    money=0;parts=0;score=0;frame=0;speed=1;
    shieldOn=has('shield');shieldT=shieldOn?CFG.SHIELD:0;
    turboOn=false;turboT=0;
    boss=null;bossActive=false;
    $('bossHud').classList.remove('show');
    
    // Pick active mission for HUD
    currentMission=stats.dailyMissions.find(m=>!m.completed)||null;
    missionProgress=currentMission?stats.missionProgress[currentMission.id]||0:0;
    updHud();
}

function start(mode='normal'){
    initAudio();
    playBGM();
    resize();
    gameMode=mode;
    reset();
    
    if(mode==='boss'){
        setTimeout(()=>spawnBoss(),2000);
    }
    
    state='playing';
    show(null);
    $('hud').classList.add('visible');
}

function gameOver(){
    state='over';
    stopBGM();
    playSound('crash');
    vibrate('error');
    
    const earnedMoney=Math.floor(money*moneyMult());
    const earnedXp=Math.floor(parts*10+score/100);
    
    stats.games++;
    stats.parts+=parts;
    stats.money+=earnedMoney;
    if(earnedMoney>stats.best)stats.best=earnedMoney;
    
    addXp(earnedXp);
    updateMissionProgress('parts',parts);
    updateMissionProgress('money',earnedMoney);
    updateMissionProgress('games',1);
    updateMissionProgress('score',score);
    
    // PvP result
    if(gameMode==='pvp'&&pvpOpponent){
        if(earnedMoney>pvpTarget){
            stats.pvpWins++;
            updateMissionProgress('pvp',1);
            $('goIcon').textContent='üèÜ';
            alert2('‚öîÔ∏è','–ü–û–ë–ï–î–ê –í –î–£–≠–õ–ò!','gold');
        }else{
            stats.pvpLosses++;
            $('goIcon').textContent='üíÄ';
        }
    }else{
        $('goIcon').textContent='‚úàÔ∏è';
    }
    
    save();
    submitScore(earnedMoney,earnedMoney);
    
    $('goMoney').textContent=earnedMoney.toLocaleString();
    $('goXp').textContent=earnedXp;
    $('goParts').textContent=parts;
    $('goScore').textContent=score.toLocaleString();
    $('goBest').textContent='$'+fmt(stats.best);
    
    if(gameMode==='boss'&&!bossActive&&stats.bosses>0){
        $('goBoss').style.display='block';
        $('goBossText').textContent='üëπ –ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω! x'+boss?.reward||5;
    }else{
        $('goBoss').style.display='none';
    }
    
    $('hud').classList.remove('visible');
    $('bossHud').classList.remove('show');
    show('gameoverScreen');
    
    // Explosion particles
    for(let i=0;i<20;i++){
        particles.push({x:player.x,y:player.y,vx:(Math.random()-0.5)*15,vy:(Math.random()-0.5)*15,size:Math.random()*6+2,color:`hsl(${Math.random()*60},100%,50%)`,life:1});
    }
}

function jump(){if(state!=='playing')return;player.v=CFG.PLAYER.JUMP;playSound('jump');vibrate('light');}
function turbo(){if(!has('turbo')||turboOn)return;turboOn=true;turboT=CFG.TURBO;vibrate('heavy');}

function spawnObs(){
    const gap=CFG.OBS.GAP-(speed-1)*20;
    const minT=safeTop+CFG.OBS.MIN_H;
    const maxT=H-gap-CFG.OBS.MIN_H-80;
    const top=Math.random()*(maxT-minT)+minT;
    obstacles.push({x:W,top,bot:top+gap,pass:false});
}

function spawnPart(){
    let r=Math.random(),c=0,d=PARTS[0];
    for(const p of PARTS){c+=p.chance;if(r<c){d=p;break;}}
    const y=safeTop+100+Math.random()*(H-safeTop-200);
    items.push({x:W+50,y,...d,col:false});
    if(d.rarity==='legendary'){alert2('‚≠ê','LEGENDARY!','gold');vibrate('heavy');}
    else if(d.rarity==='epic')alert2('üíé','EPIC!','purple');
}

function updPlayer(){
    const dt=deltaTime/16;
    player.v+=CFG.PLAYER.GRAVITY*dt;
    player.v=Math.min(player.v,CFG.PLAYER.MAX_V);
    player.y+=player.v*dt;
    player.rot=Math.min(Math.max(player.v*0.05,-0.4),0.6);
    if(player.y<safeTop+40){player.y=safeTop+40;player.v=0;}
    if(player.y>H-80){
        if(shieldOn){player.y=H-80;player.v=CFG.PLAYER.JUMP;shieldOn=false;shieldT=0;vibrate('heavy');}
        else gameOver();
    }
}

function updObs(){
    const sp=CFG.OBS.SPEED*speed*(turboOn?1.5:1)*(deltaTime/16);
    const rate=Math.max(Math.floor(CFG.OBS.SPAWN/speed),40);
    if(frame%rate===0&&!bossActive)spawnObs();
    
    for(let i=obstacles.length-1;i>=0;i--){
        const o=obstacles[i];
        o.x-=sp;
        if(!o.pass&&player.x+30>o.x&&player.x-30<o.x+CFG.OBS.W){
            if(player.y-20<o.top||player.y+20>o.bot){
                if(shieldOn){shieldOn=false;shieldT=0;vibrate('heavy');}
                else{gameOver();return;}
            }
        }
        if(!o.pass&&o.x+CFG.OBS.W<player.x){
            o.pass=true;
            score+=100;
        }
        if(o.x<-CFG.OBS.W)obstacles.splice(i,1);
    }
    
    // Boss spawn check
    if(gameMode==='normal'&&score>=CFG.BOSS_SPAWN&&!bossActive&&!boss){
        spawnBoss();
    }
}

function updParts(){
    const sp=CFG.OBS.SPEED*speed*(turboOn?1.5:1)*(deltaTime/16);
    if(frame%CFG.PARTS.SPAWN===0)spawnPart();
    const mr=magnetR();
    
    for(let i=items.length-1;i>=0;i--){
        const p=items[i];
        p.x-=sp;
        if(!p.col){
            const dx=player.x-p.x,dy=player.y-p.y,d=Math.sqrt(dx*dx+dy*dy);
            if(d<mr&&d>35){const f=(mr-d)/mr*0.25;p.x+=dx*f;p.y+=dy*f;}
            if(d<40){
                p.col=true;
                money+=p.value;
                parts++;
                score+=p.value;
                
                // Damage boss with collected parts
                if(bossActive&&boss){
                    damageBoss(p.dmg);
                }
                
                updHud();
                popup(p);
                
                const freq={common:600,uncommon:800,rare:1000,epic:1200,legendary:1500}[p.rarity];
                playSound('collect',freq);
                vibrate('light');
                
                for(let j=0;j<6;j++){
                    const a=(j/6)*Math.PI*2;
                    particles.push({x:p.x,y:p.y,vx:Math.cos(a)*5,vy:Math.sin(a)*5,size:4,color:rColor(p.rarity),life:0.7});
                }
            }
        }
        if(p.x<-50||p.col)items.splice(i,1);
    }
}

function updTimers(){
    if(shieldOn&&shieldT>0)shieldT--;
    if(turboOn&&turboT>0){turboT--;if(turboT<=0)turboOn=false;}
    if(speed<CFG.DIFF.MAX)speed+=CFG.DIFF.INC;
}

function updParticles(){
    for(let i=particles.length-1;i>=0;i--){
        const p=particles[i];
        p.x+=p.vx*(deltaTime/16);
        p.y+=p.vy*(deltaTime/16);
        p.vy+=0.2;
        p.life-=0.025;
        p.size*=0.96;
        if(p.life<=0)particles.splice(i,1);
    }
}

// ==========================================
// WEBGL-STYLE DRAWING (Canvas 2D with effects)
// ==========================================
function drawBg(){
    // Gradient sky
    const g=ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#050510');
    g.addColorStop(0.3,'#0a0a20');
    g.addColorStop(0.6,'#151530');
    g.addColorStop(1,'#1a1a40');
    ctx.fillStyle=g;
    ctx.fillRect(0,0,W,H);
    
    // Stars with twinkle
    ctx.fillStyle='rgba(255,255,255,0.6)';
    for(let i=0;i<60;i++){
        const x=(i*73+frame*0.02)%W;
        const y=(i*47)%(H*0.6);
        const twinkle=0.3+Math.sin(frame*0.05+i)*0.3;
        ctx.globalAlpha=twinkle;
        ctx.beginPath();
        ctx.arc(x,y,1+Math.random(),0,Math.PI*2);
        ctx.fill();
    }
    ctx.globalAlpha=1;
    
    // Nebula effect
    ctx.fillStyle='rgba(74,108,247,0.03)';
    ctx.beginPath();
    ctx.arc(W*0.7,H*0.3,200,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle='rgba(155,89,182,0.03)';
    ctx.beginPath();
    ctx.arc(W*0.3,H*0.6,150,0,Math.PI*2);
    ctx.fill();
    
    // Moon with glow
    ctx.shadowColor='rgba(255,255,230,0.5)';
    ctx.shadowBlur=40;
    ctx.fillStyle='rgba(255,255,230,0.95)';
    ctx.beginPath();
    ctx.arc(W-60,80,30,0,Math.PI*2);
    ctx.fill();
    ctx.shadowBlur=0;
    
    // Ground
    const groundG=ctx.createLinearGradient(0,H-80,0,H);
    groundG.addColorStop(0,'#1a2a3a');
    groundG.addColorStop(1,'#0a1520');
    ctx.fillStyle=groundG;
    ctx.fillRect(0,H-70,W,70);
    
    // Road lines with glow
    ctx.shadowColor='rgba(255,255,255,0.3)';
    ctx.shadowBlur=5;
    ctx.fillStyle='rgba(255,255,255,0.4)';
    const off=(frame*4*speed)%100;
    for(let x=-off;x<W+100;x+=100){
        ctx.fillRect(x,H-40,50,4);
    }
    ctx.shadowBlur=0;
}

function drawPlayer(){
    ctx.save();
    ctx.translate(player.x,player.y);
    const bob=Math.sin(frame*0.1)*4;
    ctx.rotate(player.rot);
    ctx.translate(0,bob);
    
    // Shield effect
    if(shieldOn){
        ctx.strokeStyle=`rgba(0,212,255,${0.4+Math.sin(frame*0.15)*0.2})`;
        ctx.lineWidth=4;
        ctx.shadowColor='#00d4ff';
        ctx.shadowBlur=20;
        ctx.beginPath();
        ctx.arc(0,0,55,0,Math.PI*2);
        ctx.stroke();
        ctx.shadowBlur=0;
    }
    
    // Turbo effect
    if(turboOn){
        ctx.shadowColor='#00d4ff';
        ctx.shadowBlur=40;
    }
    
    // Player glow
    ctx.shadowColor='rgba(255,200,100,0.5)';
    ctx.shadowBlur=20;
    
    const icon=(PLANES.find(p=>p.id===stats.plane)||{icon:'‚úàÔ∏è'}).icon;
    ctx.font='55px Arial';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(icon,0,0);
    ctx.shadowBlur=0;
    
    // Engine trail
    if(state==='playing'&&frame%2===0){
        particles.push({
            x:player.x-45,y:player.y+bob,
            vx:-3-Math.random()*2,vy:(Math.random()-0.5)*2,
            size:5+Math.random()*4,
            color:turboOn?'rgba(0,212,255,0.7)':'rgba(255,150,50,0.6)',
            life:0.5
        });
    }
    
    ctx.restore();
}

function drawObs(){
    obstacles.forEach(o=>{
        // Pipe gradient
        const g=ctx.createLinearGradient(o.x,0,o.x+CFG.OBS.W,0);
        g.addColorStop(0,'#1a3a5c');
        g.addColorStop(0.5,'#2a5a8c');
        g.addColorStop(1,'#1a3a5c');
        ctx.fillStyle=g;
        
        // Top pipe
        ctx.fillRect(o.x,0,CFG.OBS.W,o.top);
        // Bottom pipe
        ctx.fillRect(o.x,o.bot,CFG.OBS.W,H-o.bot);
        
        // Pipe caps with glow
        ctx.shadowColor='rgba(74,124,204,0.5)';
        ctx.shadowBlur=10;
        ctx.fillStyle='#4a7ccc';
        ctx.fillRect(o.x-6,o.top-22,CFG.OBS.W+12,22);
        ctx.fillRect(o.x-6,o.bot,CFG.OBS.W+12,22);
        ctx.shadowBlur=0;
        
        // Warning lights
        if(Math.floor(frame/25)%2===0){
            ctx.fillStyle='#ff4444';
            ctx.shadowColor='#ff4444';
            ctx.shadowBlur=15;
            ctx.beginPath();
            ctx.arc(o.x+CFG.OBS.W/2,o.top-11,5,0,Math.PI*2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(o.x+CFG.OBS.W/2,o.bot+11,5,0,Math.PI*2);
            ctx.fill();
            ctx.shadowBlur=0;
        }
    });
}

function drawParts(){
    items.forEach(p=>{
        if(p.col)return;
        ctx.save();
        ctx.translate(p.x,p.y);
        const pulse=1+Math.sin(frame*0.12)*0.12;
        ctx.scale(pulse,pulse);
        
        // Glow based on rarity
        const glows={common:'rgba(150,150,150,0.4)',uncommon:'rgba(46,204,113,0.6)',rare:'rgba(74,108,247,0.7)',epic:'rgba(155,89,182,0.8)',legendary:'rgba(240,185,11,1)'};
        const bgs={common:'#4a4a4a',uncommon:'#27ae60',rare:'#3498db',epic:'#9b59b6',legendary:'#f39c12'};
        
        ctx.shadowColor=glows[p.rarity];
        ctx.shadowBlur=p.rarity==='legendary'?35:20;
        
        ctx.fillStyle=bgs[p.rarity];
        ctx.beginPath();
        ctx.arc(0,0,22,0,Math.PI*2);
        ctx.fill();
        
        ctx.shadowBlur=0;
        ctx.font='20px Arial';
        ctx.textAlign='center';
        ctx.textBaseline='middle';
        ctx.fillText(p.icon,0,0);
        ctx.restore();
        
        // Value label for non-common
        if(p.rarity!=='common'){
            ctx.font='bold 9px Inter';
            ctx.textAlign='center';
            ctx.fillStyle=rColor(p.rarity);
            ctx.fillText('$'+fmt(p.value),p.x,p.y+32);
        }
    });
}

function drawParticles(){
    particles.forEach(p=>{
        ctx.globalAlpha=p.life;
        ctx.fillStyle=p.color;
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
        ctx.fill();
    });
    ctx.globalAlpha=1;
}

// ==========================================
// HUD & UI
// ==========================================
function updHud(){
    $('hudMoney').textContent=money.toLocaleString();
    $('hudParts').textContent='üì¶ '+parts;
    $('hudScore').textContent='üéØ '+score.toLocaleString();
    $('hudLevel').textContent=stats.level;
    $('hudXpFill').style.width=getXpProgress()+'%';
    $('pwShield').classList.toggle('active',shieldOn);
    $('pwTurbo').classList.toggle('active',turboOn);
    
    if(currentMission){
        $('hudMissionText').textContent=currentMission.name;
        const prog=Math.min(stats.missionProgress[currentMission.id]||0,currentMission.goal);
        $('hudMissionFill').style.width=(prog/currentMission.goal*100)+'%';
    }
}

function updMenu(){
    $('menuMoney').textContent=stats.money.toLocaleString();
    $('menuLevel').textContent=stats.level;
    $('menuXpFill').style.width=getXpProgress()+'%';
    $('menuGames').textContent=stats.games;
    $('menuParts').textContent=stats.parts;
    $('menuBosses').textContent=stats.bosses;
    $('menuWins').textContent=stats.pvpWins;
    $('pvpWins').textContent=stats.pvpWins;
    $('pvpLosses').textContent=stats.pvpLosses;
    $('pvpRank').textContent=stats.pvpWins>10?'Gold':stats.pvpWins>5?'Silver':'Bronze';
    renderMissions();
}

function renderShop(){
    $('planesList').innerHTML=PLANES.map(p=>{
        const own=stats.planes.includes(p.id),sel=stats.plane===p.id;
        return`<div class="plane-item ${own?'owned':''} ${sel?'selected':''}" data-plane="${p.id}">
            <div class="plane-icon">${p.icon}</div>
            <div class="plane-info"><div class="plane-name">${p.name}</div><div class="plane-stats">${p.desc}</div></div>
            <div class="plane-price ${own?'owned':''}">${own?(sel?'‚úì':'–í—ã–±—Ä–∞—Ç—å'):'$'+p.price.toLocaleString()}</div>
        </div>`;
    }).join('');
    
    $('upgradesList').innerHTML=UPGRADES.map(u=>{
        const own=has(u.id);
        return`<div class="shop-item ${own?'owned':''}" data-upg="${u.id}">
            <div class="shop-item-icon">${u.icon}</div>
            <div class="shop-item-name">${u.name}</div>
            <div class="shop-item-desc">${u.desc}</div>
            <div class="shop-item-price ${own?'owned':''}">${own?'‚úì':'$'+u.price.toLocaleString()}</div>
        </div>`;
    }).join('');
    
    // Event listeners
    document.querySelectorAll('[data-plane]').forEach(el=>{
        el.onclick=()=>{
            const id=el.dataset.plane,pl=PLANES.find(p=>p.id===id);
            if(stats.planes.includes(id)){stats.plane=id;save();renderShop();}
            else if(stats.money>=pl.price){stats.money-=pl.price;stats.planes.push(id);stats.plane=id;save();renderShop();updMenu();vibrate('success');}
        };
    });
    document.querySelectorAll('[data-upg]').forEach(el=>{
        el.onclick=()=>{
            const id=el.dataset.upg,u=UPGRADES.find(x=>x.id===id);
            if(!has(id)&&stats.money>=u.price){stats.money-=u.price;stats.upgrades.push(id);save();renderShop();updMenu();vibrate('success');}
        };
    });
}

// ==========================================
// LEADERBOARD
// ==========================================
async function fetchLeaderboard(sortBy='best_score'){
    try{
        const res=await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=*&order=${sortBy}.desc&limit=50`,{
            headers:{'apikey':SUPABASE_KEY,'Authorization':`Bearer ${SUPABASE_KEY}`,'Content-Type':'application/json'}
        });
        if(res.ok)return await res.json();
    }catch(e){}
    return[];
}

async function submitScore(score,money){
    if(!tgUser.id)return;
    try{
        const check=await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?telegram_id=eq.${tgUser.id}&select=*`,{headers:{'apikey':SUPABASE_KEY,'Authorization':`Bearer ${SUPABASE_KEY}`}});
        const existing=await check.json();
        const data={first_name:tgUser.first_name,last_name:tgUser.last_name,username:tgUser.username,best_score:score,total_money:stats.money,total_parts:stats.parts,total_games:stats.games,rfq_completed:stats.bosses,current_plane:stats.plane};
        if(existing?.length>0){
            data.best_score=Math.max(existing[0].best_score,score);
            await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?telegram_id=eq.${tgUser.id}`,{method:'PATCH',headers:{'apikey':SUPABASE_KEY,'Authorization':`Bearer ${SUPABASE_KEY}`,'Content-Type':'application/json','Prefer':'return=minimal'},body:JSON.stringify(data)});
        }else{
            data.telegram_id=tgUser.id;
            await fetch(`${SUPABASE_URL}/rest/v1/leaderboard`,{method:'POST',headers:{'apikey':SUPABASE_KEY,'Authorization':`Bearer ${SUPABASE_KEY}`,'Content-Type':'application/json','Prefer':'return=minimal'},body:JSON.stringify(data)});
        }
    }catch(e){}
}

let currentLbSort='best_score';
async function renderLeaderboard(sortBy=currentLbSort){
    currentLbSort=sortBy;
    const list=$('lbList');
    list.innerHTML='<div class="lb-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    document.querySelectorAll('.lb-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===(sortBy==='best_score'?'score':'money')));
    const data=await fetchLeaderboard(sortBy);
    if(!data?.length){list.innerHTML='<div class="lb-empty">üèÜ –ë—É–¥—å –ø–µ—Ä–≤—ã–º!</div>';return;}
    list.innerHTML=data.map((p,i)=>{
        const name=[p.first_name,p.last_name].filter(Boolean).join(' ')||'–ü–∏–ª–æ—Ç';
        const isMe=tgUser.id&&p.telegram_id===tgUser.id;
        const rankClass=i===0?'gold':i===1?'silver':i===2?'bronze':'';
        const planeIcon=(PLANES.find(pl=>pl.id===p.current_plane)||PLANES[0]).icon;
        const val=sortBy==='best_score'?p.best_score.toLocaleString():'$'+fmt(p.total_money);
        return`<div class="lb-item ${isMe?'me':''}"><div class="lb-rank ${rankClass}">${i+1}</div><div class="lb-avatar">${planeIcon}</div><div class="lb-info"><div class="lb-name">${name}${isMe?' (–≤—ã)':''}</div><div class="lb-stats">üéÆ ${p.total_games} ‚Ä¢ üëπ ${p.rfq_completed||0}</div></div><div class="lb-score">${val}</div></div>`;
    }).join('');
}

// ==========================================
// UTILITIES
// ==========================================
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));if(id)$(id).classList.add('active');}
function alert2(icon,text,color='gold'){const el=$('alertPopup');$('alertIcon').textContent=icon;$('alertText').textContent=text;const colors={gold:'#f0b90b',green:'#2ecc71',cyan:'#00d4ff',purple:'#9b59b6',red:'#e74c3c'};el.style.borderColor=colors[color]||colors.gold;$('alertText').style.color=el.style.borderColor;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1800);}
function popup(p){const el=document.createElement('div');el.className='part-popup';el.style.left=p.x+'px';el.style.top=(p.y-30)+'px';el.style.color=rColor(p.rarity);el.textContent='+$'+p.value.toLocaleString();document.querySelector('.game-container').appendChild(el);setTimeout(()=>el.remove(),1000);}
function rColor(r){return{common:'#9ca3af',uncommon:'#2ecc71',rare:'#4a6cf7',epic:'#9b59b6',legendary:'#f0b90b'}[r]||'#fff';}
function fmt(n){if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(0)+'K';return n.toString();}
function save(){localStorage.setItem('apr6',JSON.stringify(stats));}
const $=id=>document.getElementById(id);

// ==========================================
// GAME LOOP
// ==========================================
function loop(ts){
    deltaTime=lastTime?Math.min(ts-lastTime,32):16;
    lastTime=ts;
    
    drawBg();
    
    if(state==='playing'||state==='over'){
        drawObs();
        drawParts();
        if(bossActive)drawBoss();
        drawProjectiles();
        drawPlayer();
    }
    drawParticles();
    
    if(state==='playing'){
        updPlayer();
        updObs();
        updParts();
        updTimers();
        updParticles();
        if(bossActive){
            updateBoss();
            updateProjectiles();
        }
        updHud();
    }
    
    frame++;
    requestAnimationFrame(loop);
}

// ==========================================
// EVENTS
// ==========================================
canvas.addEventListener('click',jump);
canvas.addEventListener('touchstart',e=>{e.preventDefault();jump();});
document.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();jump();}if(e.code==='KeyT')turbo();});
let lastTap=0;canvas.addEventListener('touchend',()=>{const now=Date.now();if(now-lastTap<300)turbo();lastTap=now;});

$('btnPlay').onclick=()=>start('normal');
$('btnBoss').onclick=()=>show('bossScreen');
$('btnPvp').onclick=()=>{findOpponent();show('pvpScreen');};
$('btnBattlePass').onclick=()=>{renderBattlePass();show('bpScreen');};
$('btnShop').onclick=()=>{renderShop();show('shopScreen');};
$('btnLeaderboard').onclick=()=>{renderLeaderboard();show('lbScreen');};

$('bpBack').onclick=()=>{show('mainMenu');updMenu();};
$('pvpBack').onclick=()=>{show('mainMenu');updMenu();};
$('bossBack').onclick=()=>{show('mainMenu');updMenu();};
$('shopBack').onclick=()=>{show('mainMenu');updMenu();};
$('lbBack').onclick=()=>{show('mainMenu');updMenu();};

$('btnStartBoss').onclick=()=>start('boss');
$('btnStartPvp').onclick=()=>start('pvp');
$('btnFindOpponent').onclick=findOpponent;

$('btnRetry').onclick=()=>start(gameMode);
$('btnShare').onclick=()=>{
    const text=`‚úàÔ∏è Aviation Parts Runner v4.0\nüèÜ –ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: $${$('goMoney').textContent}\nüëπ –ë–æ—Å—Å–æ–≤: ${stats.bosses}\n‚öîÔ∏è PvP –ø–æ–±–µ–¥: ${stats.pvpWins}`;
    if(tg)tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/AviationPartsBot&text=${encodeURIComponent(text)}`);
};
$('btnHome').onclick=()=>{show('mainMenu');updMenu();};

$('musicToggle').onclick=toggleMusic;

document.addEventListener('click',e=>{
    if(e.target.classList.contains('lb-tab'))renderLeaderboard(e.target.dataset.tab==='score'?'best_score':'total_money');
});

// ==========================================
// INIT
// ==========================================
resetDailyMissions();
updMenu();
loop(0);
</script>
</body>
</html>
