<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Santa Flight ‚Äî Aviation Service</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0b14;
            --bg-secondary: #12131f;
            --bg-card: #1a1c2e;
            --bg-card-hover: #222438;
            --accent-blue: #4a6cf7;
            --accent-blue-light: #6b8cff;
            --accent-blue-dark: #3451d1;
            --accent-gold: #f0b90b;
            --accent-red: #e74c3c;
            --accent-green: #2ecc71;
            --accent-cyan: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --text-tertiary: #5a6380;
            --border-color: rgba(255, 255, 255, 0.08);
            --shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            --safe-top: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
        }

        .game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* ============ HUD ============ */
        .hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: calc(var(--safe-top) + 10px) 20px 20px;
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .hud.visible { opacity: 1; }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .hud-score {
            text-align: center;
        }

        .hud-score-value {
            font-size: 52px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .hud-score-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 4px;
        }

        .hud-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .hud-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .hud-stat.gifts { color: var(--accent-gold); }
        .hud-stat.speed { color: var(--accent-cyan); }

        .shield-bar {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 212, 255, 0.15);
            border: 1px solid rgba(0, 212, 255, 0.3);
            padding: 8px 16px;
            border-radius: 25px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .shield-bar.active { opacity: 1; }

        .shield-bar-icon { font-size: 18px; }

        .shield-bar-progress {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .shield-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue-light));
            border-radius: 3px;
            transition: width 0.1s linear;
        }

        .shield-bar-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        /* ============ SCREENS ============ */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
            overflow: hidden;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* ============ MAIN MENU ============ */
        .main-menu {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }

        .menu-bg-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234a6cf7' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .menu-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: calc(var(--safe-top) + 20px) 20px 20px;
            height: 100%;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 12px;
        }

        .logo-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-dark));
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .logo-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }

        .logo-subtitle {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 4px;
        }

        .stats-row {
            display: flex;
            gap: 10px;
            margin: 16px 0 20px;
        }

        .stat-card {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .stat-value.gold { color: var(--accent-gold); }

        .stat-label {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-blue-dark) 100%);
            box-shadow: 0 8px 30px rgba(74, 108, 247, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(74, 108, 247, 0.45);
        }

        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border-color);
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn:active {
            transform: scale(0.98) !important;
        }

        .btn-icon {
            font-size: 16px;
        }

        .menu-footer {
            margin-top: auto;
            text-align: center;
            padding-top: 10px;
        }

        .menu-footer-text {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .menu-footer-link {
            color: var(--accent-blue);
            text-decoration: none;
        }

        /* ============ LEADERBOARD ============ */
        .leaderboard-screen {
            background: var(--bg-primary);
        }

        .screen-header {
            display: flex;
            align-items: center;
            padding: calc(var(--safe-top) + 10px) 20px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .btn-back {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: var(--bg-card-hover);
        }

        .screen-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-right: 40px;
        }

        .tabs-container {
            padding: 16px 20px;
        }

        .tabs {
            display: flex;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--accent-blue);
            color: var(--text-primary);
        }

        .leaderboard-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .lb-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .lb-item:hover {
            background: var(--bg-card-hover);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .lb-item.highlight {
            background: rgba(74, 108, 247, 0.1);
            border-color: var(--accent-blue);
        }

        .lb-rank {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            border-radius: 10px;
            margin-right: 14px;
        }

        .lb-rank.gold { background: linear-gradient(135deg, #f0b90b, #d4a00a); color: #000; }
        .lb-rank.silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); color: #000; }
        .lb-rank.bronze { background: linear-gradient(135deg, #cd7f32, #b06c28); color: #fff; }
        .lb-rank.default { background: var(--bg-secondary); color: var(--text-secondary); }

        .lb-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-blue), #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: white;
            margin-right: 14px;
        }

        .lb-info {
            flex: 1;
            min-width: 0;
        }

        .lb-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lb-gifts {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .lb-score {
            font-size: 18px;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .lb-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        /* ============ SETTINGS ============ */
        .settings-screen {
            background: var(--bg-primary);
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            margin-bottom: 10px;
        }

        .setting-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .setting-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-size: 20px;
        }

        .setting-text h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .setting-text p {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .toggle {
            width: 52px;
            height: 30px;
            background: var(--bg-secondary);
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--accent-blue);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .toggle.active::after {
            transform: translateX(22px);
        }

        .btn-danger {
            width: 100%;
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.2);
            color: var(--accent-red);
        }

        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        /* ============ GAME OVER ============ */
        .gameover-screen {
            background: linear-gradient(180deg, rgba(10, 11, 20, 0.97) 0%, rgba(18, 19, 31, 0.98) 100%);
            justify-content: center;
            align-items: center;
            padding: 30px;
        }

        .gameover-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .gameover-score {
            font-size: 72px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
            text-shadow: 0 0 60px rgba(74, 108, 247, 0.4);
        }

        .gameover-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 8px;
        }

        .new-record-badge {
            display: none;
            margin: 20px 0;
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--accent-gold), #d4a00a);
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: recordPulse 1.5s ease-in-out infinite;
        }

        .new-record-badge.visible { display: block; }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(240, 185, 11, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 30px 5px rgba(240, 185, 11, 0.2); }
        }

        .gameover-stats {
            display: flex;
            gap: 24px;
            margin: 28px 0;
        }

        .gameover-stat {
            text-align: center;
        }

        .gameover-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .gameover-stat-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        .gameover-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 260px;
            margin-top: 20px;
        }

        /* ============ SNOWFLAKES ============ */
        .snowflakes-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 5;
        }

        .snowflake {
            position: absolute;
            color: white;
            opacity: 0.4;
            animation: snowfall linear infinite;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }

        @keyframes snowfall {
            0% { transform: translateY(-10px) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- HUD -->
        <div class="hud" id="hud">
            <div class="hud-top">
                <div class="hud-stats">
                    <div class="hud-stat gifts" id="hudGifts">üéÅ 0</div>
                    <div class="hud-stat speed" id="hudSpeed">‚ö° x1.0</div>
                </div>
                <div class="hud-score">
                    <div class="hud-score-value" id="hudScore">0</div>
                    <div class="hud-score-label">–°—á—ë—Ç</div>
                </div>
                <div style="width: 60px;"></div>
            </div>
            <div class="shield-bar" id="shieldBar">
                <span class="shield-bar-icon">üõ°Ô∏è</span>
                <div class="shield-bar-progress">
                    <div class="shield-bar-fill" id="shieldFill"></div>
                </div>
                <span class="shield-bar-text">–ó–ê–©–ò–¢–ê</span>
            </div>
        </div>

        <!-- Snowflakes -->
        <div class="snowflakes-container" id="snowflakes"></div>

        <!-- MAIN MENU -->
        <div class="screen main-menu active" id="mainMenu">
            <div class="menu-bg-pattern"></div>
            <div class="menu-content">
                <div class="logo-section">
                    <div class="logo-badge">üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∏–≥—Ä–∞</div>
                    <div class="logo-title">Santa Flight</div>
                    <div class="logo-subtitle">Aviation Service</div>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-value gold" id="statBest">0</div>
                        <div class="stat-label">–†–µ–∫–æ—Ä–¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statGifts">0</div>
                        <div class="stat-label">–ü–æ–¥–∞—Ä–∫–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statGames">0</div>
                        <div class="stat-label">–ò–≥—Ä</div>
                    </div>
                </div>

                <div class="menu-buttons">
                    <button class="btn btn-primary" id="btnPlay">
                        <span class="btn-icon">üöÄ</span> –ù–∞—á–∞—Ç—å –ø–æ–ª—ë—Ç
                    </button>
                    <button class="btn btn-secondary" id="btnLeaderboard">
                        <span class="btn-icon">üèÜ</span> –õ–∏–¥–µ—Ä–±–æ—Ä–¥
                    </button>
                    <button class="btn btn-ghost" id="btnSettings">
                        <span class="btn-icon">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>

                <div class="menu-footer">
                    <p class="menu-footer-text">
                        <a href="https://jet-avia.ru" target="_blank" class="menu-footer-link">jet-avia.ru</a> ‚Ä¢ v2.0
                    </p>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD -->
        <div class="screen leaderboard-screen" id="leaderboardScreen">
            <div class="screen-header">
                <button class="btn-back" id="lbBack">‚Üê</button>
                <div class="screen-title">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
            </div>
            <div class="leaderboard-list" id="lbList">
                <div class="lb-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- SETTINGS -->
        <div class="screen settings-screen" id="settingsScreen">
            <div class="screen-header">
                <button class="btn-back" id="settingsBack">‚Üê</button>
                <div class="screen-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <div class="settings-section-title">–ó–≤—É–∫ –∏ –≤–∏–±—Ä–∞—Ü–∏—è</div>
                    <div class="setting-item">
                        <div class="setting-left">
                            <div class="setting-icon">üîä</div>
                            <div class="setting-text">
                                <h3>–ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
                                <p>–ó–≤—É–∫–∏ –≤ –∏–≥—Ä–µ</p>
                            </div>
                        </div>
                        <div class="toggle active" id="toggleSound"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-left">
                            <div class="setting-icon">üì≥</div>
                            <div class="setting-text">
                                <h3>–í–∏–±—Ä–∞—Ü–∏—è</h3>
                                <p>–¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫</p>
                            </div>
                        </div>
                        <div class="toggle active" id="toggleVibration"></div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">–î–∞–Ω–Ω—ã–µ</div>
                    <button class="btn btn-danger" id="btnReset">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
                </div>
            </div>
        </div>

        <!-- GAME OVER -->
        <div class="screen gameover-screen" id="gameoverScreen">
            <div class="gameover-icon">üí•</div>
            <div class="gameover-score" id="goScore">0</div>
            <div class="gameover-label">–û—á–∫–æ–≤ –Ω–∞–±—Ä–∞–Ω–æ</div>
            
            <div class="new-record-badge" id="newRecordBadge">üéâ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!</div>

            <div class="gameover-stats">
                <div class="gameover-stat">
                    <div class="gameover-stat-value" id="goGifts">0</div>
                    <div class="gameover-stat-label">üéÅ –ü–æ–¥–∞—Ä–∫–æ–≤</div>
                </div>
                <div class="gameover-stat">
                    <div class="gameover-stat-value" id="goBest">0</div>
                    <div class="gameover-stat-label">üèÜ –õ—É—á—à–∏–π</div>
                </div>
            </div>

            <div class="gameover-buttons">
                <button class="btn btn-primary" id="btnRetry">üîÑ –ï—â—ë —Ä–∞–∑</button>
                <button class="btn btn-secondary" id="btnHome">üè† –í –º–µ–Ω—é</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG
        // ==========================================
        const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co';
        const SUPABASE_KEY = 'YOUR_ANON_KEY';

        let W = window.innerWidth;
        let H = window.innerHeight;

        const CONFIG = {
            get CANVAS_WIDTH() { return W; },
            get CANVAS_HEIGHT() { return H; },
            PLAYER: { SIZE: 40, X: 80, JUMP: -7.5, GRAVITY: 0.35, MAX_V: 10 },
            PIPES: { WIDTH: 55, GAP: 190, SPEED: 3, SPAWN: 110, MIN_H: 80 },
            GIFTS: { SIZE: 35, CHANCE: 0.4, POINTS: 5, SHIELD: 180 },
            DIFFICULTY: { SPEED_INC: 0.0005, MAX_SPEED: 2.0, GAP_DEC: 0.0005, MIN_GAP: 140 },
            COLORS: { PIPE: '#1a2a4a', PIPE_LIGHT: '#3a5a8a', PIPE_CAP: '#4a7ccc' }
        };

        // ==========================================
        // STATE
        // ==========================================
        let gameState = 'menu';
        let score = 0, gifts = 0, frameCount = 0;
        let speedMult = 1.0, currentGap = CONFIG.PIPES.GAP;
        let shieldActive = false, shieldTimer = 0;

        let stats = JSON.parse(localStorage.getItem('avsStats')) || { best: 0, gifts: 0, games: 0 };
        let settings = JSON.parse(localStorage.getItem('avsSettings')) || { sound: true, vibration: true };

        let player = { x: CONFIG.PLAYER.X, y: CONFIG.CANVAS_HEIGHT / 2, v: 0, rot: 0 };
        let pipes = [], giftsArr = [], particles = [], snowflakes = [], trails = [];

        // ==========================================
        // CANVAS & ASSETS
        // ==========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            W = window.innerWidth;
            H = window.innerHeight;
            canvas.width = W;
            canvas.height = H;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        const bgImg = new Image();
        bgImg.onerror = () => { bgImg.failed = true; };
        bgImg.src = 'background.png';
        
        const playerImg = new Image();
        playerImg.onerror = () => { playerImg.failed = true; };
        playerImg.src = 'player.png';

        // ==========================================
        // TELEGRAM
        // ==========================================
        let tg = window.Telegram?.WebApp;
        let playerName = '–ü–∏–ª–æ—Ç';
        let safeAreaTop = 60;
        
        if (tg) {
            tg.ready();
            tg.expand();
            
            // –ü–æ–ª—É—á–∞–µ–º safe area –æ—Ç Telegram
            if (tg.safeAreaInset) {
                safeAreaTop = tg.safeAreaInset.top || 60;
            }
            if (tg.contentSafeAreaInset) {
                safeAreaTop = Math.max(safeAreaTop, tg.contentSafeAreaInset.top || 0);
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç—Å—Ç—É–ø—ã
            document.documentElement.style.setProperty('--safe-top', safeAreaTop + 'px');
            
            if (tg.initDataUnsafe?.user) {
                const user = tg.initDataUnsafe.user;
                const firstName = user.first_name || '';
                const lastName = user.last_name || '';
                playerName = (firstName + ' ' + lastName).trim() || '–ü–∏–ª–æ—Ç';
            }
            
            setTimeout(resizeCanvas, 100);
        }

        // ==========================================
        // SOUND
        // ==========================================
        class Sound {
            constructor() { this.ctx = null; }
            init() {
                if (this.ctx) return;
                try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
            }
            play(type) {
                if (!settings.sound || !this.ctx) return;
                const c = this.ctx, o = c.createOscillator(), g = c.createGain();
                o.connect(g); g.connect(c.destination);
                const now = c.currentTime;
                switch(type) {
                    case 'jump':
                        o.frequency.setValueAtTime(400, now);
                        o.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                        g.gain.setValueAtTime(0.15, now);
                        g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        o.start(now); o.stop(now + 0.1);
                        break;
                    case 'score':
                        o.frequency.setValueAtTime(523, now);
                        o.frequency.setValueAtTime(659, now + 0.1);
                        g.gain.setValueAtTime(0.15, now);
                        g.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        o.start(now); o.stop(now + 0.2);
                        break;
                    case 'gift':
                        o.frequency.setValueAtTime(800, now);
                        o.frequency.exponentialRampToValueAtTime(1200, now + 0.2);
                        g.gain.setValueAtTime(0.2, now);
                        g.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                        o.start(now); o.stop(now + 0.3);
                        break;
                    case 'crash':
                        o.type = 'sawtooth';
                        o.frequency.setValueAtTime(200, now);
                        o.frequency.exponentialRampToValueAtTime(50, now + 0.4);
                        g.gain.setValueAtTime(0.2, now);
                        g.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                        o.start(now); o.stop(now + 0.4);
                        break;
                }
            }
        }
        const sound = new Sound();

        // ==========================================
        // LEADERBOARD
        // ==========================================
        class Leaderboard {
            constructor() {
                this.enabled = SUPABASE_URL !== 'https://YOUR_PROJECT_ID.supabase.co';
                this.cache = []; this.lastFetch = 0;
            }
            async fetch() {
                if (!this.enabled) return this.local();
                if (Date.now() - this.lastFetch < 30000 && this.cache.length) return this.cache;
                try {
                    const r = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=*&order=score.desc&limit=50`,
                        { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
                    if (r.ok) { this.cache = await r.json(); this.lastFetch = Date.now(); return this.cache; }
                } catch(e) {}
                return this.local();
            }
            async submit(name, score, gifts) {
                this.saveLocal(name, score, gifts);
                if (!this.enabled) return;
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –ª—É—á—à–∏–π —Å—á—ë—Ç –∏–≥—Ä–æ–∫–∞
                    const check = await fetch(
                        `${SUPABASE_URL}/rest/v1/leaderboard?player_name=eq.${encodeURIComponent(name)}&select=score`,
                        { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                    );
                    const existing = await check.json();
                    
                    if (existing.length > 0) {
                        // –ó–∞–ø–∏—Å—å –µ—Å—Ç—å - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–æ–≤—ã–π —Å—á—ë—Ç –≤—ã—à–µ
                        if (score > existing[0].score) {
                            await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?player_name=eq.${encodeURIComponent(name)}`, {
                                method: 'PATCH',
                                headers: { 
                                    'apikey': SUPABASE_KEY, 
                                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ score, gifts })
                            });
                        }
                    } else {
                        // –ó–∞–ø–∏—Å–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
                        await fetch(`${SUPABASE_URL}/rest/v1/leaderboard`, {
                            method: 'POST',
                            headers: { 
                                'apikey': SUPABASE_KEY, 
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ player_name: name.substring(0, 50), score, gifts })
                        });
                    }
                    this.lastFetch = 0;
                } catch(e) { console.error('Leaderboard error:', e); }
            }
            local() { 
                return JSON.parse(localStorage.getItem('avsLB')) || []; 
            }
            saveLocal(name, score, gifts) {
                let s = this.local();
                // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å –∏–≥—Ä–æ–∫–∞
                const existing = s.find(e => e.player_name === name);
                if (existing) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–æ–≤—ã–π —Å—á—ë—Ç –≤—ã—à–µ
                    if (score > existing.score) {
                        existing.score = score;
                        existing.gifts = gifts;
                    }
                } else {
                    s.push({ player_name: name, score, gifts });
                }
                s.sort((a, b) => b.score - a.score);
                localStorage.setItem('avsLB', JSON.stringify(s.slice(0, 20)));
            }
            async render(el) {
                const c = document.getElementById(el);
                c.innerHTML = '<div class="lb-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                const data = await this.fetch();
                if (!data.length) { c.innerHTML = '<div class="lb-empty">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>'; return; }
                
                // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                const bestScores = {};
                data.forEach(e => {
                    const name = e.player_name || '–ü–∏–ª–æ—Ç';
                    if (!bestScores[name] || e.score > bestScores[name].score) {
                        bestScores[name] = e;
                    }
                });
                const uniqueData = Object.values(bestScores).sort((a, b) => b.score - a.score);
                
                c.innerHTML = uniqueData.slice(0, 10).map((e, i) => {
                    const name = e.player_name || '–ü–∏–ª–æ—Ç';
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : 'default';
                    return `<div class="lb-item ${name === playerName ? 'highlight' : ''}">
                        <div class="lb-rank ${rankClass}">${i + 1}</div>
                        <div class="lb-avatar">${name[0].toUpperCase()}</div>
                        <div class="lb-info"><div class="lb-name">${name}</div><div class="lb-gifts">üéÅ ${e.gifts || 0}</div></div>
                        <div class="lb-score">${e.score}</div>
                    </div>`;
                }).join('');
            }
        }
        const lb = new Leaderboard();

        // ==========================================
        // UI
        // ==========================================
        const $ = id => document.getElementById(id);

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (id) $(id).classList.add('active');
            $('snowflakes').style.display = (id === 'mainMenu' || id === 'leaderboardScreen' || id === 'settingsScreen') ? 'block' : 'none';
        }

        function updateStats() {
            $('statBest').textContent = stats.best;
            $('statGifts').textContent = stats.gifts;
            $('statGames').textContent = stats.games;
        }

        function updateToggles() {
            $('toggleSound').classList.toggle('active', settings.sound);
            $('toggleVibration').classList.toggle('active', settings.vibration);
        }

        function createSnowflakes() {
            const c = $('snowflakes');
            c.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const s = document.createElement('div');
                s.className = 'snowflake';
                s.textContent = '‚ùÑ';
                s.style.left = Math.random() * 100 + '%';
                s.style.fontSize = (Math.random() * 12 + 8) + 'px';
                s.style.animationDuration = (Math.random() * 6 + 6) + 's';
                s.style.animationDelay = Math.random() * 6 + 's';
                c.appendChild(s);
            }
        }

        function vibrate(p, type = 'light') {
            if (!settings.vibration) return;
            
            // Telegram HapticFeedback (–ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ iOS/Android)
            if (tg?.HapticFeedback) {
                if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
                else if (type === 'error') tg.HapticFeedback.notificationOccurred('error');
                else if (type === 'warning') tg.HapticFeedback.notificationOccurred('warning');
                else if (type === 'heavy') tg.HapticFeedback.impactOccurred('heavy');
                else if (type === 'medium') tg.HapticFeedback.impactOccurred('medium');
                else tg.HapticFeedback.impactOccurred('light');
            }
            
            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è (fallback)
            if (navigator.vibrate) navigator.vibrate(p);
        }

        // ==========================================
        // GAME
        // ==========================================
        function initSnow() {
            snowflakes = [];
            for (let i = 0; i < 50; i++) {
                snowflakes.push({ x: Math.random() * W, y: Math.random() * H, sz: Math.random() * 3 + 1, sp: Math.random() * 1 + 0.5, op: Math.random() * 0.4 + 0.2 });
            }
        }

        function reset() {
            player = { x: CONFIG.PLAYER.X, y: (H + safeAreaTop) / 2, v: 0, rot: 0 };
            pipes = []; giftsArr = []; particles = []; trails = [];
            score = 0; gifts = 0; frameCount = 0;
            speedMult = 1.0; currentGap = CONFIG.PIPES.GAP;
            shieldActive = false; shieldTimer = 0;
            $('hudScore').textContent = '0';
            $('hudGifts').textContent = 'üéÅ 0';
            $('hudSpeed').textContent = '‚ö° x1.0';
            $('shieldBar').classList.remove('active');
        }

        function start() {
            sound.init();
            reset();
            gameState = 'playing';
            showScreen(null);
            $('hud').classList.add('visible');
        }

        function gameOver() {
            gameState = 'over';
            sound.play('crash');
            vibrate([100, 50, 100], 'error');

            stats.games++;
            stats.gifts += gifts;
            const isRecord = score > stats.best;
            if (isRecord) stats.best = score;
            localStorage.setItem('avsStats', JSON.stringify(stats));

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –≤—Å–µ–≥–¥–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ª—É—á—à–∏–π —Å—á—ë—Ç –≤–Ω—É—Ç—Ä–∏)
            lb.submit(playerName, score, gifts);

            $('goScore').textContent = score;
            $('goGifts').textContent = gifts;
            $('goBest').textContent = stats.best;
            $('newRecordBadge').classList.toggle('visible', isRecord);

            $('hud').classList.remove('visible');
            showScreen('gameoverScreen');
            explosion(player.x, player.y);
        }

        function jump() {
            if (gameState !== 'playing') return;
            player.v = CONFIG.PLAYER.JUMP;
            sound.play('jump');
            vibrate(25);
        }

        // ==========================================
        // DRAW
        // ==========================================
        function drawBg() {
            if (bgImg.complete && bgImg.naturalWidth > 0 && !bgImg.failed) {
                ctx.drawImage(bgImg, 0, 0, W, H);
            } else {
                ctx.fillStyle = '#0a0b14';
                ctx.fillRect(0, 0, W, H);
            }
        }

        function drawSnow() {
            snowflakes.forEach(s => {
                ctx.globalAlpha = s.op;
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.sz, 0, Math.PI * 2);
                ctx.fill();
                s.y += s.sp * speedMult;
                s.x += Math.sin(frameCount * 0.01 + s.x) * 0.3;
                if (s.y > H) { s.y = -5; s.x = Math.random() * W; }
            });
            ctx.globalAlpha = 1;
        }

        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.rot);
            const bob = Math.sin(frameCount * 0.15) * 3;

            if (shieldActive) {
                ctx.shadowColor = '#00d4ff';
                ctx.shadowBlur = 30 + Math.sin(frameCount * 0.2) * 10;
                ctx.strokeStyle = `rgba(0, 212, 255, ${0.4 + Math.sin(frameCount * 0.1) * 0.2})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, bob, 52, 0, Math.PI * 2);
                ctx.stroke();
            }

            if (playerImg.complete && playerImg.naturalWidth > 0 && !playerImg.failed) {
                ctx.drawImage(playerImg, -44, -25 + bob, 88, 50);
            } else {
                // Fallback - —Ä–∏—Å—É–µ–º –∫—Ä—É–≥
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath();
                ctx.arc(0, bob, 25, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.shadowBlur = 0;
            ctx.restore();

            if (gameState === 'playing' && frameCount % 3 === 0) {
                trails.push({ x: player.x - 35, y: player.y + 10 + Math.random() * 8, sz: Math.random() * 4 + 2, a: 0.7, c: shieldActive ? '0,212,255' : '255,180,50' });
            }
        }

        function drawTrails() {
            const sp = CONFIG.PIPES.SPEED * speedMult;
            trails.forEach((t, i) => {
                ctx.fillStyle = `rgba(${t.c},${t.a})`;
                ctx.beginPath();
                ctx.arc(t.x, t.y, t.sz, 0, Math.PI * 2);
                ctx.fill();
                t.x -= sp * 0.8;
                t.a -= 0.02;
                t.sz *= 0.96;
                if (t.a <= 0 || t.x < -10) trails.splice(i, 1);
            });
        }

        function drawPipes() {
            pipes.forEach(p => {
                const grad = ctx.createLinearGradient(p.x, 0, p.x + CONFIG.PIPES.WIDTH, 0);
                grad.addColorStop(0, CONFIG.COLORS.PIPE);
                grad.addColorStop(0.5, CONFIG.COLORS.PIPE_LIGHT);
                grad.addColorStop(1, CONFIG.COLORS.PIPE);

                ctx.fillStyle = grad;
                ctx.fillRect(p.x, 0, CONFIG.PIPES.WIDTH, p.top);
                ctx.fillRect(p.x, p.bot, CONFIG.PIPES.WIDTH, H - p.bot);

                ctx.fillStyle = CONFIG.COLORS.PIPE_CAP;
                ctx.fillRect(p.x - 4, p.top - 20, CONFIG.PIPES.WIDTH + 8, 20);
                ctx.fillRect(p.x - 4, p.bot, CONFIG.PIPES.WIDTH + 8, 20);

                // Warning lights
                ctx.fillStyle = '#ff4444';
                ctx.beginPath();
                ctx.arc(p.x + CONFIG.PIPES.WIDTH / 2, p.top - 20, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(p.x + CONFIG.PIPES.WIDTH / 2, p.bot + 20, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawGifts() {
            giftsArr.forEach(g => {
                ctx.save();
                ctx.translate(g.x, g.y);
                const wb = Math.sin(frameCount * 0.1 + g.x) * 4;
                ctx.rotate(Math.sin(frameCount * 0.05) * 0.08);

                ctx.shadowColor = '#f0b90b';
                ctx.shadowBlur = 15 + Math.sin(frameCount * 0.1) * 5;

                const s = CONFIG.GIFTS.SIZE;
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(-s/2, -s/2 + wb, s, s);

                ctx.fillStyle = '#f0b90b';
                ctx.fillRect(-3, -s/2 + wb, 6, s);
                ctx.fillRect(-s/2, -3 + wb, s, 6);

                ctx.beginPath();
                ctx.ellipse(-7, -s/2 - 4 + wb, 7, 5, -0.3, 0, Math.PI * 2);
                ctx.ellipse(7, -s/2 - 4 + wb, 7, 5, 0.3, 0, Math.PI * 2);
                ctx.fill();

                ctx.shadowBlur = 0;
                ctx.restore();
            });
        }

        function drawParticles() {
            particles.forEach((p, i) => {
                ctx.fillStyle = `rgba(${p.c},${p.a})`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.sz, 0, Math.PI * 2);
                ctx.fill();
                p.x += p.vx; p.y += p.vy;
                if (p.g) p.vy += 0.15;
                p.a -= 0.02;
                p.sz *= 0.97;
                if (p.a <= 0) particles.splice(i, 1);
            });
        }

        function explosion(x, y) {
            const colors = ['255,100,50', '255,200,50', '255,150,0'];
            for (let i = 0; i < 25; i++) {
                particles.push({ x, y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, sz: Math.random() * 7 + 2, c: colors[Math.floor(Math.random() * 3)], a: 1, g: false });
            }
        }

        function giftExplosion(x, y) {
            const colors = ['240,185,11', '0,212,255', '231,76,60'];
            for (let i = 0; i < 18; i++) {
                particles.push({ x, y, vx: (Math.random() - 0.5) * 8, vy: (Math.random() - 0.5) * 8 - 2, sz: Math.random() * 5 + 2, c: colors[Math.floor(Math.random() * 3)], a: 1, g: true });
            }
        }

        // ==========================================
        // UPDATE
        // ==========================================
        function updatePlayer() {
            player.v += CONFIG.PLAYER.GRAVITY;
            player.v = Math.min(player.v, CONFIG.PLAYER.MAX_V);
            player.y += player.v;
            player.rot = Math.min(Math.max(player.v * 0.06, -0.4), 0.6);

            const topLimit = safeAreaTop + 30;
            if (player.y < topLimit) { player.y = topLimit; player.v = 0; }
            if (player.y > H - 60) {
                if (!shieldActive) gameOver();
                else { player.y = H - 60; player.v = CONFIG.PLAYER.JUMP; }
            }
        }

        function updatePipes() {
            const sp = CONFIG.PIPES.SPEED * speedMult;
            const spawnRate = Math.floor(CONFIG.PIPES.SPAWN / speedMult);

            if (frameCount % spawnRate === 0) {
                const minT = safeAreaTop + CONFIG.PIPES.MIN_H;
                const maxT = H - currentGap - CONFIG.PIPES.MIN_H - 60;
                const top = Math.random() * (maxT - minT) + minT;
                pipes.push({ x: W, top, bot: top + currentGap, passed: false });

                if (Math.random() < CONFIG.GIFTS.CHANCE) {
                    giftsArr.push({ x: W + 50, y: top + currentGap / 2, col: false });
                }
            }

            pipes.forEach((p, i) => {
                p.x -= sp;
                if (!p.passed && p.x + CONFIG.PIPES.WIDTH < player.x) {
                    p.passed = true;
                    score++;
                    $('hudScore').textContent = score;
                    sound.play('score');
                    vibrate(25);
                }
                if (collision(p) && !shieldActive) gameOver();
                if (p.x < -CONFIG.PIPES.WIDTH) pipes.splice(i, 1);
            });
        }

        function updateGifts() {
            const sp = CONFIG.PIPES.SPEED * speedMult;
            giftsArr.forEach((g, i) => {
                g.x -= sp;
                if (!g.col) {
                    const dx = player.x - g.x, dy = player.y - g.y;
                    if (Math.sqrt(dx*dx + dy*dy) < 42) {
                        g.col = true;
                        gifts++;
                        score += CONFIG.GIFTS.POINTS;
                        $('hudScore').textContent = score;
                        $('hudGifts').textContent = 'üéÅ ' + gifts;
                        giftExplosion(g.x, g.y);
                        activateShield();
                        vibrate([40, 20, 40], 'success');
                    }
                }
                if (g.x < -50 || g.col) giftsArr.splice(i, 1);
            });
        }

        function updateDifficulty() {
            if (speedMult < CONFIG.DIFFICULTY.MAX_SPEED) speedMult += CONFIG.DIFFICULTY.SPEED_INC;
            if (currentGap > CONFIG.DIFFICULTY.MIN_GAP) currentGap -= CONFIG.DIFFICULTY.GAP_DEC;
            $('hudSpeed').textContent = '‚ö° x' + speedMult.toFixed(1);
        }

        function updateShield() {
            if (shieldActive) {
                shieldTimer--;
                $('shieldFill').style.width = (shieldTimer / CONFIG.GIFTS.SHIELD * 100) + '%';
                if (shieldTimer <= 0) {
                    shieldActive = false;
                    $('shieldBar').classList.remove('active');
                }
            }
        }

        function activateShield() {
            shieldActive = true;
            shieldTimer = CONFIG.GIFTS.SHIELD;
            $('shieldBar').classList.add('active');
            sound.play('gift');
        }

        function collision(p) {
            const pl = player.x - 35, pr = player.x + 35;
            const pt = player.y - 18, pb = player.y + 18;
            if (pr > p.x && pl < p.x + CONFIG.PIPES.WIDTH) {
                if (pt < p.top || pb > p.bot) return true;
            }
            return false;
        }

        // ==========================================
        // LOOP
        // ==========================================
        function loop() {
            drawBg();
            drawSnow();
            drawTrails();
            drawPipes();
            drawGifts();
            drawPlayer();
            drawParticles();

            if (gameState === 'playing') {
                updatePlayer();
                updatePipes();
                updateGifts();
                updateDifficulty();
                updateShield();
            }
            frameCount++;
            requestAnimationFrame(loop);
        }

        // ==========================================
        // EVENTS
        // ==========================================
        canvas.addEventListener('click', () => { sound.init(); jump(); });
        canvas.addEventListener('touchstart', e => { e.preventDefault(); sound.init(); jump(); });
        document.addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); sound.init(); jump(); } });

        $('btnPlay').onclick = start;
        $('btnLeaderboard').onclick = () => { showScreen('leaderboardScreen'); lb.render('lbList'); };
        $('btnSettings').onclick = () => { showScreen('settingsScreen'); updateToggles(); };

        $('lbBack').onclick = () => { showScreen('mainMenu'); updateStats(); };
        $('settingsBack').onclick = () => { showScreen('mainMenu'); updateStats(); };

        $('toggleSound').onclick = () => { settings.sound = !settings.sound; localStorage.setItem('avsSettings', JSON.stringify(settings)); updateToggles(); };
        $('toggleVibration').onclick = () => { settings.vibration = !settings.vibration; localStorage.setItem('avsSettings', JSON.stringify(settings)); updateToggles(); };
        $('btnReset').onclick = () => {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) {
                stats = { best: 0, gifts: 0, games: 0 };
                localStorage.setItem('avsStats', JSON.stringify(stats));
                localStorage.removeItem('avsLB');
                updateStats();
                alert('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω');
            }
        };

        $('btnRetry').onclick = start;
        $('btnHome').onclick = () => { showScreen('mainMenu'); updateStats(); };

        // ==========================================
        // INIT
        // ==========================================
        initSnow();
        createSnowflakes();
        updateStats();
        updateToggles();
        loop();
    </script>
</body>
</html>
