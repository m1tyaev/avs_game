<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviation Parts Runner ‚Äî Aviation Service</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0b14;
            --bg-secondary: #12131f;
            --bg-card: #1a1c2e;
            --bg-card-hover: #222438;
            --accent-blue: #4a6cf7;
            --accent-blue-light: #6b8cff;
            --accent-gold: #f0b90b;
            --accent-red: #e74c3c;
            --accent-green: #2ecc71;
            --accent-cyan: #00d4ff;
            --accent-purple: #9b59b6;
            --accent-orange: #e67e22;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --text-tertiary: #5a6380;
            --border-color: rgba(255, 255, 255, 0.08);
            --safe-top: 100px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            font-family: 'Inter', -apple-system, sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
        }

        .game-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-primary);
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }

        /* HUD */
        .hud {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            padding: calc(var(--safe-top) + 10px) 16px 16px;
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .hud.visible { opacity: 1; }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .hud-money {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 8px 14px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .hud-rfq {
            flex: 1;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 200px;
        }

        .rfq-title {
            font-size: 9px;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .rfq-items {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .rfq-item {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }
        .rfq-item.collected {
            background: var(--accent-green);
            color: #000;
        }

        .hud-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
        }

        .hud-stat {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Screens */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            overflow-y: auto;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* Main Menu */
        .main-menu {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }

        .menu-content {
            padding: calc(var(--safe-top) + 10px) 20px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100%;
        }

        .logo-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--accent-blue), #3451d1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .logo-title {
            font-size: 24px;
            font-weight: 900;
            color: var(--text-primary);
            text-align: center;
            line-height: 1.1;
        }

        .logo-subtitle {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 4px;
        }

        .wallet-card {
            width: 100%;
            background: linear-gradient(135deg, #1a1c2e 0%, #222438 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
        }

        .wallet-balance {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .wallet-amount {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .wallet-label {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .wallet-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .wallet-stat {
            flex: 1;
            text-align: center;
        }

        .wallet-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .wallet-stat-label {
            font-size: 9px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .menu-buttons {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #3451d1 100%);
            box-shadow: 0 8px 30px rgba(74, 108, 247, 0.35);
        }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        .btn-aog {
            background: linear-gradient(135deg, var(--accent-red) 0%, #c0392b 100%);
            animation: aogPulse 2s ease-in-out infinite;
        }

        @keyframes aogPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(231, 76, 60, 0.2); }
        }

        .menu-footer {
            margin-top: auto;
            padding-top: 20px;
            text-align: center;
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .menu-footer a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        /* RFQ Screen */
        .rfq-screen {
            background: var(--bg-primary);
        }

        .rfq-content {
            padding: calc(var(--safe-top) + 10px) 20px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rfq-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .rfq-header h2 {
            font-size: 14px;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
        }

        .rfq-header h1 {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .rfq-client {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .rfq-order {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .rfq-order-title {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .rfq-parts {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rfq-part {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .rfq-part-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .rfq-part-info {
            flex: 1;
        }

        .rfq-part-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rfq-part-rarity {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .rfq-part-qty {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .rfq-reward {
            width: 100%;
            background: linear-gradient(135deg, rgba(240,185,11,0.1) 0%, rgba(240,185,11,0.05) 100%);
            border: 1px solid rgba(240,185,11,0.2);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            margin-bottom: 20px;
        }

        .rfq-reward-label {
            font-size: 10px;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .rfq-reward-amount {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-gold);
            margin-top: 4px;
        }

        /* Game Over */
        .gameover-screen {
            background: linear-gradient(180deg, rgba(10,11,20,0.97), rgba(18,19,31,0.98));
            justify-content: center;
            align-items: center;
            padding: 30px;
        }

        .gameover-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .gameover-money {
            font-size: 48px;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .gameover-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .gameover-rfq {
            margin: 20px 0;
            padding: 16px 24px;
            border-radius: 12px;
            text-align: center;
        }

        .gameover-rfq.success {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .gameover-rfq.failed {
            background: rgba(231, 76, 60, 0.15);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .gameover-rfq-text {
            font-size: 14px;
            font-weight: 600;
        }

        .gameover-rfq.success .gameover-rfq-text { color: var(--accent-green); }
        .gameover-rfq.failed .gameover-rfq-text { color: var(--accent-red); }

        .gameover-stats {
            display: flex;
            gap: 24px;
            margin: 16px 0 24px;
        }

        .gameover-stat {
            text-align: center;
        }

        .gameover-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .gameover-stat-label {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .gameover-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 260px;
        }

        /* Parts collected popup */
        .part-popup {
            position: absolute;
            pointer-events: none;
            font-size: 14px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: partPopup 1s ease-out forwards;
            z-index: 15;
        }

        @keyframes partPopup {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }

        /* Rarity colors */
        .rarity-common { background: #6b7280; }
        .rarity-uncommon { background: var(--accent-green); }
        .rarity-rare { background: var(--accent-blue); }
        .rarity-epic { background: var(--accent-purple); }
        .rarity-legendary { background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange)); }

        .text-common { color: #9ca3af; }
        .text-uncommon { color: var(--accent-green); }
        .text-rare { color: var(--accent-blue-light); }
        .text-epic { color: var(--accent-purple); }
        .text-legendary { color: var(--accent-gold); }

        /* Legendary alert */
        .legendary-alert {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 20px 30px;
            text-align: center;
            z-index: 25;
            animation: legendaryPulse 0.5s ease-out;
            display: none;
        }

        .legendary-alert.show { display: block; }

        @keyframes legendaryPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .legendary-alert-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .legendary-alert-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- HUD -->
        <div class="hud" id="hud">
            <div class="hud-top">
                <div class="hud-money">üí∞ $<span id="hudMoney">0</span></div>
                <div class="hud-rfq">
                    <div class="rfq-title">üìã RFQ –ó–∞–∫–∞–∑</div>
                    <div class="rfq-items" id="hudRfq"></div>
                </div>
                <div class="hud-stats">
                    <div class="hud-stat" id="hudParts">üì¶ 0</div>
                    <div class="hud-stat" id="hudSpeed">‚ö° x1.0</div>
                </div>
            </div>
        </div>

        <!-- Legendary Alert -->
        <div class="legendary-alert" id="legendaryAlert">
            <div class="legendary-alert-icon">‚≠ê</div>
            <div class="legendary-alert-text">Legendary Part!</div>
        </div>

        <!-- Main Menu -->
        <div class="screen main-menu active" id="mainMenu">
            <div class="menu-content">
                <div class="logo-badge">‚úàÔ∏è Aviation Game</div>
                <div class="logo-title">Aviation Parts<br>Runner</div>
                <div class="logo-subtitle">Aviation Service</div>

                <div class="wallet-card">
                    <div class="wallet-balance">
                        <span style="font-size: 24px;">üí∞</span>
                        <div>
                            <div class="wallet-amount">$<span id="totalMoney">0</span></div>
                            <div class="wallet-label">–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                        </div>
                    </div>
                    <div class="wallet-stats">
                        <div class="wallet-stat">
                            <div class="wallet-stat-value" id="totalRfq">0</div>
                            <div class="wallet-stat-label">RFQ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                        </div>
                        <div class="wallet-stat">
                            <div class="wallet-stat-value" id="totalParts">0</div>
                            <div class="wallet-stat-label">–î–µ—Ç–∞–ª–µ–π</div>
                        </div>
                        <div class="wallet-stat">
                            <div class="wallet-stat-value" id="totalGames">0</div>
                            <div class="wallet-stat-label">–ü–æ–ª—ë—Ç–æ–≤</div>
                        </div>
                    </div>
                </div>

                <div class="menu-buttons">
                    <button class="btn btn-primary" id="btnPlay">üöÄ –ù–∞—á–∞—Ç—å –ø–æ–ª—ë—Ç</button>
                    <button class="btn btn-secondary" id="btnLeaderboard">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
                </div>

                <div class="menu-footer">
                    <a href="https://jet-avia.ru" target="_blank">jet-avia.ru</a> ‚Ä¢ v1.0
                </div>
            </div>
        </div>

        <!-- RFQ Screen -->
        <div class="screen rfq-screen" id="rfqScreen">
            <div class="rfq-content">
                <div class="rfq-header">
                    <h2>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
                    <h1>RFQ #<span id="rfqNumber">001</span></h1>
                    <div class="rfq-client">–ö–ª–∏–µ–Ω—Ç: <span id="rfqClient">Airline Co.</span></div>
                </div>

                <div class="rfq-order">
                    <div class="rfq-order-title">–¢—Ä–µ–±—É–µ–º—ã–µ –¥–µ—Ç–∞–ª–∏</div>
                    <div class="rfq-parts" id="rfqParts"></div>
                </div>

                <div class="rfq-reward">
                    <div class="rfq-reward-label">–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
                    <div class="rfq-reward-amount">+$<span id="rfqReward">0</span></div>
                </div>

                <div class="menu-buttons">
                    <button class="btn btn-primary" id="btnStartRfq">‚úàÔ∏è –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>
                    <button class="btn btn-secondary" id="btnSkipRfq">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Game Over -->
        <div class="screen gameover-screen" id="gameoverScreen">
            <div class="gameover-title">–ü–æ–ª—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</div>
            <div class="gameover-money">$<span id="goMoney">0</span></div>
            <div class="gameover-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>

            <div class="gameover-rfq" id="goRfq">
                <div class="gameover-rfq-text" id="goRfqText"></div>
            </div>

            <div class="gameover-stats">
                <div class="gameover-stat">
                    <div class="gameover-stat-value" id="goParts">0</div>
                    <div class="gameover-stat-label">–î–µ—Ç–∞–ª–µ–π</div>
                </div>
                <div class="gameover-stat">
                    <div class="gameover-stat-value" id="goBest">$0</div>
                    <div class="gameover-stat-label">–†–µ–∫–æ—Ä–¥</div>
                </div>
            </div>

            <div class="gameover-buttons">
                <button class="btn btn-primary" id="btnRetry">üîÑ –ï—â—ë —Ä–∞–∑</button>
                <button class="btn btn-secondary" id="btnHome">üè† –í –º–µ–Ω—é</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG
        // ==========================================
        let W = window.innerWidth;
        let H = window.innerHeight;
        let safeAreaTop = 100;

        const PARTS_DATA = [
            // Common (60%)
            { name: 'O-Ring', icon: '‚≠ï', rarity: 'common', value: 10, chance: 0.20 },
            { name: 'Washer', icon: 'üîò', rarity: 'common', value: 20, chance: 0.20 },
            { name: 'Rivet', icon: 'üìç', rarity: 'common', value: 30, chance: 0.20 },
            // Uncommon (25%)
            { name: 'Valve', icon: 'üîß', rarity: 'uncommon', value: 200, chance: 0.10 },
            { name: 'Filter', icon: 'üßΩ', rarity: 'uncommon', value: 300, chance: 0.08 },
            { name: 'Bearing', icon: '‚öôÔ∏è', rarity: 'uncommon', value: 500, chance: 0.07 },
            // Rare (12%)
            { name: 'Fuel Pump', icon: '‚õΩ', rarity: 'rare', value: 2000, chance: 0.05 },
            { name: 'Actuator', icon: 'üîå', rarity: 'rare', value: 3000, chance: 0.04 },
            { name: 'Sensor', icon: 'üì°', rarity: 'rare', value: 5000, chance: 0.03 },
            // Epic (2.5%)
            { name: 'HMU', icon: 'üéõÔ∏è', rarity: 'epic', value: 20000, chance: 0.015 },
            { name: 'Starter', icon: '‚ö°', rarity: 'epic', value: 30000, chance: 0.01 },
            // Legendary (0.5%)
            { name: 'APU', icon: 'üîã', rarity: 'legendary', value: 100000, chance: 0.003 },
            { name: 'Engine Module', icon: 'üõ´', rarity: 'legendary', value: 200000, chance: 0.002 }
        ];

        const CLIENTS = ['Aeroflot', 'Emirates', 'Lufthansa', 'Air France', 'British Airways', 'Qatar Airways', 'S7 Airlines', 'Utair'];

        const CONFIG = {
            PLAYER: { X: 80, SIZE: 40, JUMP: -9, GRAVITY: 0.4, MAX_V: 12 },
            OBSTACLES: { WIDTH: 60, GAP: 200, SPEED: 3.5, SPAWN: 120, MIN_H: 100 },
            PARTS: { SIZE: 40, SPAWN_RATE: 60 },
            DIFFICULTY: { SPEED_INC: 0.0003, MAX_SPEED: 2.5 }
        };

        // ==========================================
        // STATE
        // ==========================================
        let gameState = 'menu';
        let money = 0, partsCollected = 0, frameCount = 0, speedMult = 1.0;

        let stats = JSON.parse(localStorage.getItem('avrStats')) || { money: 0, rfq: 0, parts: 0, games: 0, best: 0 };

        let player = { x: CONFIG.PLAYER.X, y: H / 2, v: 0, rot: 0 };
        let obstacles = [], parts = [], particles = [];

        let currentRfq = null;
        let rfqProgress = {};

        // ==========================================
        // CANVAS
        // ==========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            W = window.innerWidth;
            H = window.innerHeight;
            canvas.width = W;
            canvas.height = H;
        }
        resize();
        window.addEventListener('resize', resize);

        // ==========================================
        // TELEGRAM
        // ==========================================
        let tg = window.Telegram?.WebApp;
        let playerName = '–ü–∏–ª–æ—Ç';

        if (tg) {
            tg.ready();
            tg.expand();

            if (tg.safeAreaInset) safeAreaTop = Math.max(100, tg.safeAreaInset.top + 50);
            if (tg.contentSafeAreaInset) safeAreaTop = Math.max(safeAreaTop, tg.contentSafeAreaInset.top + 50);

            document.documentElement.style.setProperty('--safe-top', safeAreaTop + 'px');

            if (tg.initDataUnsafe?.user) {
                const u = tg.initDataUnsafe.user;
                playerName = ((u.first_name || '') + ' ' + (u.last_name || '')).trim() || '–ü–∏–ª–æ—Ç';
            }

            setTimeout(resize, 100);
        }

        // ==========================================
        // SOUND & HAPTIC
        // ==========================================
        function vibrate(type = 'light') {
            if (tg?.HapticFeedback) {
                if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
                else if (type === 'error') tg.HapticFeedback.notificationOccurred('error');
                else if (type === 'heavy') tg.HapticFeedback.impactOccurred('heavy');
                else tg.HapticFeedback.impactOccurred('light');
            }
        }

        // ==========================================
        // RFQ SYSTEM
        // ==========================================
        function generateRfq() {
            const numParts = Math.floor(Math.random() * 3) + 2; // 2-4 parts
            const rfqParts = [];
            const usedParts = new Set();

            for (let i = 0; i < numParts; i++) {
                let part;
                do {
                    // Bias towards common/uncommon for RFQ
                    const roll = Math.random();
                    if (roll < 0.5) part = PARTS_DATA[Math.floor(Math.random() * 3)]; // common
                    else if (roll < 0.8) part = PARTS_DATA[3 + Math.floor(Math.random() * 3)]; // uncommon
                    else if (roll < 0.95) part = PARTS_DATA[6 + Math.floor(Math.random() * 3)]; // rare
                    else part = PARTS_DATA[9 + Math.floor(Math.random() * 2)]; // epic
                } while (usedParts.has(part.name));

                usedParts.add(part.name);
                rfqParts.push({ ...part, qty: Math.floor(Math.random() * 2) + 1 });
            }

            const reward = rfqParts.reduce((sum, p) => sum + p.value * p.qty, 0) * 2;

            return {
                number: String(Math.floor(Math.random() * 900) + 100),
                client: CLIENTS[Math.floor(Math.random() * CLIENTS.length)],
                parts: rfqParts,
                reward
            };
        }

        function showRfqScreen() {
            currentRfq = generateRfq();
            rfqProgress = {};
            currentRfq.parts.forEach(p => rfqProgress[p.name] = 0);

            document.getElementById('rfqNumber').textContent = currentRfq.number;
            document.getElementById('rfqClient').textContent = currentRfq.client;
            document.getElementById('rfqReward').textContent = currentRfq.reward.toLocaleString();

            const partsHtml = currentRfq.parts.map(p => `
                <div class="rfq-part">
                    <div class="rfq-part-icon rarity-${p.rarity}">${p.icon}</div>
                    <div class="rfq-part-info">
                        <div class="rfq-part-name">${p.name}</div>
                        <div class="rfq-part-rarity text-${p.rarity}">${p.rarity.toUpperCase()}</div>
                    </div>
                    <div class="rfq-part-qty">√ó${p.qty}</div>
                </div>
            `).join('');

            document.getElementById('rfqParts').innerHTML = partsHtml;
            showScreen('rfqScreen');
        }

        function updateHudRfq() {
            if (!currentRfq) return;
            const html = currentRfq.parts.map(p => {
                const collected = rfqProgress[p.name] >= p.qty;
                return `<div class="rfq-item ${collected ? 'collected' : ''}">${p.icon}${rfqProgress[p.name]}/${p.qty}</div>`;
            }).join('');
            document.getElementById('hudRfq').innerHTML = html;
        }

        function checkRfqComplete() {
            if (!currentRfq) return false;
            return currentRfq.parts.every(p => rfqProgress[p.name] >= p.qty);
        }

        // ==========================================
        // GAME
        // ==========================================
        function reset() {
            player = { x: CONFIG.PLAYER.X, y: (safeAreaTop + H) / 2, v: 0, rot: 0 };
            obstacles = [];
            parts = [];
            particles = [];
            money = 0;
            partsCollected = 0;
            frameCount = 0;
            speedMult = 1.0;

            if (currentRfq) {
                rfqProgress = {};
                currentRfq.parts.forEach(p => rfqProgress[p.name] = 0);
            }

            document.getElementById('hudMoney').textContent = '0';
            document.getElementById('hudParts').textContent = 'üì¶ 0';
            document.getElementById('hudSpeed').textContent = '‚ö° x1.0';
            updateHudRfq();
        }

        function startGame() {
            reset();
            gameState = 'playing';
            showScreen(null);
            document.getElementById('hud').classList.add('visible');
        }

        function gameOver() {
            gameState = 'over';
            vibrate('error');

            const rfqComplete = checkRfqComplete();
            let totalEarned = money;

            if (rfqComplete && currentRfq) {
                totalEarned += currentRfq.reward;
                stats.rfq++;
            }

            stats.games++;
            stats.parts += partsCollected;
            stats.money += totalEarned;
            if (totalEarned > stats.best) stats.best = totalEarned;
            localStorage.setItem('avrStats', JSON.stringify(stats));

            document.getElementById('goMoney').textContent = totalEarned.toLocaleString();
            document.getElementById('goParts').textContent = partsCollected;
            document.getElementById('goBest').textContent = '$' + stats.best.toLocaleString();

            const rfqEl = document.getElementById('goRfq');
            const rfqText = document.getElementById('goRfqText');

            if (currentRfq) {
                if (rfqComplete) {
                    rfqEl.className = 'gameover-rfq success';
                    rfqText.textContent = `‚úÖ RFQ #${currentRfq.number} –≤—ã–ø–æ–ª–Ω–µ–Ω! +$${currentRfq.reward.toLocaleString()}`;
                } else {
                    rfqEl.className = 'gameover-rfq failed';
                    rfqText.textContent = `‚ùå RFQ #${currentRfq.number} –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω`;
                }
                rfqEl.style.display = 'block';
            } else {
                rfqEl.style.display = 'none';
            }

            document.getElementById('hud').classList.remove('visible');
            showScreen('gameoverScreen');

            // Explosion
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: player.x, y: player.y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    size: Math.random() * 6 + 2,
                    color: `hsl(${Math.random() * 60 + 10}, 100%, 50%)`,
                    life: 1
                });
            }
        }

        function jump() {
            if (gameState !== 'playing') return;
            player.v = CONFIG.PLAYER.JUMP;
            vibrate('light');
        }

        // ==========================================
        // SPAWN
        // ==========================================
        function spawnObstacle() {
            const minTop = safeAreaTop + CONFIG.OBSTACLES.MIN_H;
            const maxTop = H - CONFIG.OBSTACLES.GAP - CONFIG.OBSTACLES.MIN_H - 60;
            const top = Math.random() * (maxTop - minTop) + minTop;

            obstacles.push({
                x: W,
                top,
                bottom: top + CONFIG.OBSTACLES.GAP,
                passed: false
            });
        }

        function spawnPart() {
            // Determine rarity
            const roll = Math.random();
            let cumulative = 0;
            let partData = PARTS_DATA[0];

            for (const p of PARTS_DATA) {
                cumulative += p.chance;
                if (roll < cumulative) {
                    partData = p;
                    break;
                }
            }

            // Position in safe area
            const y = safeAreaTop + 80 + Math.random() * (H - safeAreaTop - 160);

            const part = {
                x: W + 50,
                y,
                ...partData,
                collected: false,
                glow: 0
            };

            // Show alert for legendary
            if (partData.rarity === 'legendary') {
                const alert = document.getElementById('legendaryAlert');
                alert.classList.add('show');
                vibrate('heavy');
                setTimeout(() => alert.classList.remove('show'), 1500);
            }

            parts.push(part);
        }

        // ==========================================
        // UPDATE
        // ==========================================
        function updatePlayer() {
            player.v += CONFIG.GRAVITY;
            player.v = Math.min(player.v, CONFIG.PLAYER.MAX_V);
            player.y += player.v;
            player.rot = Math.min(Math.max(player.v * 0.05, -0.4), 0.6);

            // Boundaries
            if (player.y < safeAreaTop + 30) {
                player.y = safeAreaTop + 30;
                player.v = 0;
            }
            if (player.y > H - 60) {
                gameOver();
            }
        }

        function updateObstacles() {
            const sp = CONFIG.OBSTACLES.SPEED * speedMult;

            if (frameCount % Math.floor(CONFIG.OBSTACLES.SPAWN / speedMult) === 0) {
                spawnObstacle();
            }

            obstacles.forEach((o, i) => {
                o.x -= sp;

                // Collision
                if (!o.passed && player.x + 30 > o.x && player.x - 30 < o.x + CONFIG.OBSTACLES.WIDTH) {
                    if (player.y - 20 < o.top || player.y + 20 > o.bottom) {
                        gameOver();
                    }
                }

                if (!o.passed && o.x + CONFIG.OBSTACLES.WIDTH < player.x) {
                    o.passed = true;
                }

                if (o.x < -CONFIG.OBSTACLES.WIDTH) {
                    obstacles.splice(i, 1);
                }
            });
        }

        function updateParts() {
            const sp = CONFIG.OBSTACLES.SPEED * speedMult;

            if (frameCount % CONFIG.PARTS.SPAWN_RATE === 0) {
                spawnPart();
            }

            parts.forEach((p, i) => {
                p.x -= sp;
                p.glow = (Math.sin(frameCount * 0.1) + 1) / 2;

                if (!p.collected) {
                    const dx = player.x - p.x;
                    const dy = player.y - p.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 45) {
                        p.collected = true;
                        money += p.value;
                        partsCollected++;

                        if (currentRfq && rfqProgress[p.name] !== undefined) {
                            rfqProgress[p.name]++;
                            updateHudRfq();
                        }

                        document.getElementById('hudMoney').textContent = money.toLocaleString();
                        document.getElementById('hudParts').textContent = 'üì¶ ' + partsCollected;

                        // Popup
                        showPartPopup(p);

                        // Particles
                        for (let j = 0; j < 8; j++) {
                            particles.push({
                                x: p.x, y: p.y,
                                vx: (Math.random() - 0.5) * 6,
                                vy: (Math.random() - 0.5) * 6,
                                size: Math.random() * 4 + 2,
                                color: getRarityColor(p.rarity),
                                life: 1
                            });
                        }

                        if (p.rarity === 'legendary' || p.rarity === 'epic') {
                            vibrate('success');
                        } else {
                            vibrate('light');
                        }
                    }
                }

                if (p.x < -50 || p.collected) {
                    parts.splice(i, 1);
                }
            });
        }

        function updateDifficulty() {
            if (speedMult < CONFIG.DIFFICULTY.MAX_SPEED) {
                speedMult += CONFIG.DIFFICULTY.SPEED_INC;
            }
            document.getElementById('hudSpeed').textContent = '‚ö° x' + speedMult.toFixed(1);
        }

        function updateParticles() {
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2;
                p.life -= 0.02;
                p.size *= 0.98;

                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            });
        }

        // ==========================================
        // DRAW
        // ==========================================
        function drawBg() {
            // Sky gradient
            const grad = ctx.createLinearGradient(0, 0, 0, H);
            grad.addColorStop(0, '#1a1a2e');
            grad.addColorStop(0.5, '#16213e');
            grad.addColorStop(1, '#0f3460');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);

            // Stars
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            for (let i = 0; i < 50; i++) {
                const x = (i * 73 + frameCount * 0.1) % W;
                const y = (i * 47) % (H * 0.6);
                ctx.beginPath();
                ctx.arc(x, y, Math.random() * 1.5 + 0.5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Clouds
            ctx.fillStyle = 'rgba(255,255,255,0.05)';
            for (let i = 0; i < 5; i++) {
                const x = ((i * 200 - frameCount * 0.5) % (W + 200)) - 100;
                const y = 100 + i * 80;
                ctx.beginPath();
                ctx.ellipse(x, y, 80, 30, 0, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.rot);

            // Glow
            ctx.shadowColor = '#4a6cf7';
            ctx.shadowBlur = 20;

            // Body
            ctx.fillStyle = '#e8e8e8';
            ctx.beginPath();
            ctx.ellipse(0, 0, 25, 12, 0, 0, Math.PI * 2);
            ctx.fill();

            // Cockpit
            ctx.fillStyle = '#4a6cf7';
            ctx.beginPath();
            ctx.ellipse(15, -2, 8, 6, 0.2, 0, Math.PI * 2);
            ctx.fill();

            // Wings
            ctx.fillStyle = '#c0c0c0';
            ctx.beginPath();
            ctx.moveTo(-5, 0);
            ctx.lineTo(-15, -20);
            ctx.lineTo(5, -20);
            ctx.lineTo(5, 0);
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(-5, 0);
            ctx.lineTo(-15, 20);
            ctx.lineTo(5, 20);
            ctx.lineTo(5, 0);
            ctx.fill();

            // Tail
            ctx.fillStyle = '#4a6cf7';
            ctx.beginPath();
            ctx.moveTo(-25, 0);
            ctx.lineTo(-35, -12);
            ctx.lineTo(-25, -10);
            ctx.fill();

            // Engine trail
            ctx.shadowBlur = 0;
            const trailLen = 15 + Math.random() * 10;
            const trailGrad = ctx.createLinearGradient(-25, 0, -25 - trailLen, 0);
            trailGrad.addColorStop(0, 'rgba(255,150,50,0.8)');
            trailGrad.addColorStop(1, 'rgba(255,100,50,0)');
            ctx.fillStyle = trailGrad;
            ctx.beginPath();
            ctx.moveTo(-25, -3);
            ctx.lineTo(-25 - trailLen, 0);
            ctx.lineTo(-25, 3);
            ctx.fill();

            ctx.restore();
        }

        function drawObstacles() {
            obstacles.forEach(o => {
                // Gradient for 3D effect
                const grad = ctx.createLinearGradient(o.x, 0, o.x + CONFIG.OBSTACLES.WIDTH, 0);
                grad.addColorStop(0, '#2d4a6f');
                grad.addColorStop(0.5, '#4a7caa');
                grad.addColorStop(1, '#2d4a6f');

                ctx.fillStyle = grad;

                // Top obstacle
                ctx.fillRect(o.x, 0, CONFIG.OBSTACLES.WIDTH, o.top);
                // Bottom obstacle
                ctx.fillRect(o.x, o.bottom, CONFIG.OBSTACLES.WIDTH, H - o.bottom);

                // Caps
                ctx.fillStyle = '#5a9fd4';
                ctx.fillRect(o.x - 5, o.top - 20, CONFIG.OBSTACLES.WIDTH + 10, 20);
                ctx.fillRect(o.x - 5, o.bottom, CONFIG.OBSTACLES.WIDTH + 10, 20);

                // Warning lights
                ctx.fillStyle = '#ff4444';
                ctx.beginPath();
                ctx.arc(o.x + CONFIG.OBSTACLES.WIDTH / 2, o.top - 10, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(o.x + CONFIG.OBSTACLES.WIDTH / 2, o.bottom + 10, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawParts() {
            parts.forEach(p => {
                if (p.collected) return;

                ctx.save();
                ctx.translate(p.x, p.y);

                // Glow based on rarity
                const glowColors = {
                    common: 'rgba(150,150,150,0.3)',
                    uncommon: 'rgba(46,204,113,0.4)',
                    rare: 'rgba(74,108,247,0.5)',
                    epic: 'rgba(155,89,182,0.6)',
                    legendary: 'rgba(240,185,11,0.8)'
                };

                ctx.shadowColor = glowColors[p.rarity];
                ctx.shadowBlur = 15 + p.glow * 10;

                // Background circle
                ctx.fillStyle = getRarityBg(p.rarity);
                ctx.beginPath();
                ctx.arc(0, 0, 22, 0, Math.PI * 2);
                ctx.fill();

                // Icon
                ctx.shadowBlur = 0;
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(p.icon, 0, 0);

                // Value label for rare+
                if (p.rarity !== 'common') {
                    ctx.font = 'bold 9px Inter';
                    ctx.fillStyle = 'white';
                    ctx.fillText('$' + formatMoney(p.value), 0, 32);
                }

                ctx.restore();
            });
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        // ==========================================
        // HELPERS
        // ==========================================
        function getRarityColor(rarity) {
            const colors = {
                common: '#9ca3af',
                uncommon: '#2ecc71',
                rare: '#4a6cf7',
                epic: '#9b59b6',
                legendary: '#f0b90b'
            };
            return colors[rarity] || '#fff';
        }

        function getRarityBg(rarity) {
            const colors = {
                common: 'rgba(100,100,100,0.8)',
                uncommon: 'rgba(46,204,113,0.8)',
                rare: 'rgba(74,108,247,0.8)',
                epic: 'rgba(155,89,182,0.8)',
                legendary: 'rgba(240,185,11,0.9)'
            };
            return colors[rarity] || 'rgba(100,100,100,0.8)';
        }

        function formatMoney(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
            return n.toString();
        }

        function showPartPopup(part) {
            const popup = document.createElement('div');
            popup.className = 'part-popup';
            popup.style.left = part.x + 'px';
            popup.style.top = (part.y - 30) + 'px';
            popup.style.color = getRarityColor(part.rarity);
            popup.innerHTML = `+$${part.value.toLocaleString()}`;
            document.querySelector('.game-container').appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }

        // ==========================================
        // UI
        // ==========================================
        const $ = id => document.getElementById(id);

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (id) $(id).classList.add('active');
        }

        function updateMenuStats() {
            $('totalMoney').textContent = stats.money.toLocaleString();
            $('totalRfq').textContent = stats.rfq;
            $('totalParts').textContent = stats.parts;
            $('totalGames').textContent = stats.games;
        }

        // ==========================================
        // EVENTS
        // ==========================================
        canvas.addEventListener('click', jump);
        canvas.addEventListener('touchstart', e => { e.preventDefault(); jump(); });
        document.addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); jump(); } });

        $('btnPlay').onclick = showRfqScreen;
        $('btnStartRfq').onclick = startGame;
        $('btnSkipRfq').onclick = () => { currentRfq = null; startGame(); };
        $('btnRetry').onclick = showRfqScreen;
        $('btnHome').onclick = () => { showScreen('mainMenu'); updateMenuStats(); };
        $('btnLeaderboard').onclick = () => alert('–°–∫–æ—Ä–æ!');

        // ==========================================
        // GAME LOOP
        // ==========================================
        function loop() {
            drawBg();
            drawObstacles();
            drawParts();
            drawPlayer();
            drawParticles();

            if (gameState === 'playing') {
                updatePlayer();
                updateObstacles();
                updateParts();
                updateDifficulty();
            }

            updateParticles();
            frameCount++;
            requestAnimationFrame(loop);
        }

        // ==========================================
        // INIT
        // ==========================================
        updateMenuStats();
        loop();
    </script>
</body>
</html>
