<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#00005a">
    <title>Aviation Parts Runner v6.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --avs-navy: #00005a;
            --avs-navy-light: #000080;
            --avs-white: #ffffff;
            --avs-white-90: rgba(255,255,255,0.9);
            --avs-white-70: rgba(255,255,255,0.7);
            --avs-white-50: rgba(255,255,255,0.5);
            --avs-white-30: rgba(255,255,255,0.3);
            --avs-white-15: rgba(255,255,255,0.15);
            --avs-white-10: rgba(255,255,255,0.1);
            --avs-gold: #c9a227;
            --avs-red: #dc3545;
            --avs-green: #28a745;
            --avs-cyan: #17a2b8;
            --safe-top: 100px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; background: var(--avs-navy); font-family: 'Montserrat', sans-serif; overflow: hidden; touch-action: manipulation; user-select: none; color: var(--avs-white); }
        ::-webkit-scrollbar { width: 6px; background: var(--avs-navy); }
        ::-webkit-scrollbar-thumb { background: var(--avs-white-30); border-radius: 6px; }
        .game-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #gameCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* HUD */
        .hud { position: absolute; top: 0; left: 0; width: 100%; padding: calc(var(--safe-top) + 8px) 12px 12px; pointer-events: none; z-index: 10; opacity: 0; transition: opacity 0.3s; }
        .hud.visible { opacity: 1; }
        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
        .hud-box { background: rgba(0,0,90,0.8); border: 1px solid var(--avs-white-30); padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; backdrop-filter: blur(10px); }
        .hud-money { color: var(--avs-gold); font-size: 14px; font-weight: 700; }
        .hud-combo { color: #ff6b6b; font-size: 16px; font-weight: 800; display: none; }
        .hud-combo.active { display: block; animation: comboPulse 0.3s ease; }
        @keyframes comboPulse { 0% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .hud-fuel { display: flex; align-items: center; gap: 6px; }
        .hud-fuel-bar { width: 60px; height: 8px; background: var(--avs-white-15); border-radius: 4px; overflow: hidden; }
        .hud-fuel-fill { height: 100%; background: linear-gradient(90deg, var(--avs-red), var(--avs-gold), var(--avs-green)); transition: width 0.3s; }
        .hud-location { font-size: 10px; color: var(--avs-white-70); text-transform: uppercase; letter-spacing: 1px; }
        .hud-weather { font-size: 16px; }
        .hud-right { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
        .hud-nearmiss { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: 900; color: var(--avs-gold); text-shadow: 0 0 20px var(--avs-gold); opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .hud-nearmiss.show { opacity: 1; animation: nearMissAnim 0.5s ease; }
        @keyframes nearMissAnim { 0% { transform: translate(-50%, -50%) scale(0.5); } 50% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); } }

        /* Boss HUD */
        .boss-hud { position: absolute; top: calc(var(--safe-top) + 60px); left: 50%; transform: translateX(-50%); width: 70%; max-width: 250px; display: none; z-index: 15; }
        .boss-hud.show { display: block; }
        .boss-name { font-size: 10px; font-weight: 800; color: var(--avs-red); text-align: center; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
        .boss-hp-bar { height: 8px; background: rgba(0,0,0,0.5); border: 1px solid var(--avs-red); border-radius: 4px; overflow: hidden; }
        .boss-hp-fill { height: 100%; background: linear-gradient(90deg, #ff0000, #ff6666); transition: width 0.2s; }

        /* Screens */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; z-index: 20; opacity: 0; pointer-events: none; transition: opacity 0.3s; overflow-y: auto; background: var(--avs-navy); }
        .screen.active { opacity: 1; pointer-events: auto; }
        .screen-header { display: flex; align-items: center; padding: calc(var(--safe-top) + 8px) 16px 12px; background: var(--avs-navy); border-bottom: 1px solid var(--avs-white-15); position: sticky; top: 0; z-index: 5; }
        .btn-back { width: 36px; height: 36px; background: transparent; border: 1px solid var(--avs-white-30); border-radius: 8px; color: var(--avs-white); font-size: 16px; cursor: pointer; }
        .screen-title { flex: 1; text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-right: 36px; }

        /* Main Menu */
        .menu-content { padding: calc(var(--safe-top) + 10px) 16px 20px; display: flex; flex-direction: column; align-items: center; min-height: 100%; }
        .logo-section { text-align: center; margin-bottom: 16px; }
        .logo-badge { display: inline-block; background: var(--avs-white); color: var(--avs-navy); padding: 4px 12px; border-radius: 4px; font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .logo-title { font-size: 22px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }
        .player-rank { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px; }
        .rank-badge { padding: 4px 12px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .rank-bronze { background: linear-gradient(135deg, #cd7f32, #8b4513); }
        .rank-silver { background: linear-gradient(135deg, #c0c0c0, #808080); }
        .rank-gold { background: linear-gradient(135deg, #ffd700, #daa520); color: #000; }
        .rank-platinum { background: linear-gradient(135deg, #e5e4e2, #a8a8a8); color: #000; }
        .rank-legend { background: linear-gradient(135deg, #9400d3, #4b0082); }

        /* Stats Card */
        .stats-card { width: 100%; background: var(--avs-white-10); border: 1px solid var(--avs-white-15); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
        .stats-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .stats-money { font-size: 26px; font-weight: 900; color: var(--avs-gold); }
        .stats-vip { background: linear-gradient(135deg, var(--avs-gold), #f4d03f); color: #000; padding: 4px 10px; border-radius: 10px; font-size: 9px; font-weight: 800; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .stats-item { text-align: center; padding: 8px 4px; background: var(--avs-white-10); border-radius: 6px; }
        .stats-item-value { font-size: 14px; font-weight: 800; }
        .stats-item-label { font-size: 7px; color: var(--avs-white-50); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

        /* Daily Rewards */
        .daily-card { width: 100%; background: linear-gradient(135deg, rgba(201,162,39,0.2), rgba(201,162,39,0.05)); border: 1px solid var(--avs-gold); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
        .daily-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .daily-title { font-size: 10px; font-weight: 700; color: var(--avs-gold); text-transform: uppercase; letter-spacing: 1px; }
        .daily-streak { font-size: 10px; color: var(--avs-white-70); }
        .daily-days { display: flex; gap: 6px; }
        .daily-day { flex: 1; text-align: center; padding: 8px 4px; background: var(--avs-white-10); border-radius: 6px; font-size: 10px; }
        .daily-day.claimed { background: var(--avs-green); color: #000; }
        .daily-day.today { border: 2px solid var(--avs-gold); animation: todayPulse 1s infinite; }
        @keyframes todayPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(201,162,39,0.4); } 50% { box-shadow: 0 0 10px 3px rgba(201,162,39,0.2); } }
        .daily-day-num { font-weight: 700; }
        .daily-day-reward { font-size: 8px; color: var(--avs-white-50); margin-top: 2px; }

        /* Buttons */
        .menu-buttons { width: 100%; display: flex; flex-direction: column; gap: 8px; }
        .btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 20px; font-family: inherit; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--avs-white); color: var(--avs-navy); }
        .btn-secondary { background: transparent; color: var(--avs-white); border: 1px solid var(--avs-white-30); }
        .btn-gold { background: linear-gradient(135deg, var(--avs-gold), #f4d03f); color: #000; }
        .btn-red { background: var(--avs-red); color: var(--avs-white); }
        .menu-row { display: flex; gap: 8px; width: 100%; }
        .menu-row .btn { flex: 1; font-size: 9px; padding: 12px 8px; }

        /* Location Selector */
        .location-selector { width: 100%; margin-bottom: 12px; }
        .location-title { font-size: 9px; color: var(--avs-white-50); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; text-align: center; }
        .location-cards { display: flex; gap: 8px; overflow-x: auto; padding: 4px; }
        .location-card { min-width: 90px; padding: 12px 8px; background: var(--avs-white-10); border: 1px solid var(--avs-white-15); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        .location-card.selected { border-color: var(--avs-gold); background: rgba(201,162,39,0.15); }
        .location-card.locked { opacity: 0.5; }
        .location-icon { font-size: 24px; margin-bottom: 4px; }
        .location-name { font-size: 9px; font-weight: 700; }
        .location-unlock { font-size: 7px; color: var(--avs-gold); margin-top: 2px; }

        /* Shop */
        .shop-content { padding: 12px; }
        .shop-tabs { display: flex; gap: 6px; margin-bottom: 12px; overflow-x: auto; }
        .shop-tab { padding: 10px 16px; background: var(--avs-white-10); border: 1px solid var(--avs-white-15); border-radius: 8px; font-size: 10px; font-weight: 600; white-space: nowrap; cursor: pointer; }
        .shop-tab.active { background: var(--avs-white); color: var(--avs-navy); }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .shop-item { background: var(--avs-white-10); border: 1px solid var(--avs-white-15); border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; }
        .shop-item.owned { border-color: var(--avs-green); }
        .shop-item-icon { font-size: 32px; margin-bottom: 6px; }
        .shop-item-name { font-size: 11px; font-weight: 700; }
        .shop-item-desc { font-size: 8px; color: var(--avs-white-50); margin: 4px 0; }
        .shop-item-price { font-size: 11px; font-weight: 800; color: var(--avs-gold); }
        .shop-item-price.owned { color: var(--avs-green); }
        .shop-item-price.stars { color: #9b59b6; }

        /* Achievements */
        .achieve-list { padding: 12px; }
        .achieve-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--avs-white-10); border: 1px solid var(--avs-white-15); border-radius: 8px; margin-bottom: 8px; }
        .achieve-item.unlocked { border-color: var(--avs-gold); background: rgba(201,162,39,0.1); }
        .achieve-icon { font-size: 28px; }
        .achieve-info { flex: 1; }
        .achieve-name { font-size: 12px; font-weight: 700; }
        .achieve-desc { font-size: 9px; color: var(--avs-white-50); margin-top: 2px; }
        .achieve-progress { height: 4px; background: var(--avs-white-15); border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .achieve-progress-fill { height: 100%; background: var(--avs-gold); }
        .achieve-reward { font-size: 10px; font-weight: 700; color: var(--avs-gold); }

        /* Wheel */
        .wheel-container { padding: 20px; text-align: center; }
        .wheel-wrapper { position: relative; width: 250px; height: 250px; margin: 20px auto; }
        .wheel { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--avs-gold); position: relative; overflow: hidden; transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); }
        .wheel-segment { position: absolute; width: 50%; height: 50%; left: 50%; top: 0; transform-origin: 0% 100%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .wheel-pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 30px; z-index: 5; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: var(--avs-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 3; }
        .wheel-spin-btn { margin-top: 20px; }
        .wheel-timer { font-size: 12px; color: var(--avs-white-50); margin-top: 10px; }

        /* Leaderboard */
        .lb-content { padding: 12px; }
        .lb-list { display: flex; flex-direction: column; gap: 8px; }
        .lb-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--avs-white-10); border: 1px solid var(--avs-white-15); border-radius: 8px; }
        .lb-item.me { border-color: var(--avs-gold); }
        .lb-rank { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; border-radius: 6px; background: var(--avs-white-10); }
        .lb-rank.gold { background: var(--avs-gold); color: #000; }
        .lb-rank.silver { background: #c0c0c0; color: #000; }
        .lb-rank.bronze { background: #cd7f32; }
        .lb-info { flex: 1; min-width: 0; }
        .lb-name { font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .lb-stats { font-size: 9px; color: var(--avs-white-50); }
        .lb-score { font-size: 14px; font-weight: 900; color: var(--avs-gold); }

        /* Game Over */
        .gameover-screen { justify-content: center; align-items: center; padding: 20px; }
        .gameover-icon { font-size: 50px; margin-bottom: 12px; }
        .gameover-title { font-size: 11px; color: var(--avs-white-50); text-transform: uppercase; letter-spacing: 2px; }
        .gameover-money { font-size: 42px; font-weight: 900; color: var(--avs-gold); margin: 8px 0; }
        .gameover-stats { display: flex; gap: 20px; margin: 16px 0; }
        .gameover-stat { text-align: center; }
        .gameover-stat-value { font-size: 18px; font-weight: 800; }
        .gameover-stat-label { font-size: 8px; color: var(--avs-white-50); text-transform: uppercase; margin-top: 2px; }
        .gameover-buttons { width: 100%; max-width: 250px; display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }

        .menu-footer { margin-top: auto; padding-top: 16px; text-align: center; font-size: 9px; color: var(--avs-white-30); }
        .menu-footer a { color: var(--avs-white-50); text-decoration: none; }
    </style>
</head>
<body>
<div class="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div class="hud" id="hud">
        <div class="hud-top">
            <div>
                <div class="hud-box hud-money">$<span id="hudMoney">0</span></div>
                <div class="hud-box hud-combo" id="hudCombo">x1</div>
                <div class="hud-box hud-fuel">
                    <span>‚õΩ</span>
                    <div class="hud-fuel-bar"><div class="hud-fuel-fill" id="hudFuelFill" style="width:100%"></div></div>
                </div>
            </div>
            <div style="text-align:center;">
                <div class="hud-box hud-location" id="hudLocation">Moscow</div>
                <div class="hud-weather" id="hudWeather">‚òÄÔ∏è</div>
            </div>
            <div class="hud-right">
                <div class="hud-box" id="hudParts">üì¶ 0</div>
                <div class="hud-box" id="hudScore">üéØ 0</div>
            </div>
        </div>
        <div class="hud-nearmiss" id="hudNearMiss">NEAR MISS! +$500</div>
    </div>

    <div class="boss-hud" id="bossHud">
        <div class="boss-name" id="bossName">‚ö†Ô∏è BOSS ‚ö†Ô∏è</div>
        <div class="boss-hp-bar"><div class="boss-hp-fill" id="bossHpFill"></div></div>
    </div>

    <!-- Main Menu -->
    <div class="screen active" id="mainMenu">
        <div class="menu-content">
            <div class="logo-section">
                <div class="logo-badge">v6.0 Ultimate</div>
                <div class="logo-title">Aviation<br>Parts Runner</div>
                <div class="player-rank">
                    <span class="rank-badge" id="playerRank">Bronze</span>
                </div>
            </div>

            <div class="stats-card">
                <div class="stats-top">
                    <div class="stats-money">$<span id="menuMoney">0</span></div>
                    <div class="stats-vip" id="vipBadge" style="display:none;">‚≠ê VIP</div>
                </div>
                <div class="stats-grid">
                    <div class="stats-item"><div class="stats-item-value" id="menuGames">0</div><div class="stats-item-label">Flights</div></div>
                    <div class="stats-item"><div class="stats-item-value" id="menuParts">0</div><div class="stats-item-label">Parts</div></div>
                    <div class="stats-item"><div class="stats-item-value" id="menuBosses">0</div><div class="stats-item-label">Bosses</div></div>
                    <div class="stats-item"><div class="stats-item-value" id="menuLevel">1</div><div class="stats-item-label">Level</div></div>
                </div>
            </div>

            <div class="daily-card" id="dailyCard">
                <div class="daily-header">
                    <div class="daily-title">üéÅ Daily Rewards</div>
                    <div class="daily-streak">Day <span id="streakDay">1</span>/7</div>
                </div>
                <div class="daily-days" id="dailyDays"></div>
            </div>

            <div class="location-selector">
                <div class="location-title">Select Location</div>
                <div class="location-cards" id="locationCards"></div>
            </div>

            <div class="menu-buttons">
                <button class="btn btn-primary" id="btnPlay">‚úàÔ∏è Start Flight</button>
                <div class="menu-row">
                    <button class="btn btn-red" id="btnBoss">üëπ Boss</button>
                    <button class="btn btn-gold" id="btnWheel">üé° Wheel</button>
                </div>
                <div class="menu-row">
                    <button class="btn btn-secondary" id="btnShop">üõí Shop</button>
                    <button class="btn btn-secondary" id="btnAchieve">üèÜ Achieve</button>
                    <button class="btn btn-secondary" id="btnLB">üìä Top</button>
                </div>
            </div>

            <div class="menu-footer">
                <a href="https://jet-avia.ru" target="_blank">jet-avia.ru</a> ‚Ä¢ Aviation Service
            </div>
        </div>
    </div>

    <!-- Shop -->
    <div class="screen" id="shopScreen">
        <div class="screen-header">
            <button class="btn-back" id="shopBack">‚Üê</button>
            <div class="screen-title">Shop</div>
        </div>
        <div class="shop-content">
            <div class="shop-tabs">
                <div class="shop-tab active" data-tab="planes">‚úàÔ∏è Planes</div>
                <div class="shop-tab" data-tab="skins">üé® Skins</div>
                <div class="shop-tab" data-tab="upgrades">‚ö° Upgrades</div>
                <div class="shop-tab" data-tab="vip">‚≠ê VIP</div>
            </div>
            <div class="shop-grid" id="shopGrid"></div>
        </div>
    </div>

    <!-- Achievements -->
    <div class="screen" id="achieveScreen">
        <div class="screen-header">
            <button class="btn-back" id="achieveBack">‚Üê</button>
            <div class="screen-title">Achievements</div>
        </div>
        <div class="achieve-list" id="achieveList"></div>
    </div>

    <!-- Wheel -->
    <div class="screen" id="wheelScreen">
        <div class="screen-header">
            <button class="btn-back" id="wheelBack">‚Üê</button>
            <div class="screen-title">Lucky Wheel</div>
        </div>
        <div class="wheel-container">
            <div class="wheel-wrapper">
                <div class="wheel-pointer">üîª</div>
                <div class="wheel" id="wheel"></div>
                <div class="wheel-center">üé∞</div>
            </div>
            <button class="btn btn-gold wheel-spin-btn" id="btnSpin">üé° SPIN!</button>
            <div class="wheel-timer" id="wheelTimer"></div>
        </div>
    </div>

    <!-- Leaderboard -->
    <div class="screen" id="lbScreen">
        <div class="screen-header">
            <button class="btn-back" id="lbBack">‚Üê</button>
            <div class="screen-title">Leaderboard</div>
        </div>
        <div class="lb-content">
            <div class="lb-list" id="lbList"></div>
        </div>
    </div>

    <!-- Game Over -->
    <div class="screen gameover-screen" id="gameoverScreen">
        <div class="gameover-icon" id="goIcon">‚úàÔ∏è</div>
        <div class="gameover-title">Flight Complete</div>
        <div class="gameover-money">$<span id="goMoney">0</span></div>
        <div class="gameover-stats">
            <div class="gameover-stat"><div class="gameover-stat-value" id="goParts">0</div><div class="gameover-stat-label">Parts</div></div>
            <div class="gameover-stat"><div class="gameover-stat-value" id="goCombo">x1</div><div class="gameover-stat-label">Max Combo</div></div>
            <div class="gameover-stat"><div class="gameover-stat-value" id="goNearMiss">0</div><div class="gameover-stat-label">Near Miss</div></div>
        </div>
        <div class="gameover-buttons">
            <button class="btn btn-primary" id="btnRetry">üîÑ Retry</button>
            <button class="btn btn-secondary" id="btnHome">üè† Menu</button>
        </div>
    </div>
</div>

<script>
// ==========================================
// AVIATION PARTS RUNNER v6.0 - ULTIMATE
// ==========================================
const SUPABASE_URL='https://imqoksswffkufknkbofm.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltcW9rc3N3ZmZrdWZrbmtib2ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NzE2ODYsImV4cCI6MjA4MzA0NzY4Nn0.wcH5yZGRSzIkE0qjb_IIDSt3S-q3ylsBLJPT3Of-T78';

// === LOCATIONS ===
const LOCATIONS=[
    {id:'moscow',name:'Moscow',icon:'üè∞',unlock:0,bg:{sky1:'#1a1a4a',sky2:'#00005a',ground:'#2a3a4a'},music:110},
    {id:'dubai',name:'Dubai',icon:'üèúÔ∏è',unlock:50000,bg:{sky1:'#ff9966',sky2:'#ff5e62',ground:'#d4a574'},music:130},
    {id:'newyork',name:'New York',icon:'üóΩ',unlock:150000,bg:{sky1:'#2c3e50',sky2:'#3498db',ground:'#34495e'},music:120},
    {id:'tokyo',name:'Tokyo',icon:'üóº',unlock:300000,bg:{sky1:'#e96443',sky2:'#904e95',ground:'#4a4a6a'},music:140},
    {id:'paris',name:'Paris',icon:'üóº',unlock:500000,bg:{sky1:'#ff758c',sky2:'#ff7eb3',ground:'#5a4a5a'},music:100}
];

// === WEATHER ===
const WEATHER=[
    {id:'clear',name:'Clear',icon:'‚òÄÔ∏è',effect:null,chance:0.4},
    {id:'clouds',name:'Cloudy',icon:'‚òÅÔ∏è',effect:'clouds',chance:0.25},
    {id:'rain',name:'Rain',icon:'üåßÔ∏è',effect:'rain',chance:0.15},
    {id:'storm',name:'Storm',icon:'‚õàÔ∏è',effect:'storm',chance:0.1},
    {id:'fog',name:'Fog',icon:'üå´Ô∏è',effect:'fog',chance:0.1}
];

// === PARTS ===
const PARTS=[
    {id:'oring',name:'O-Ring',icon:'‚≠ï',rarity:'common',value:10,chance:0.20,dmg:1},
    {id:'washer',name:'Washer',icon:'üîò',rarity:'common',value:20,chance:0.18,dmg:1},
    {id:'rivet',name:'Rivet',icon:'üìç',rarity:'common',value:30,chance:0.18,dmg:2},
    {id:'valve',name:'Valve',icon:'üîß',rarity:'uncommon',value:200,chance:0.12,dmg:3},
    {id:'filter',name:'Filter',icon:'üßΩ',rarity:'uncommon',value:300,chance:0.10,dmg:4},
    {id:'bearing',name:'Bearing',icon:'‚öôÔ∏è',rarity:'uncommon',value:500,chance:0.08,dmg:5},
    {id:'fuelpump',name:'Fuel Pump',icon:'‚õΩ',rarity:'rare',value:2000,chance:0.05,dmg:8},
    {id:'actuator',name:'Actuator',icon:'üîå',rarity:'rare',value:3000,chance:0.04,dmg:10},
    {id:'sensor',name:'Sensor',icon:'üì°',rarity:'rare',value:5000,chance:0.03,dmg:12},
    {id:'hmu',name:'HMU',icon:'üéõÔ∏è',rarity:'epic',value:20000,chance:0.012,dmg:20},
    {id:'apu',name:'APU',icon:'üîã',rarity:'legendary',value:100000,chance:0.003,dmg:50}
];

// === PLANES ===
const PLANES=[
    {id:'cessna',name:'Cessna 172',icon:'üõ©Ô∏è',price:0,mult:1.0},
    {id:'boeing',name:'Boeing 737',icon:'‚úàÔ∏è',price:100000,mult:1.2},
    {id:'airbus',name:'Airbus A320',icon:'üõ´',price:250000,mult:1.5},
    {id:'jet',name:'Private Jet',icon:'üöÄ',price:500000,mult:2.0},
    {id:'fighter',name:'F-16',icon:'üõ∏',price:1000000,mult:3.0}
];

// === SKINS ===
const SKINS=[
    {id:'default',name:'Default',icon:'‚¨ú',price:0,colors:['#ffffff','#cc2936']},
    {id:'gold',name:'Gold',icon:'üü°',price:50000,colors:['#ffd700','#daa520']},
    {id:'neon',name:'Neon',icon:'üü¢',price:75000,colors:['#00ff00','#00ffff']},
    {id:'fire',name:'Fire',icon:'üî¥',price:100000,colors:['#ff4500','#ff0000']},
    {id:'galaxy',name:'Galaxy',icon:'üü£',price:200000,colors:['#9400d3','#4b0082']},
    {id:'rainbow',name:'Rainbow',icon:'üåà',price:500000,colors:['rainbow']}
];

// === UPGRADES ===
const UPGRADES=[
    {id:'magnet',name:'Magnet',icon:'üß≤',price:10000,desc:'+50% range'},
    {id:'shield',name:'Shield',icon:'üõ°Ô∏è',price:25000,desc:'1 hit protect'},
    {id:'turbo',name:'Turbo',icon:'‚ö°',price:15000,desc:'Speed boost'},
    {id:'fuel',name:'Fuel Tank',icon:'‚õΩ',price:30000,desc:'+50% fuel'},
    {id:'combo',name:'Combo Master',icon:'üî•',price:40000,desc:'Slower decay'}
];

// === ACHIEVEMENTS ===
const ACHIEVEMENTS=[
    {id:'first_flight',name:'First Flight',desc:'Complete your first flight',icon:'üõ´',goal:1,type:'games',reward:1000},
    {id:'collector_100',name:'Collector',desc:'Collect 100 parts',icon:'üì¶',goal:100,type:'parts',reward:5000},
    {id:'collector_1000',name:'Hoarder',desc:'Collect 1000 parts',icon:'üì¶',goal:1000,type:'parts',reward:25000},
    {id:'boss_slayer',name:'Boss Slayer',desc:'Defeat 10 bosses',icon:'üëπ',goal:10,type:'bosses',reward:50000},
    {id:'millionaire',name:'Millionaire',desc:'Earn $1,000,000 total',icon:'üí∞',goal:1000000,type:'totalMoney',reward:100000},
    {id:'combo_5',name:'Combo Master',desc:'Reach x5 combo',icon:'üî•',goal:5,type:'maxCombo',reward:10000},
    {id:'combo_10',name:'Combo Legend',desc:'Reach x10 combo',icon:'üî•',goal:10,type:'maxCombo',reward:50000},
    {id:'near_miss_10',name:'Daredevil',desc:'10 near misses in one game',icon:'üò±',goal:10,type:'nearMiss',reward:15000},
    {id:'all_locations',name:'World Traveler',desc:'Unlock all locations',icon:'üåç',goal:5,type:'locations',reward:200000}
];

// === WHEEL PRIZES ===
const WHEEL_PRIZES=[
    {icon:'üí∞',value:1000,label:'$1K'},
    {icon:'üí∞',value:5000,label:'$5K'},
    {icon:'üí∞',value:10000,label:'$10K'},
    {icon:'üíé',value:50000,label:'$50K'},
    {icon:'‚õΩ',value:'fuel',label:'Fuel'},
    {icon:'üõ°Ô∏è',value:'shield',label:'Shield'},
    {icon:'‚ö°',value:'turbo',label:'Turbo'},
    {icon:'‚ùå',value:0,label:'Nothing'}
];

// === DAILY REWARDS ===
const DAILY_REWARDS=[1000,2000,3000,5000,7500,10000,25000];

// === RANKS ===
const RANKS=[
    {name:'Bronze',min:0,class:'rank-bronze'},
    {name:'Silver',min:100000,class:'rank-silver'},
    {name:'Gold',min:500000,class:'rank-gold'},
    {name:'Platinum',min:1000000,class:'rank-platinum'},
    {name:'Legend',min:5000000,class:'rank-legend'}
];

// === CONFIG ===
const CFG={
    PLAYER:{X:100,JUMP:-11,GRAVITY:0.5,MAX_V:14},
    OBS:{W:55,GAP:190,SPEED:4,SPAWN:95,MIN_H:80},
    FUEL:{MAX:100,DRAIN:0.08,CANISTER:25},
    COMBO:{DECAY:120,MAX:10},
    NEAR_MISS:{DIST:15,BONUS:500},
    BOSS_SPAWN:12000
};

// === STATE ===
let W=400,H=700,safeTop=100;
let state='menu',money=0,parts=0,score=0,frame=0,speed=1,deltaTime=16,lastTime=0;
let player={x:0,y:0,v:0,rot:0};
let obstacles=[],items=[],particles=[],birds=[],fuelCans=[],projectiles=[],contrails=[];
let fuel=100,combo=1,comboTimer=0,maxCombo=1,nearMissCount=0;
let shieldOn=false,turboOn=false,turboT=0;
let currentWeather=WEATHER[0];
let dayNightCycle=0;
let gameMode='normal';
let boss=null,bossActive=false;

let stats=JSON.parse(localStorage.getItem('avs8'))||{
    money:0,totalMoney:0,xp:0,level:1,games:0,parts:0,best:0,bosses:0,maxCombo:1,
    planes:['cessna'],plane:'cessna',skins:['default'],skin:'default',upgrades:[],
    location:'moscow',unlockedLocations:['moscow'],
    dailyStreak:0,lastDaily:null,dailyClaimed:[],
    lastWheel:null,
    achievements:{},
    vip:false
};

const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');

function resize(){W=Math.max(window.innerWidth,360);H=Math.max(window.innerHeight,640);canvas.width=W;canvas.height=H;}
resize();window.addEventListener('resize',resize);

// Telegram
let tg=window.Telegram?.WebApp,tgUser={id:null,first_name:'Pilot'};
if(tg){tg.ready();tg.expand();if(tg.safeAreaInset)safeTop=Math.max(100,tg.safeAreaInset.top+50);document.documentElement.style.setProperty('--safe-top',safeTop+'px');if(tg.initDataUnsafe?.user)tgUser={id:tg.initDataUnsafe.user.id,first_name:tg.initDataUnsafe.user.first_name||'Pilot'};}
function vibrate(t='light'){if(tg?.HapticFeedback)tg.HapticFeedback.impactOccurred(t);}

// Audio
let audioCtx=null,masterGain=null;
function initAudio(){if(audioCtx)return;try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();masterGain=audioCtx.createGain();masterGain.gain.value=0.2;masterGain.connect(audioCtx.destination);}catch(e){}}
function playSound(type,freq=440){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(masterGain);const now=audioCtx.currentTime;if(type==='jump'){o.frequency.setValueAtTime(400,now);o.frequency.exponentialRampToValueAtTime(700,now+0.1);g.gain.setValueAtTime(0.1,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.1);o.start(now);o.stop(now+0.1);}else if(type==='collect'){o.type='triangle';o.frequency.setValueAtTime(freq,now);g.gain.setValueAtTime(0.08,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.1);o.start(now);o.stop(now+0.1);}else if(type==='crash'){o.type='sawtooth';o.frequency.setValueAtTime(150,now);o.frequency.exponentialRampToValueAtTime(30,now+0.4);g.gain.setValueAtTime(0.15,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.4);o.start(now);o.stop(now+0.4);}else if(type==='nearmiss'){o.frequency.setValueAtTime(800,now);o.frequency.exponentialRampToValueAtTime(1200,now+0.15);g.gain.setValueAtTime(0.1,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.15);o.start(now);o.stop(now+0.15);}else if(type==='combo'){o.type='square';o.frequency.setValueAtTime(600+combo*50,now);g.gain.setValueAtTime(0.08,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.1);o.start(now);o.stop(now+0.1);}}

// === HELPERS ===
const $=id=>document.getElementById(id);
function has(id){return stats.upgrades.includes(id);}
function planeMult(){return(PLANES.find(p=>p.id===stats.plane)||{mult:1}).mult;}
function getLocation(){return LOCATIONS.find(l=>l.id===stats.location)||LOCATIONS[0];}
function getRank(){let r=RANKS[0];for(const rank of RANKS)if(stats.totalMoney>=rank.min)r=rank;return r;}
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));if(id)$(id).classList.add('active');}
function save(){localStorage.setItem('avs8',JSON.stringify(stats));}

// === DAILY REWARDS ===
function checkDaily(){
    const today=new Date().toDateString();
    if(stats.lastDaily===today)return;
    const yesterday=new Date(Date.now()-86400000).toDateString();
    if(stats.lastDaily!==yesterday)stats.dailyStreak=0;
    stats.dailyClaimed=[];
}
function claimDaily(day){
    if(day>stats.dailyStreak||stats.dailyClaimed.includes(day))return;
    const reward=DAILY_REWARDS[day];
    stats.money+=reward;stats.totalMoney+=reward;
    stats.dailyClaimed.push(day);
    stats.dailyStreak++;stats.lastDaily=new Date().toDateString();
    save();renderDaily();updateMenu();vibrate('success');
}
function renderDaily(){
    checkDaily();
    $('streakDay').textContent=stats.dailyStreak+1;
    $('dailyDays').innerHTML=DAILY_REWARDS.map((r,i)=>{
        const claimed=stats.dailyClaimed.includes(i);
        const isToday=i===stats.dailyStreak;
        return`<div class="daily-day ${claimed?'claimed':''} ${isToday&&!claimed?'today':''}" onclick="${isToday&&!claimed?`claimDaily(${i})`:''}"><div class="daily-day-num">${i+1}</div><div class="daily-day-reward">${claimed?'‚úì':'$'+r}</div></div>`;
    }).join('');
}

// === LOCATIONS ===
function renderLocations(){
    $('locationCards').innerHTML=LOCATIONS.map(loc=>{
        const unlocked=stats.unlockedLocations.includes(loc.id);
        const selected=stats.location===loc.id;
        return`<div class="location-card ${selected?'selected':''} ${!unlocked?'locked':''}" onclick="selectLocation('${loc.id}')"><div class="location-icon">${loc.icon}</div><div class="location-name">${loc.name}</div>${!unlocked?`<div class="location-unlock">$${(loc.unlock/1000).toFixed(0)}K</div>`:''}</div>`;
    }).join('');
}
function selectLocation(id){
    const loc=LOCATIONS.find(l=>l.id===id);
    if(!loc)return;
    if(!stats.unlockedLocations.includes(id)){
        if(stats.money>=loc.unlock){stats.money-=loc.unlock;stats.unlockedLocations.push(id);save();vibrate('success');}else return;
    }
    stats.location=id;save();renderLocations();
}

// === WHEEL ===
function canSpin(){if(!stats.lastWheel)return true;return Date.now()-new Date(stats.lastWheel).getTime()>86400000;}
function renderWheel(){
    const wheel=$('wheel');
    wheel.innerHTML=WHEEL_PRIZES.map((p,i)=>{
        const angle=i*(360/WHEEL_PRIZES.length);
        const colors=['#cc2936','#00005a','#c9a227','#28a745','#cc2936','#00005a','#c9a227','#28a745'];
        return`<div class="wheel-segment" style="transform:rotate(${angle}deg) skewY(${90-360/WHEEL_PRIZES.length}deg);background:${colors[i]}">${p.icon}</div>`;
    }).join('');
    $('btnSpin').disabled=!canSpin();
    $('btnSpin').textContent=canSpin()?'üé° SPIN!':'‚è≥ Wait';
    if(!canSpin()){const next=new Date(stats.lastWheel).getTime()+86400000-Date.now();const h=Math.floor(next/3600000);const m=Math.floor((next%3600000)/60000);$('wheelTimer').textContent=`Next spin in ${h}h ${m}m`;}else{$('wheelTimer').textContent='';}
}
function spinWheel(){
    if(!canSpin())return;
    const idx=Math.floor(Math.random()*WHEEL_PRIZES.length);
    const prize=WHEEL_PRIZES[idx];
    const wheel=$('wheel');
    const deg=360*5+(360-idx*(360/WHEEL_PRIZES.length)-22.5);
    wheel.style.transform=`rotate(${deg}deg)`;
    stats.lastWheel=new Date().toISOString();save();
    $('btnSpin').disabled=true;
    setTimeout(()=>{
        if(typeof prize.value==='number'){stats.money+=prize.value;stats.totalMoney+=prize.value;}
        else if(prize.value==='shield')stats.upgrades.push('shield_temp');
        else if(prize.value==='turbo')stats.upgrades.push('turbo_temp');
        save();updateMenu();renderWheel();vibrate('success');
        alert(`You won: ${prize.label}!`);
    },4500);
}

// === ACHIEVEMENTS ===
function checkAchievements(){
    ACHIEVEMENTS.forEach(a=>{
        if(stats.achievements[a.id])return;
        let val=0;
        if(a.type==='games')val=stats.games;
        else if(a.type==='parts')val=stats.parts;
        else if(a.type==='bosses')val=stats.bosses;
        else if(a.type==='totalMoney')val=stats.totalMoney;
        else if(a.type==='maxCombo')val=stats.maxCombo;
        else if(a.type==='locations')val=stats.unlockedLocations.length;
        if(val>=a.goal){stats.achievements[a.id]=true;stats.money+=a.reward;stats.totalMoney+=a.reward;save();vibrate('success');}
    });
}
function renderAchievements(){
    $('achieveList').innerHTML=ACHIEVEMENTS.map(a=>{
        const unlocked=stats.achievements[a.id];
        let val=0;
        if(a.type==='games')val=stats.games;
        else if(a.type==='parts')val=stats.parts;
        else if(a.type==='bosses')val=stats.bosses;
        else if(a.type==='totalMoney')val=stats.totalMoney;
        else if(a.type==='maxCombo')val=stats.maxCombo;
        else if(a.type==='locations')val=stats.unlockedLocations.length;
        const prog=Math.min(val/a.goal*100,100);
        return`<div class="achieve-item ${unlocked?'unlocked':''}"><div class="achieve-icon">${a.icon}</div><div class="achieve-info"><div class="achieve-name">${a.name}</div><div class="achieve-desc">${a.desc}</div><div class="achieve-progress"><div class="achieve-progress-fill" style="width:${prog}%"></div></div></div><div class="achieve-reward">${unlocked?'‚úì':'$'+a.reward}</div></div>`;
    }).join('');
}

// === SHOP ===
let shopTab='planes';
function renderShop(){
    document.querySelectorAll('.shop-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===shopTab));
    let html='';
    if(shopTab==='planes'){
        html=PLANES.map(p=>{
            const own=stats.planes.includes(p.id);
            return`<div class="shop-item ${own?'owned':''}" onclick="buyPlane('${p.id}')"><div class="shop-item-icon">${p.icon}</div><div class="shop-item-name">${p.name}</div><div class="shop-item-desc">x${p.mult} money</div><div class="shop-item-price ${own?'owned':''}">${own?(stats.plane===p.id?'‚úì Selected':'Select'):'$'+(p.price/1000)+'K'}</div></div>`;
        }).join('');
    }else if(shopTab==='skins'){
        html=SKINS.map(s=>{
            const own=stats.skins.includes(s.id);
            return`<div class="shop-item ${own?'owned':''}" onclick="buySkin('${s.id}')"><div class="shop-item-icon">${s.icon}</div><div class="shop-item-name">${s.name}</div><div class="shop-item-price ${own?'owned':''}">${own?(stats.skin===s.id?'‚úì Selected':'Select'):'$'+(s.price/1000)+'K'}</div></div>`;
        }).join('');
    }else if(shopTab==='upgrades'){
        html=UPGRADES.map(u=>{
            const own=has(u.id);
            return`<div class="shop-item ${own?'owned':''}" onclick="buyUpgrade('${u.id}')"><div class="shop-item-icon">${u.icon}</div><div class="shop-item-name">${u.name}</div><div class="shop-item-desc">${u.desc}</div><div class="shop-item-price ${own?'owned':''}">${own?'‚úì':'$'+(u.price/1000)+'K'}</div></div>`;
        }).join('');
    }else if(shopTab==='vip'){
        html=`<div class="shop-item" onclick="buyVip()"><div class="shop-item-icon">‚≠ê</div><div class="shop-item-name">VIP Status</div><div class="shop-item-desc">x2 money, no ads, exclusive</div><div class="shop-item-price stars">${stats.vip?'‚úì Active':'100 ‚≠ê'}</div></div>`;
    }
    $('shopGrid').innerHTML=html;
}
function buyPlane(id){const p=PLANES.find(x=>x.id===id);if(stats.planes.includes(id)){stats.plane=id;save();renderShop();}else if(stats.money>=p.price){stats.money-=p.price;stats.planes.push(id);stats.plane=id;save();renderShop();updateMenu();vibrate('success');}}
function buySkin(id){const s=SKINS.find(x=>x.id===id);if(stats.skins.includes(id)){stats.skin=id;save();renderShop();}else if(stats.money>=s.price){stats.money-=s.price;stats.skins.push(id);stats.skin=id;save();renderShop();updateMenu();vibrate('success');}}
function buyUpgrade(id){const u=UPGRADES.find(x=>x.id===id);if(!has(id)&&stats.money>=u.price){stats.money-=u.price;stats.upgrades.push(id);save();renderShop();updateMenu();vibrate('success');}}
function buyVip(){if(tg&&!stats.vip){tg.openInvoice&&tg.openInvoice('vip_url');}}

// === LEADERBOARD ===
async function renderLeaderboard(){
    $('lbList').innerHTML='<div style="text-align:center;padding:40px;color:var(--avs-white-50)">Loading...</div>';
    try{
        const res=await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=*&order=best_score.desc&limit=20`,{headers:{'apikey':SUPABASE_KEY}});
        const data=await res.json();
        $('lbList').innerHTML=data.map((p,i)=>{
            const isMe=tgUser.id&&p.telegram_id===tgUser.id;
            const rc=i===0?'gold':i===1?'silver':i===2?'bronze':'';
            return`<div class="lb-item ${isMe?'me':''}"><div class="lb-rank ${rc}">${i+1}</div><div class="lb-info"><div class="lb-name">${p.first_name||'Pilot'}</div><div class="lb-stats">üéÆ${p.total_games||0} üì¶${p.total_parts||0}</div></div><div class="lb-score">$${(p.best_score||0).toLocaleString()}</div></div>`;
        }).join('')||'<div style="text-align:center;padding:40px">No data</div>';
    }catch(e){$('lbList').innerHTML='<div style="text-align:center;padding:40px">Error loading</div>';}
}

// === UPDATE MENU ===
function updateMenu(){
    $('menuMoney').textContent=stats.money.toLocaleString();
    $('menuGames').textContent=stats.games;
    $('menuParts').textContent=stats.parts;
    $('menuBosses').textContent=stats.bosses;
    $('menuLevel').textContent=stats.level;
    const rank=getRank();
    $('playerRank').textContent=rank.name;
    $('playerRank').className='rank-badge '+rank.class;
    if(stats.vip)$('vipBadge').style.display='block';
    renderDaily();renderLocations();checkAchievements();
}

// === GAME ===
function reset(){
    player={x:CFG.PLAYER.X,y:H/2,v:0,rot:0};
    obstacles=[];items=[];particles=[];birds=[];fuelCans=[];projectiles=[];contrails=[];
    money=0;parts=0;score=0;frame=0;speed=1;
    fuel=has('fuel')?150:100;
    combo=1;comboTimer=0;maxCombo=1;nearMissCount=0;
    shieldOn=has('shield');turboOn=false;turboT=0;
    boss=null;bossActive=false;$('bossHud').classList.remove('show');
    currentWeather=WEATHER[Math.floor(Math.random()*WEATHER.length)];
    dayNightCycle=Math.random();
}

function start(mode='normal'){initAudio();resize();gameMode=mode;reset();if(mode==='boss')setTimeout(()=>spawnBoss(),2000);state='playing';show(null);$('hud').classList.add('visible');$('hudLocation').textContent=getLocation().name;$('hudWeather').textContent=currentWeather.icon;}

function gameOver(){
    state='over';playSound('crash');vibrate('error');
    const earnedMoney=Math.floor(money*planeMult()*(stats.vip?2:1));
    stats.games++;stats.parts+=parts;stats.money+=earnedMoney;stats.totalMoney+=earnedMoney;
    if(earnedMoney>stats.best)stats.best=earnedMoney;
    if(maxCombo>stats.maxCombo)stats.maxCombo=maxCombo;
    stats.level=Math.floor(stats.totalMoney/50000)+1;
    save();checkAchievements();
    $('goMoney').textContent=earnedMoney.toLocaleString();
    $('goParts').textContent=parts;
    $('goCombo').textContent='x'+maxCombo;
    $('goNearMiss').textContent=nearMissCount;
    $('hud').classList.remove('visible');show('gameoverScreen');
}

function jump(){if(state!=='playing')return;player.v=CFG.PLAYER.JUMP;playSound('jump');vibrate('light');}

// === SPAWNING ===
function spawnObs(){const gap=CFG.OBS.GAP-(speed-1)*15;const minT=safeTop+CFG.OBS.MIN_H;const maxT=H-gap-CFG.OBS.MIN_H-70;const top=Math.random()*(maxT-minT)+minT;obstacles.push({x:W,top,bot:top+gap,pass:false,nearMissChecked:false});}
function spawnPart(){let r=Math.random(),c=0,d=PARTS[0];for(const p of PARTS){c+=p.chance;if(r<c){d=p;break;}}const y=safeTop+100+Math.random()*(H-safeTop-200);items.push({x:W+50,y,...d,col:false});}
function spawnBird(){birds.push({x:W,y:safeTop+50+Math.random()*(H-safeTop-150),vx:-3-Math.random()*2,vy:(Math.random()-0.5)*2,frame:0});}
function spawnFuel(){fuelCans.push({x:W+30,y:safeTop+100+Math.random()*(H-safeTop-200)});}
function spawnBoss(){const bosses=[{name:'Cargo Titan',icon:'üëπ',hp:100},{name:'Sky Bomber',icon:'üíÄ',hp:150},{name:'Shadow Wing',icon:'üëø',hp:200}];const b=bosses[Math.min(Math.floor(stats.bosses/3),2)];boss={...b,currentHp:b.hp,x:W-80,y:H/2,attackTimer:0};bossActive=true;$('bossHud').classList.add('show');$('bossName').textContent=b.name;vibrate('heavy');}

// === UPDATE ===
function updatePlayer(){const dt=deltaTime/16;player.v+=CFG.PLAYER.GRAVITY*dt;player.v=Math.min(player.v,CFG.PLAYER.MAX_V);player.y+=player.v*dt;player.rot=Math.min(Math.max(player.v*0.05,-0.4),0.6);if(player.y<safeTop+35){player.y=safeTop+35;player.v=0;}if(player.y>H-70){if(shieldOn){player.y=H-70;player.v=CFG.PLAYER.JUMP;shieldOn=false;vibrate('heavy');}else gameOver();}}

function updateObs(){
    const sp=CFG.OBS.SPEED*speed*(turboOn?1.5:1)*(deltaTime/16);
    if(frame%Math.max(Math.floor(CFG.OBS.SPAWN/speed),35)===0&&!bossActive)spawnObs();
    for(let i=obstacles.length-1;i>=0;i--){
        const o=obstacles[i];o.x-=sp;
        // Collision
        if(player.x+25>o.x&&player.x-25<o.x+CFG.OBS.W){
            if(player.y-18<o.top||player.y+18>o.bot){
                if(shieldOn){shieldOn=false;vibrate('heavy');}
                else{gameOver();return;}
            }
            // Near miss check
            if(!o.nearMissChecked){
                const topDist=Math.abs(player.y-18-o.top);
                const botDist=Math.abs(player.y+18-o.bot);
                if(topDist<CFG.NEAR_MISS.DIST||botDist<CFG.NEAR_MISS.DIST){
                    nearMissCount++;money+=CFG.NEAR_MISS.BONUS;score+=500;
                    $('hudNearMiss').classList.add('show');
                    setTimeout(()=>$('hudNearMiss').classList.remove('show'),500);
                    playSound('nearmiss');vibrate('light');
                    combo++;comboTimer=CFG.COMBO.DECAY*(has('combo')?1.5:1);
                    if(combo>maxCombo)maxCombo=combo;
                }
                o.nearMissChecked=true;
            }
        }
        if(!o.pass&&o.x+CFG.OBS.W<player.x){o.pass=true;score+=100;}
        if(o.x<-CFG.OBS.W)obstacles.splice(i,1);
    }
}

function updateParts(){
    const sp=CFG.OBS.SPEED*speed*(turboOn?1.5:1)*(deltaTime/16);
    if(frame%40===0)spawnPart();
    const mr=has('magnet')?120:80;
    for(let i=items.length-1;i>=0;i--){
        const p=items[i];p.x-=sp;
        if(!p.col){
            const dx=player.x-p.x,dy=player.y-p.y,d=Math.sqrt(dx*dx+dy*dy);
            if(d<mr&&d>30){p.x+=dx*0.15;p.y+=dy*0.15;}
            if(d<35){
                p.col=true;money+=p.value*combo;parts++;score+=p.value;
                combo++;comboTimer=CFG.COMBO.DECAY*(has('combo')?1.5:1);
                if(combo>CFG.COMBO.MAX)combo=CFG.COMBO.MAX;
                if(combo>maxCombo)maxCombo=combo;
                if(bossActive&&boss)boss.currentHp-=p.dmg;
                playSound('collect',500+p.value/10);vibrate('light');
            }
        }
        if(p.x<-50||p.col)items.splice(i,1);
    }
}

function updateBirds(){
    const sp=deltaTime/16;
    if(frame%200===0&&Math.random()<0.3)spawnBird();
    for(let i=birds.length-1;i>=0;i--){
        const b=birds[i];b.x+=b.vx*sp;b.y+=b.vy*sp;b.frame++;
        b.vy+=Math.sin(b.frame*0.1)*0.1;
        const dx=player.x-b.x,dy=player.y-b.y;
        if(Math.sqrt(dx*dx+dy*dy)<30){if(shieldOn){shieldOn=false;vibrate('heavy');}else{gameOver();return;}}
        if(b.x<-50)birds.splice(i,1);
    }
}

function updateFuel(){
    const sp=CFG.OBS.SPEED*speed*(deltaTime/16);
    fuel-=CFG.FUEL.DRAIN*(deltaTime/16);
    if(fuel<=0){gameOver();return;}
    if(frame%300===0&&Math.random()<0.4)spawnFuel();
    for(let i=fuelCans.length-1;i>=0;i--){
        const f=fuelCans[i];f.x-=sp;
        const dx=player.x-f.x,dy=player.y-f.y;
        if(Math.sqrt(dx*dx+dy*dy)<35){fuel=Math.min(fuel+CFG.FUEL.CANISTER,has('fuel')?150:100);fuelCans.splice(i,1);playSound('collect',800);vibrate('light');continue;}
        if(f.x<-50)fuelCans.splice(i,1);
    }
    $('hudFuelFill').style.width=(fuel/(has('fuel')?150:100)*100)+'%';
}

function updateCombo(){
    if(comboTimer>0){comboTimer-=deltaTime/16;if(comboTimer<=0)combo=1;}
    $('hudCombo').textContent='x'+combo;
    $('hudCombo').classList.toggle('active',combo>1);
}

function updateBoss(){
    if(!boss||!bossActive)return;
    boss.y+=Math.sin(frame*0.03)*2;boss.attackTimer++;
    if(boss.attackTimer>90){boss.attackTimer=0;projectiles.push({x:boss.x-30,y:boss.y,vx:-7,vy:(player.y-boss.y)*0.02});}
    $('bossHpFill').style.width=(boss.currentHp/boss.hp*100)+'%';
    if(boss.currentHp<=0){bossActive=false;stats.bosses++;money+=money*5;$('bossHud').classList.remove('show');vibrate('success');boss=null;}
}

function updateProjectiles(){
    for(let i=projectiles.length-1;i>=0;i--){
        const p=projectiles[i];p.x+=p.vx*(deltaTime/16);p.y+=p.vy*(deltaTime/16);
        if(Math.sqrt((player.x-p.x)**2+(player.y-p.y)**2)<35){if(shieldOn){shieldOn=false;vibrate('heavy');}else{gameOver();return;}projectiles.splice(i,1);continue;}
        if(p.x<-50)projectiles.splice(i,1);
    }
}

function updateContrails(){
    if(frame%3===0)contrails.push({x:player.x-40,y:player.y,alpha:0.5,size:4});
    for(let i=contrails.length-1;i>=0;i--){
        const c=contrails[i];c.x-=2;c.alpha-=0.01;c.size+=0.1;
        if(c.alpha<=0)contrails.splice(i,1);
    }
}

function updateParticles(){for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.2;p.life-=0.02;if(p.life<=0)particles.splice(i,1);}}

function updateDifficulty(){if(speed<3)speed+=0.0004;}

function updateHUD(){$('hudMoney').textContent=money.toLocaleString();$('hudParts').textContent='üì¶ '+parts;$('hudScore').textContent='üéØ '+score.toLocaleString();}

// === DRAWING ===
function drawBg(){
    const loc=getLocation();
    const nightFactor=Math.sin(dayNightCycle+frame*0.0001)*0.3+0.5;
    const g=ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,loc.bg.sky1);g.addColorStop(0.6,loc.bg.sky2);g.addColorStop(1,loc.bg.ground);
    ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
    
    // Stars (night)
    if(nightFactor>0.5){
        ctx.fillStyle=`rgba(255,255,255,${(nightFactor-0.5)*0.8})`;
        for(let i=0;i<40;i++){const x=(i*67+frame*0.01)%W,y=(i*43)%(H*0.5);ctx.beginPath();ctx.arc(x,y,1,0,Math.PI*2);ctx.fill();}
    }
    
    // Moon/Sun
    ctx.fillStyle=nightFactor>0.5?'#f5f5dc':'#ffdd00';
    ctx.beginPath();ctx.arc(W-60,70,20,0,Math.PI*2);ctx.fill();
    
    // Clouds
    if(currentWeather.effect==='clouds'||currentWeather.effect==='rain'||currentWeather.effect==='storm'){
        ctx.fillStyle='rgba(200,200,200,0.3)';
        for(let i=0;i<5;i++){const x=(i*150+frame*0.3)%W;ctx.beginPath();ctx.arc(x,80+i*20,40,0,Math.PI*2);ctx.arc(x+30,75+i*20,35,0,Math.PI*2);ctx.arc(x+60,80+i*20,40,0,Math.PI*2);ctx.fill();}
    }
    
    // Rain
    if(currentWeather.effect==='rain'||currentWeather.effect==='storm'){
        ctx.strokeStyle='rgba(150,200,255,0.4)';ctx.lineWidth=1;
        for(let i=0;i<50;i++){const x=(i*23+frame*3)%W;const y=(i*37+frame*8)%H;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x-5,y+15);ctx.stroke();}
    }
    
    // Fog
    if(currentWeather.effect==='fog'){
        ctx.fillStyle='rgba(200,200,200,0.4)';ctx.fillRect(0,0,W,H);
    }
    
    // Ground
    ctx.fillStyle=loc.bg.ground;ctx.fillRect(0,H-60,W,60);
    ctx.fillStyle='rgba(255,255,255,0.2)';
    const off=(frame*4*speed)%80;for(let x=-off;x<W+80;x+=80)ctx.fillRect(x,H-35,40,3);
}

function drawContrails(){contrails.forEach(c=>{ctx.fillStyle=`rgba(255,255,255,${c.alpha})`;ctx.beginPath();ctx.arc(c.x,c.y,c.size,0,Math.PI*2);ctx.fill();});}

function drawPlayer(){
    ctx.save();ctx.translate(player.x,player.y);ctx.rotate(player.rot);ctx.scale(0.6,0.6);
    
    // Shield glow
    if(shieldOn){ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,60,0,Math.PI*2);ctx.stroke();}
    
    // Plane body
    const skin=SKINS.find(s=>s.id===stats.skin)||SKINS[0];
    const c1=skin.colors[0]==='rainbow'?`hsl(${frame%360},70%,60%)`:skin.colors[0];
    const c2=skin.colors[0]==='rainbow'?`hsl(${(frame+180)%360},70%,40%)`:skin.colors[1];
    
    // Fuselage
    ctx.fillStyle=c1;
    ctx.beginPath();ctx.ellipse(0,0,45,12,0,0,Math.PI*2);ctx.fill();
    // Stripe
    ctx.fillStyle=c2;ctx.fillRect(-40,-2,80,4);
    // Cockpit
    ctx.fillStyle='#3a6a9e';ctx.beginPath();ctx.ellipse(30,0,12,8,0,0,Math.PI*2);ctx.fill();
    // Wing
    ctx.fillStyle=c1;ctx.fillRect(-10,-40,15,80);
    // Tail
    ctx.fillStyle=c2;ctx.beginPath();ctx.moveTo(-35,0);ctx.lineTo(-50,-25);ctx.lineTo(-40,-25);ctx.lineTo(-30,0);ctx.fill();
    // Propeller
    ctx.fillStyle='#333';ctx.save();ctx.translate(45,0);ctx.rotate(frame*0.8);ctx.fillRect(-2,-18,4,36);ctx.restore();
    
    ctx.restore();
}

function drawObs(){
    obstacles.forEach(o=>{
        ctx.fillStyle='#000080';
        ctx.fillRect(o.x,0,CFG.OBS.W,o.top);
        ctx.fillRect(o.x,o.bot,CFG.OBS.W,H-o.bot);
        ctx.fillStyle='#0000a0';
        ctx.fillRect(o.x-4,o.top-18,CFG.OBS.W+8,18);
        ctx.fillRect(o.x-4,o.bot,CFG.OBS.W+8,18);
        if(Math.floor(frame/20)%2===0){ctx.fillStyle='#ff0000';ctx.beginPath();ctx.arc(o.x+CFG.OBS.W/2,o.top-9,3,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(o.x+CFG.OBS.W/2,o.bot+9,3,0,Math.PI*2);ctx.fill();}
    });
}

function drawParts(){
    items.forEach(p=>{if(p.col)return;
        const colors={common:'#888',uncommon:'#28a745',rare:'#17a2b8',epic:'#9b59b6',legendary:'#ffd700'};
        ctx.fillStyle=colors[p.rarity];ctx.beginPath();ctx.arc(p.x,p.y,18,0,Math.PI*2);ctx.fill();
        ctx.font='16px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(p.icon,p.x,p.y);
    });
}

function drawBirds(){
    birds.forEach(b=>{
        ctx.fillStyle='#333';
        ctx.save();ctx.translate(b.x,b.y);
        const wingY=Math.sin(b.frame*0.3)*8;
        ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-10,-wingY);ctx.lineTo(-15,0);ctx.lineTo(-10,wingY);ctx.closePath();ctx.fill();
        ctx.beginPath();ctx.arc(5,0,5,0,Math.PI*2);ctx.fill();
        ctx.restore();
    });
}

function drawFuel(){fuelCans.forEach(f=>{ctx.font='24px Arial';ctx.textAlign='center';ctx.fillText('‚õΩ',f.x,f.y);});}

function drawBoss(){if(!boss)return;ctx.font='60px Arial';ctx.textAlign='center';ctx.fillText(boss.icon,boss.x,boss.y);}

function drawProjectiles(){ctx.fillStyle='#ff4444';projectiles.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,10,0,Math.PI*2);ctx.fill();});}

function drawParticles(){particles.forEach(p=>{ctx.globalAlpha=p.life;ctx.fillStyle=p.color||'#fff';ctx.beginPath();ctx.arc(p.x,p.y,p.size||3,0,Math.PI*2);ctx.fill();});ctx.globalAlpha=1;}

// === GAME LOOP ===
function loop(ts){
    deltaTime=lastTime?Math.min(ts-lastTime,32):16;lastTime=ts;
    drawBg();
    if(state==='playing'||state==='over'){
        drawContrails();drawObs();drawParts();drawFuel();drawBirds();
        if(bossActive)drawBoss();
        drawProjectiles();drawPlayer();drawParticles();
    }
    if(state==='playing'){
        updatePlayer();updateObs();updateParts();updateBirds();updateFuel();
        updateCombo();updateContrails();updateParticles();updateDifficulty();
        if(bossActive){updateBoss();updateProjectiles();}
        if(gameMode==='normal'&&score>=CFG.BOSS_SPAWN&&!bossActive&&!boss)spawnBoss();
        updateHUD();
    }
    frame++;requestAnimationFrame(loop);
}

// === EVENTS ===
canvas.addEventListener('click',jump);
canvas.addEventListener('touchstart',e=>{e.preventDefault();jump();});
document.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();jump();}});

$('btnPlay').onclick=()=>start('normal');
$('btnBoss').onclick=()=>start('boss');
$('btnWheel').onclick=()=>{renderWheel();show('wheelScreen');};
$('btnShop').onclick=()=>{renderShop();show('shopScreen');};
$('btnAchieve').onclick=()=>{renderAchievements();show('achieveScreen');};
$('btnLB').onclick=()=>{renderLeaderboard();show('lbScreen');};
document.querySelectorAll('.shop-tab').forEach(t=>t.onclick=()=>{shopTab=t.dataset.tab;renderShop();});
$('shopBack').onclick=$('achieveBack').onclick=$('wheelBack').onclick=$('lbBack').onclick=()=>{show('mainMenu');updateMenu();};
$('btnSpin').onclick=spinWheel;
$('btnRetry').onclick=()=>start(gameMode);
$('btnHome').onclick=()=>{show('mainMenu');updateMenu();};

// === INIT ===
updateMenu();loop(0);
</script>
</body>
</html>
